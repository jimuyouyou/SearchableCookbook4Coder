<!DOCTYPE html>
<html class="no-js" lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <!-- Set the viewport width to device width for mobile -->
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Discover Meteor – Building Real-Time JavaScript Web Apps – Sacha Greif &amp; Tom Coleman" name="Title">
    <meta content="Tom Coleman &amp; Sacha Greif" name="Author">
    <meta content="Learn to build Meteor apps from scratch." name="Description">
    <title>Discover Meteor – Building Real-Time JavaScript Web Apps – Sacha Greif &amp; Tom Coleman</title>
    <!-- Included CSS Files -->
    <link href="DiscoverMeteor_files/ebook.css" rel="stylesheet">
    <link href="http://zh.discovermeteor.com/images/favicon.ico" rel="shortcut icon">
    <script src='../../lib/jquery-1.8.0.min.js'></script>
    <script src='../../lib/h_search.js'></script>
    <script src='../../lib/pCfg.js'></script>
    <script src='../../lib/a_search.js'></script>
    <script>
    var cfg = {
      labels:['meteor','template', 'session', 'collection', 'user'],
      hlinks: 'h2,h3',
    };
    </script>
  </head>
  <body>
    <div class="main">
      <div class="row">
        <section class="cover-page">
          <img src="DiscoverMeteor_files/discovermeteor.jpg">
        </section>
        <section class="inner-cover">
          <div class="title">
            <h1>
              <span>Discover</span>
              <strong>Meteor</strong>
            </h1>
            <h2>Building Real-Time JavaScript Web Apps</h2>
            <p class="version">Version 1.8 (updated 2015年2月10日)</p>
            <p></p>
          </div>
          <footer>
            <div class="credits">
              <h3>Tom Coleman &amp; Sacha Greif</h3>
              <p>
                Cover photo credit:
                <a href="http://www.flickr.com/photos/dobieks/4889222256/in/photostream/">Perseid Hunting</a>
                by Darren Blackburn, licensed under a Creative Commons Attribution 2.0 Generic license.
              </p>
            </div>
            <div class="site">
              <a href="http://discovermeteor.com/">www.discovermeteor.com</a>
            </div>
          </footer>
        </section>
        
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="introduction">简介</h2>
            <span class="chapter-number">1</span>
          </div>
          <p>先来活动一下大脑。假设你坐在电脑面前，在两个窗口中打开同一个文件夹。</p>
          
          <p>在其中一个窗口中删除一个文件，另一个窗口中的这个文件会消失吗？</p>
          
          <p>不用实际操作你也知道肯定会消失的。在本地文件系统中的操作，不用刷新或者回调，变动就能应用到所有地方。</p>
          
          <p>我们再来看一下相同的事情在网页中会有什么结果。例如，你在两个浏览器窗口中打开同一个 WordPress 后台页面，在其中一个窗口中新建了一篇文章。和桌面系统不同的是，不管等待多长时间，另一个窗口都不会发生变化，除非你手动刷新网页。</p>
          
          <p>过去这些年，我们已经习惯了，人和网站之间的通信是离散的。</p>
          
          <p>但是，作为新一代框架和技术之一的 Meteor，尝试挑战这一现状，让网页能够实时和响应。</p>
          
          <h3>Meteor 是什么？</h3>
          
          <p>Meteor 是一个构建在 Node.js 之上的平台，用来开发实时网页程序。Meteor 位于程序数据库和用户界面之间，保持二者之间的数据同步更新。</p>
          
          <p>因为 Meteor 是基于 Node.js 开发的，所以在客户端和服务器端都使用 JavaScript 作为开发语言。而且，Meteor 程序的代码还能在前后两端共用。</p>
          
          <p>Meteor 这个平台很强大，网页程序开发过程中的很多复杂、容易出错的功能都能抽象出来，实现起来很简单。</p>
          
          <h3>为什么使用 Meteor？</h3>
          
          <p>那么，你为什么要花时间学习 Meteor，而不去学其他框架呢？拨开 Meteor 的各种功能，我们认为原因只有一个：因为 Meteor 易于学习。</p>
          
          <p>而且，和其他框架不同，使用 Meteor，几小时之内就能开发出一个正常运行的实时网页程序。如果之前做过前端开发，对 JavaScript 已经有所了解，甚至都不用再学习一门新的编程语言。</p>
          
          <p>Meteor 可能就是你要找的理想框架，当然，也可能不是。既然只要几晚或一个周末就能上手，为什么不试试呢？</p>
          
          <h3>为什么选择这本书？</h3>
          
          <p>在过去的几年中，我们一直在开发很多个 Meteor 项目，范围从网站到移动应用，从商业项目到开源项目。</p>
          
          <p>我们学到了很多，但总是不那么容易找到问题的答案。我们不得不从不同来源讲东西拼凑在一起，并且在许多情况下，我们甚至创造了
我们自己的解决方案。所以通过这本书，我们想分享所有这些经验教训，并创建了一个简单的一步一步的指导，来引导你从零开始构建一个完整的 Meteor 
应用。 </p>
          
          <p>我们即将构建的应用是一个简化版的社交新闻网站，类似 <a href="http://news.ycombinator.com/">Hacker News</a> 或 <a href="http://reddit.com/">Reddit</a>，我们称之为 Microscope（借鉴 Meteor 开源应用 <a href="http://telesc.pe/">Telescope</a>），在开发的过程中，我们会解决 构建 Meteor 应用所会遇到的各种要素，例如用户账户、Meteor Collection、路由等等。</p>
          
          <h3>这本书为谁编写？</h3>
          
          <p>我们在写这本书时，目标之一就是要让内容通俗易懂。所以，即使你没有任何 Meteor、Node.js、MVC 框架或服务器端编程经验，都能够读完这本书。</p>
          
          <p>但另一方面，我们也假设你熟悉基本的 JavaScript 语法和概念。但是如果你曾经玩过一些 jQuery 代码或接触过浏览器开发者控制台，你应该是没有问题的。</p>
          
          <p>如果你还不太熟悉 JavaScript，我们建议你在开始阅读本书之前，先阅读一下我们的 <a href="https://www.discovermeteor.com/blog/javascript-for-meteor/">JavaScript primer for Meteor</a>（英文）。</p>
          
          <h3>关于作者</h3>
          
          <p>如果你想知道我们是谁，为什么要相信我们，这里是两位作者的一些背景介绍。</p>
          
          <p><img class="portrait" src="DiscoverMeteor_files/tom-photo.jpg">
          <strong>Tom Coleman</strong> 是 <a href="http://percolatestudio.com/">Percolate 工作室</a>的一员。Percolate 工作室是一个程序开发商，致力于高品质的产品和用户体验。他也是 <a href="http://atmosphere.meteor.com/">Atmosphere</a> 包仓库的维护人之一，同时也参与开发了多个 Meteor 开源项目（例如 <a href="https://github.com/EventedMind/iron-router">Iron Router</a>）。</p>
          
          <p><img class="portrait" src="DiscoverMeteor_files/sacha-photo.jpg">
          <strong>Sacha Greif</strong> 是一名产品设计师和网页设计师，为创业项目工作，例如 <a href="http://www.hipmunk.com/">Hipmunk</a> 和 <a href="http://rubymotion.com/">RubyMotion</a>。他开发了 <a href="http://telesc.pe/">Telescope</a> 和 <a href="http://sidebar.io/">Sidebar</a>，还是 <a href="http://folyo.me/">Folyo</a> 的创始人。</p>
          
          <h3>章节和附录</h3>
          
          <p>我们希望这本书对 Meteor 初学者和有经验的程序员都有所帮助，因此把内容分成了两类：常规的章节（1-14 章）和附录（带 .5 的序号）。</p>
          
          <p>常规的章节会讲解如何开发程序，尽量保证你能跟着我们的步伐实际操作，只关注开发过程中最重要的步骤，不会太深入细节。</p>
          
          <p>而附录则会深入 Meteor 错综复杂的细节，帮助你更好的理解背后到底发生了什么。</p>
          
          <p>如果你是初学者，第一次阅读完全可以跳过附录，熟悉 Meteor 之后再回过头来阅读。</p>
          
          <h3>代码提交和线上演示</h3>
          
          <p>阅读编程相关的书籍时最怕遇到这种事情，虽然一直跟着书中的步骤，但突然发现代码和示例不一样了，而且程序也不能正常运行。</p>
          
          <p>为了避免这种情况发生，我们特意<a href="https://github.com/DiscoverMeteor/Microscope">在 GitHub 上为 Microscope 建了仓库</a>。改动一些代码后，会给出指向 git 提交的链接，而且还会链接到该提交对应的线上演示，方便和你自己本地的版本对比。下面一个示例：</p>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 11-2</h4><p>在头部显示提醒</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter11-2" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter11-2.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>我们提供的代码提交链接，并不是为了让你使用 <code>git checkout</code> 从一个提交跳到另一个提交。自己动手输入程序的代码，学习效果才能更好。</p>
          
          <h3>一些其他资源</h3>
          
          <p>如果想更深入地学习 Meteor 的各项功能，最好的资料就是<a href="http://docs.meteor.com/">官方文档</a>。</p>
          
          <p>遇到问题我们建议到 <a href="http://stackoverflow.com/questions/tagged/meteor">Stack Overflow</a> 网站上寻找帮助。如果想获得实时帮助，可以加入 <a href="https://webchat.freenode.net/">IRC</a> 的 #meteor 频道。</p>
          
          <div class="note"><h3>需要了解 Git 吗？</h3>
          
          <p>阅读本书虽然不完全要求你熟悉 Git 版本控制，但我们强烈推荐你去学。</p>
          
          <p>如果想快速上手，我们推荐阅读 Nick Farina 撰写的文章《<a href="http://nfarina.com/post/9868516270/git-is-simpler">Git Is Simpler Than You Think</a>》。</p>
          
          <p>对 Git 初学者，我们将以使用 <a href="http://mac.github.com/">GitHub for Mac</a> 程序，不用命令行就可以克隆和管理仓库。</p>
          </div>
          
          <h3>联系方式</h3>
          
          <ul>
          <li>如果想和我们联系，可以发送邮件到 <a href="mailto:hello@discovermeteor.com">hello@discovermeteor.com</a>。</li>
          <li>如果发现本书中有错别字或不当之处，请到 <a href="https://github.com/DiscoverMeteor/book/issues">GitHub 上的仓库</a>中提交。</li>
          <li>如果发现 Microscope 的代码有问题，请到 <a href="https://github.com/DiscoverMeteor/Microscope/issues">Microscope 的仓库</a>中提交。</li>
          <li>如果还有其他问题，可以直接在网页的侧栏中留言。</li>
          </ul>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="getting-started">开始</h2>
            <span class="chapter-number">2</span>
          </div>
          <p>第一印象十分重要，安装 Meteor 并不会遇到什么困难。大多数情况下，在五分钟内便可以完成。</p>
          
          <p>首先，我们打开终端窗口，输入以下命令来安装 Meteor：</p>
          <pre class="highlight shell"><span class="gp">$ </span>curl https://install.meteor.com | sh</pre>
          <p>以上命令会在系统中安装 <code>meteor</code> 可执行文件，然后就可以使用 Meteor 了。</p>
          
          <div class="note"><h3>选择<strong>不安装</strong> Meteor</h3>
          
          <p>如果你无法或者不想在本地安装 Meteor ，我们推荐你使用 <a href="http://nitrous.io/">Nitrous.io</a>。</p>
          
          <p>使用 Nitrous.io 可以让你在览器中直接编辑代码并运行程序。我们撰写了<a href="https://www.discovermeteor.com/blog/meteor-nitrous/">一篇简短的指南</a>，介绍如何使用 Nitrous.io。</p>
          
          <p>你可以一直阅读那篇指南直到“Installing Meteor”部分，然后再回到本章，从“创建简单的应用”一节开始阅读。</p>
          </div>
          
          <h3>创建简单的应用</h3>
          
          <p>安装好 Meteor 之后，我们来创建一个应用。创建应用要使用 Meteor 的命令行工具 <code>meteor</code>：</p>
          <pre class="highlight shell"><span class="gp">$ </span>meteor create microscope</pre>
          <p>上述命令会下载 Meteor，然后新建一个基本可用的 Meteor 项目。命令执行完成后，会看到新建了一个文件夹，名为 <code>microscope/</code>，包含以下文件：</p>
          <pre class="highlight shell">.meteor
microscope.css
microscope.html
microscope.js</pre>
          <p>Meteor 生成的应用只是一个简单的骨架，演示一些简单的模式。</p>
          
          <p>虽然这个应用没什么功能，但也能运行。要运行应用，请切换到终端，输入下面的命令：</p>
          <pre class="highlight shell"><span class="gp">$ </span><span class="nb">cd </span>microscope
<span class="gp">$ </span>meteor</pre>
          <p>现在打开浏览器，访问 <code>http://localhost:3000</code>（或者等效的 <code>http://0.0.0.0:3000</code>），应该能看到下面的网页：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/2-1.png" alt="Meteor 的 Hello World 网页"><figcaption>Meteor 的 Hello World 网页</figcaption></figure>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 2-1</h4><p>创建 Microscope 项目的基础文件</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter2-1" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter2-1.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>恭喜！你的第一个 Meteor 应用顺利运行了。顺便说一下，如果想停止运行程序，只要切换到对应的终端窗口按 <code>ctrl+c</code> 键即可。</p>
          
          <p>如果你使用 Git，正是时候用 <code>git init</code> 来初始化你的项目仓库。</p>
          
          <div class="note"><h3>再见 Meteorite</h3>
          
          <p>曾经有段时间，Meteor 依赖于外部代码包管理器 Meteorite。自从 Meteor 0.9.0 版本以后，就不再需要 Meteorite 了，因为它的功能已经融入 Meteor 之中。</p>
          
          <p>所以，如果你在这本书或在浏览 Meteor 相关的资料时，遇到 Meteorite 的 <code>mrt</code> 命令行工具，你可以放心地用 <code>meteor</code> 来替换它。</p>
          </div>
          
          <h3>添加代码包</h3>
          
          <p>下面我们使用 Meteor 的 package 系统在项目中引入 <a href="http://getbootstrap.com/">Bootstrap</a> 框架。</p>
          
          <p>这与通常手动添加 Bootstrap 的 CSS 和 Javascript 文件的方法是没有区别的，只不过我们依赖代码包维护者来为我们更新这些文件。</p>
          
          <p>既然我们说到此，我们也来添加 <a href="http://underscorejs.org/">Underscore</a> 代码包。 Underscore 是一个 JavaScript 工具库，对于操纵 JavaScript 数据结构非常有用。</p>
          
          <p>截至写这本书时，<code>underscore</code> 代码包依然算作 Meteor “官方”的代码包，所以这个包没有作者：</p>
          <pre class="highlight shell">meteor add twbs:bootstrap
meteor add underscore</pre>
          <p>注意的是现在我们添加了 Bootstrap <strong>3</strong>。而这本书中的一些截图是老版本的 Microscope 使用 Bootstrap <strong>2</strong> 时截取的，所有它们看起来会有稍微不同。</p>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 2-2</h4><p>添加 bootstrap 和 underscore 代码包</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter2-2" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter2-2.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>一旦你添加了 Bootstrap 代码包，你应会注意到我们应用的变化：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/2-1b.png" alt="添加了 Bootstrap."><figcaption>添加了 Bootstrap.</figcaption></figure>
          
          <p>与“传统”方式添加外部资源不同，我们还没有链接任何 CSS 或 JavaScript 文件，因为 Meteor 已经帮我们搞定了！这就是 Meteor 代码包的众多优势之一。</p>
          
          <div class="note"><h3>关于代码包</h3>
          
          <p>Meteor 中的代码包有点特殊，分为五种：</p>
          
          <ul>
          <li>Meteor 核心代码本身分成多个<strong>核心代码包</strong>（core package），每个 Meteor 应用中都包含，你基本上不需要花费精力来维护它们</li>
          <li>常规 Meteor 代码包称为“<strong>isopack</strong>”，或同构代码包（isomorphic package，意味着它们既能在客户端也能在服务器端工作）。<strong>第一类代码包</strong>例如 <code>accounts-ui</code> 或 <code>appcache</code> 由 Meteor 核心团队维护，与 Meteor <a href="http://docs.meteor.com/#packages">捆绑</a>在一起。</li>
          <li><strong>第三方代码包</strong>就是其他用户开发的 isopack 上传到 Meteor 的代码包服务器上。你可以访问 <a href="http://atmosphere.meteor.com/">Atmosphere</a> 或 <code>meteor search</code> 命令来浏览这些代码包。</li>
          <li><strong>本地代码包</strong>（local package）是自己开发的代码包，保存在 <code>/packages</code> 文件夹中。</li>
          <li><strong>NPM 代码包</strong>（NPM package）是 Node.js 的代码包，虽不能直接用于 Meteor，但可以在上述几种代码包中使用</li>
          </ul>
          </div>
          
          <h3>Meteor 应用的文件结构</h3>
          
          <p>开始编写代码之前，我们必须要正确的设置项目。为了保证项目整洁，请打开 <code>microscope</code> 文件夹，删除 <code>microscope.html</code>、<code>microscope.js</code> 和 <code>microscope.css</code>。</p>
          
          <p>请在 <code>microscope</code> 文件夹中新建四个子文件夹：<code>/client</code>，<code>/server</code>，<code>/public</code> 和 <code>/lib</code>。然后在 <code>/client</code> 文件夹中新建两个空文件：<code>main.html</code> 和 <code>main.js</code>。如果程序无法运行了先别担心，从下一章开始我们会编写代码。</p>
          
          <p>值得一提的是，上述文件夹中有一些拥有特别的作用。关于文件， Meteor 有以下几条规则：</p>
          
          <ul>
          <li>在 <code>/server</code> 文件夹中的代码只会在服务器端运行。</li>
          <li>在 <code>/client</code> 文件夹中的代码只会在客户端运行。</li>
          <li>其它代码则将同时运行于服务器端和客户端上。</li>
          <li>请将所有的静态文件（字体，图片等）放置在 <code>/public</code> 文件夹中。</li>
          </ul>
          
          <p>知道 Meteor 以什么顺序加载文件也很有用：</p>
          
          <ul>
          <li>在 <code>/lib</code> 文件夹中的文件将被优先载入。</li>
          <li>所有以 <code>main.*</code> 命名的文件将在其他文件载入后载入。</li>
          <li>其他文件以文件名的字母顺序载入。</li>
          </ul>
          
          <p>需要注意的是，即便 Meteor 包含上述规则，这并不意味着它强制你为你的 Meteor 应用采用任何预设的文件结构。上述结构只是我们的建议，并不是一成不变的。</p>
          
          <p>对此如果你想了解更多，我们强烈建议你参阅 <a href="http://docs.meteor.com/#structuringyourapp">Meteor 官方文档</a>。</p>
          
          <div class="note"><h3>Meteor 采用 MVC 架构吗？</h3>
          
          <p>如果你之前有过在其它诸如 Ruby on Rails 框架下开发的经历，此时你心中可能会有这样的疑问， Meteor 采用 MVC（Model View Controller）架构吗？</p>
          
          <p>简短的回答是，不。与 Rails 不同，Meteor 并不为你的应用强加任何预设的架构。因此本书将直接给出我们认为最合理的代码，而不对任何现有架构作过多考虑。</p>
          </div>
          
          <h3>不需要 public 文件夹？</h3>
          
          <p>好吧，我们承认在之前小小的忽悠了大家一下。其实我们并不需要为我们的应用建立一个 <code>public/</code> 文件夹，因为 Microscope 并不需要使用任何的静态文件。但是值得注意的是，大多数 Meteor 应用都会或多或少使用一些图片，因此我们觉得 <code>public/</code> 文件夹还是值得一谈的。</p>
          
          <p>另外，你可能注意到了一个隐藏的 <code>.meteor</code> 文件夹。这是 Meteor 存储它内部代码的地方，尝试更改里面的内容并不是什么好主意。事实上，你根本不需要关心其中的内容。有两个例外是 <code>.meteor/packages</code> 文件和 <code>.meteor/release</code> 文件。它们分别列出了你安装的所有智能代码包和你使用的 Meteor 版本。当你为你的应用添加代码包或更改 Meteor 版本时，查看这两个文件的变更可能会为你带来一些帮助。</p>
          
          <div class="note"><h3>下划线命名法 vs 驼峰命名法</h3>
          
          <p>对于历史悠久的下划线命名法（<code>my_variable</code>）和驼峰命名法（<code>myVariable</code>）我们认为选择哪种并不重要，只要你坚持在项目中贯彻它。</p>
          
          <p>在本书中，我们将采用驼峰命名法，因为它是 JavaScript 中的惯例（毕竟它叫 JavaScript 而不是 java_script 呀！）。</p>
          
          <p>对此唯一的例外是，对文件的命名，我们将采用下划线命名法（<code>my_file.js</code>）。对于 CSS 类，我们将使用连字号（<code>.my-class</code>）。这样做的原因是在文件系统中，下划线命名法最常见，而 CSS 语法本身就使用连字号作为连接（比如 <code>font-family</code>，<code>text-align</code>等）。</p>
          </div>
          
          <h3>搞定 CSS</h3>
          
          <p>本书并不侧重于 CSS 。所以为了避免在 CSS 细节上花费过多时间，我们决定在本书一开始就为大家提供完整的 CSS 文件。因此你不必再担心这个问题。</p>
          
          <p>CSS 文件将被 Meteor 自动加载并简化。因此，不同于其它的静态文件都被放置于 <code>/public</code> 文件夹，请将 CSS 文件放入 <code>/client</code> 文件夹。请创建一个 <code>client/stylesheets/</code> 文件夹并将以下 <code>style.css</code> 文件放置入内。</p>
          <pre class="highlight css"><span class="nc">.grid-block</span><span class="o">,</span> <span class="nc">.main</span><span class="o">,</span> <span class="nc">.post</span><span class="o">,</span> <span class="nc">.comments</span> <span class="nt">li</span><span class="o">,</span> <span class="nc">.comment-form</span> <span class="p">{</span>
  <span class="nl">background</span><span class="p">:</span> <span class="m">#fff</span><span class="p">;</span>
  <span class="nl">border-radius</span><span class="p">:</span> <span class="m">3px</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span>
  <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span>
  <span class="nl">-webkit-box-shadow</span><span class="p">:</span> <span class="m">0</span> <span class="m">1px</span> <span class="m">1px</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0.15</span><span class="p">);</span>
  <span class="nl">-moz-box-shadow</span><span class="p">:</span> <span class="m">0</span> <span class="m">1px</span> <span class="m">1px</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0.15</span><span class="p">);</span>
  <span class="nl">box-shadow</span><span class="p">:</span> <span class="m">0</span> <span class="m">1px</span> <span class="m">1px</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0.15</span><span class="p">);</span> <span class="p">}</span>

<span class="nt">body</span> <span class="p">{</span>
  <span class="nl">background</span><span class="p">:</span> <span class="m">#eee</span><span class="p">;</span>
  <span class="nl">color</span><span class="p">:</span> <span class="m">#666666</span><span class="p">;</span> <span class="p">}</span>

<span class="nf">#main</span> <span class="p">{</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">relative</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.page</span> <span class="p">{</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span>
  <span class="nl">top</span><span class="p">:</span> <span class="m">0px</span><span class="p">;</span>
  <span class="nl">width</span><span class="p">:</span> <span class="m">100</span><span class="err">%</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.navbar</span> <span class="p">{</span>
  <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span> <span class="p">}</span>
  <span class="c">/* line 32, ../sass/style.scss */</span>
  <span class="nc">.navbar</span> <span class="nc">.navbar-inner</span> <span class="p">{</span>
    <span class="nl">border-radius</span><span class="p">:</span> <span class="m">0px</span> <span class="m">0px</span> <span class="m">3px</span> <span class="m">3px</span><span class="p">;</span> <span class="p">}</span>

<span class="nf">#spinner</span> <span class="p">{</span>
  <span class="nl">height</span><span class="p">:</span> <span class="m">300px</span><span class="p">;</span> <span class="p">}</span>

<span class="nc">.post</span> <span class="p">{</span>
  <span class="c">/* For modern browsers */</span>
  <span class="c">/* For IE 6/7 (trigger hasLayout) */</span>
  <span class="err">*</span><span class="py">zoom</span><span class="p">:</span> <span class="m">1</span><span class="p">;</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">relative</span><span class="p">;</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">1</span><span class="p">;</span> <span class="p">}</span>
  <span class="nc">.post</span><span class="nd">:before</span><span class="o">,</span> <span class="nc">.post</span><span class="nd">:after</span> <span class="p">{</span>
    <span class="nl">content</span><span class="p">:</span> <span class="s1">""</span><span class="p">;</span>
    <span class="nl">display</span><span class="p">:</span> <span class="n">table</span><span class="p">;</span> <span class="p">}</span>
  <span class="nc">.post</span><span class="nd">:after</span> <span class="p">{</span>
    <span class="nl">clear</span><span class="p">:</span> <span class="nb">both</span><span class="p">;</span> <span class="p">}</span>
  <span class="nc">.post.invisible</span> <span class="p">{</span>
    <span class="nl">opacity</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="p">}</span>
  <span class="nc">.post.instant</span> <span class="p">{</span>
    <span class="nl">-webkit-transition</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
    <span class="nl">-moz-transition</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
    <span class="nl">-o-transition</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
    <span class="nl">transition</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span> <span class="p">}</span>
  <span class="nc">.post.animate</span><span class="p">{</span>
    <span class="nl">-webkit-transition</span><span class="p">:</span> <span class="n">all</span> <span class="n">300ms</span> <span class="n">0ms</span><span class="p">;</span>
    <span class="nl">-moz-transition</span><span class="p">:</span> <span class="n">all</span> <span class="n">300ms</span> <span class="n">0ms</span> <span class="n">ease-in</span><span class="p">;</span>
    <span class="nl">-o-transition</span><span class="p">:</span> <span class="n">all</span> <span class="n">300ms</span> <span class="n">0ms</span> <span class="n">ease-in</span><span class="p">;</span>
    <span class="nl">transition</span><span class="p">:</span> <span class="n">all</span> <span class="n">300ms</span> <span class="n">0ms</span> <span class="n">ease-in</span><span class="p">;</span> <span class="p">}</span>
  <span class="nc">.post</span> <span class="nc">.upvote</span> <span class="p">{</span>
    <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
    <span class="nl">margin</span><span class="p">:</span> <span class="m">7px</span> <span class="m">12px</span> <span class="m">0</span> <span class="m">0</span><span class="p">;</span>
    <span class="nl">float</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span> <span class="p">}</span>
  <span class="nc">.post</span> <span class="nc">.post-content</span> <span class="p">{</span>
    <span class="nl">float</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span> <span class="p">}</span>
    <span class="nc">.post</span> <span class="nc">.post-content</span> <span class="nt">h3</span> <span class="p">{</span>
      <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
      <span class="nl">line-height</span><span class="p">:</span> <span class="m">1.4</span><span class="p">;</span>
      <span class="nl">font-size</span><span class="p">:</span> <span class="m">18px</span><span class="p">;</span> <span class="p">}</span>
      <span class="nc">.post</span> <span class="nc">.post-content</span> <span class="nt">h3</span> <span class="nt">a</span> <span class="p">{</span>
        <span class="nl">display</span><span class="p">:</span> <span class="n">inline-block</span><span class="p">;</span>
        <span class="nl">margin-right</span><span class="p">:</span> <span class="m">5px</span><span class="p">;</span> <span class="p">}</span>
      <span class="nc">.post</span> <span class="nc">.post-content</span> <span class="nt">h3</span> <span class="nt">span</span> <span class="p">{</span>
        <span class="nl">font-weight</span><span class="p">:</span> <span class="nb">normal</span><span class="p">;</span>
        <span class="nl">font-size</span><span class="p">:</span> <span class="m">14px</span><span class="p">;</span>
        <span class="nl">display</span><span class="p">:</span> <span class="n">inline-block</span><span class="p">;</span>
        <span class="nl">color</span><span class="p">:</span> <span class="m">#aaaaaa</span><span class="p">;</span> <span class="p">}</span>
    <span class="nc">.post</span> <span class="nc">.post-content</span> <span class="nt">p</span> <span class="p">{</span>
      <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="p">}</span>
  <span class="nc">.post</span> <span class="nc">.discuss</span> <span class="p">{</span>
    <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
    <span class="nl">float</span><span class="p">:</span> <span class="nb">right</span><span class="p">;</span>
    <span class="nl">margin-top</span><span class="p">:</span> <span class="m">7px</span><span class="p">;</span> <span class="p">}</span>

<span class="nc">.comments</span> <span class="p">{</span>
  <span class="nl">list-style-type</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
  <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="p">}</span>
  <span class="nc">.comments</span> <span class="nt">li</span> <span class="nt">h4</span> <span class="p">{</span>
    <span class="nl">font-size</span><span class="p">:</span> <span class="m">16px</span><span class="p">;</span>
    <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="p">}</span>
    <span class="nc">.comments</span> <span class="nt">li</span> <span class="nt">h4</span> <span class="nc">.date</span> <span class="p">{</span>
      <span class="nl">font-size</span><span class="p">:</span> <span class="m">12px</span><span class="p">;</span>
      <span class="nl">font-weight</span><span class="p">:</span> <span class="nb">normal</span><span class="p">;</span> <span class="p">}</span>
    <span class="nc">.comments</span> <span class="nt">li</span> <span class="nt">h4</span> <span class="nt">a</span> <span class="p">{</span>
      <span class="nl">font-size</span><span class="p">:</span> <span class="m">12px</span><span class="p">;</span> <span class="p">}</span>
  <span class="nc">.comments</span> <span class="nt">li</span> <span class="nt">p</span><span class="nd">:last-child</span> <span class="p">{</span>
    <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="p">}</span>

<span class="nc">.dropdown-menu</span> <span class="nt">span</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">3px</span> <span class="m">20px</span><span class="p">;</span>
  <span class="nl">clear</span><span class="p">:</span> <span class="nb">both</span><span class="p">;</span>
  <span class="nl">line-height</span><span class="p">:</span> <span class="m">20px</span><span class="p">;</span>
  <span class="nl">color</span><span class="p">:</span> <span class="m">#bbb</span><span class="p">;</span>
  <span class="nl">white-space</span><span class="p">:</span> <span class="nb">nowrap</span><span class="p">;</span> <span class="p">}</span>

<span class="nc">.load-more</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
  <span class="nl">border-radius</span><span class="p">:</span> <span class="m">3px</span><span class="p">;</span>
  <span class="nl">background</span><span class="p">:</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0.05</span><span class="p">);</span>
  <span class="nl">text-align</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
  <span class="nl">height</span><span class="p">:</span> <span class="m">60px</span><span class="p">;</span>
  <span class="nl">line-height</span><span class="p">:</span> <span class="m">60px</span><span class="p">;</span>
  <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span> <span class="p">}</span>
  <span class="nc">.load-more</span><span class="nd">:hover</span> <span class="p">{</span>
    <span class="nl">text-decoration</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
    <span class="nl">background</span><span class="p">:</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0.1</span><span class="p">);</span> <span class="p">}</span>

<span class="nc">.posts</span> <span class="nc">.spinner-container</span><span class="p">{</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">relative</span><span class="p">;</span>
  <span class="nl">height</span><span class="p">:</span> <span class="m">100px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.jumbotron</span><span class="p">{</span>
  <span class="nl">text-align</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.jumbotron</span> <span class="nt">h2</span><span class="p">{</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">60px</span><span class="p">;</span>
  <span class="nl">font-weight</span><span class="p">:</span> <span class="m">100</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@-webkit-keyframes</span> <span class="n">fadeOut</span> <span class="p">{</span>
  <span class="nt">0</span><span class="o">%</span> <span class="p">{</span><span class="nl">opacity</span><span class="p">:</span> <span class="m">0</span><span class="p">;}</span>
  <span class="nt">10</span><span class="o">%</span> <span class="p">{</span><span class="nl">opacity</span><span class="p">:</span> <span class="m">1</span><span class="p">;}</span>
  <span class="nt">90</span><span class="o">%</span> <span class="p">{</span><span class="nl">opacity</span><span class="p">:</span> <span class="m">1</span><span class="p">;}</span>
  <span class="nt">100</span><span class="o">%</span> <span class="p">{</span><span class="nl">opacity</span><span class="p">:</span> <span class="m">0</span><span class="p">;}</span>
<span class="p">}</span>

<span class="k">@keyframes</span> <span class="n">fadeOut</span> <span class="p">{</span>
  <span class="nt">0</span><span class="o">%</span> <span class="p">{</span><span class="nl">opacity</span><span class="p">:</span> <span class="m">0</span><span class="p">;}</span>
  <span class="nt">10</span><span class="o">%</span> <span class="p">{</span><span class="nl">opacity</span><span class="p">:</span> <span class="m">1</span><span class="p">;}</span>
  <span class="nt">90</span><span class="o">%</span> <span class="p">{</span><span class="nl">opacity</span><span class="p">:</span> <span class="m">1</span><span class="p">;}</span>
  <span class="nt">100</span><span class="o">%</span> <span class="p">{</span><span class="nl">opacity</span><span class="p">:</span> <span class="m">0</span><span class="p">;}</span>
<span class="p">}</span>

<span class="nc">.errors</span><span class="p">{</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">fixed</span><span class="p">;</span>
  <span class="nl">z-index</span><span class="p">:</span> <span class="m">10000</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span>
  <span class="nl">top</span><span class="p">:</span> <span class="m">0px</span><span class="p">;</span>
  <span class="nl">left</span><span class="p">:</span> <span class="m">0px</span><span class="p">;</span>
  <span class="nl">right</span><span class="p">:</span> <span class="m">0px</span><span class="p">;</span>
  <span class="nl">bottom</span><span class="p">:</span> <span class="m">0px</span><span class="p">;</span>
  <span class="nl">pointer-events</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.alert</span> <span class="p">{</span>
          <span class="nl">animation</span><span class="p">:</span> <span class="n">fadeOut</span> <span class="n">2700ms</span> <span class="n">ease-in</span> <span class="m">0s</span> <span class="m">1</span> <span class="n">forwards</span><span class="p">;</span>
  <span class="nl">-webkit-animation</span><span class="p">:</span> <span class="n">fadeOut</span> <span class="n">2700ms</span> <span class="n">ease-in</span> <span class="m">0s</span> <span class="m">1</span> <span class="n">forwards</span><span class="p">;</span>
     <span class="nl">-moz-animation</span><span class="p">:</span> <span class="n">fadeOut</span> <span class="n">2700ms</span> <span class="n">ease-in</span> <span class="m">0s</span> <span class="m">1</span> <span class="n">forwards</span><span class="p">;</span>
  <span class="nl">width</span><span class="p">:</span> <span class="m">250px</span><span class="p">;</span>
  <span class="nl">float</span><span class="p">:</span> <span class="nb">right</span><span class="p">;</span>
  <span class="nl">clear</span><span class="p">:</span> <span class="nb">both</span><span class="p">;</span>
  <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">5px</span><span class="p">;</span>
  <span class="nl">pointer-events</span><span class="p">:</span> <span class="nb">auto</span><span class="p">;</span>
<span class="p">}</span></pre>
          <div class="caption">client/stylesheets/style.css</div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 2-3</h4><p>重新整理文件结构</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter2-3" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter2-3.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <div class="note"><h3>CoffeeScript 说明</h3>
          
          <p>在本书中我们将使用纯 JavaScript。但是如果你更倾向于使用 CoffeeScript，Meteor 可以帮助你做到这点。你只需添加 CoffeeScript 代码包，之后便可以在项目中使用 CoffeeScript 了！</p>
          
          <p><code>meteor add coffeescript</code></p>
          </div>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="deploying">部署</h2>
            <span class="sidebar-marker">Sidebar</span>
            <span class="chapter-number">2.5</span>
          </div>
          <p>有些人喜欢不被打扰地工作，直到项目足够完美才去发布，而有些人则迫不及待的要向大家展示自己的项目。</p>
          
          <p>如果你是第一种人，现在宁愿在本地开发，那么可以果断跳过这一章。相反，如果你更愿意花时间去学习如何把 Meteor 应用部署到线上，我们下面为你提供一些方法。</p>
          
          <p>我们将学习几种不同的方法去部署一个 Meteor 应用。无论你是在开发 Microscope 或任何其他的 Meteor 应用，在你开发过程的任何阶段，可以随意地从它们当中挑选一个。让我们马上开始吧!</p>
          
          <div class="note"><h3>引入附录</h3>
          
          <p>这是一个<strong>附录</strong>章节。 不同于其他书的是，本书的附录会让我们深入去了解更多关于 Meteor 的知识。</p>
          
          <p>现在如果你更愿意去继续构建 Microscope ，你现在可以先忽略这一章，等有空再回来看也没问题。</p>
          </div>
          
          <h3>部署在 Meteor</h3>
          
          <p>首先最简单的是部署到 Meteor 的子域名上（例如： <code>http://myapp.meteor.com</code> ），这是我们首先要去学习的。在项目早期，这对于展示你的应用和快速设置一个测试服务器都很有用途。</p>
          
          <p>而部署在 Meteor 是非常简单的。打开终端，定位到你 Meteor 应用的目录，并输入：</p>
          <pre class="highlight shell">meteor deploy myapp.meteor.com</pre>
          <p>当然，你要把“myapp”替换成你想要的名称，最好是命名一个没有被使用的。如果你的名称已经被使用，Meteor 会提示你去输入密码。如果发生这样的情况，只需通过 <code>ctrl+c</code> 来取消当前操作，然后用另一个不同的名称再试一次。</p>
          
          <p>如果顺利地部署成功了，几秒钟后你就能够在 <code>http://myapp.meteor.com</code> 上访问到你的应用了。</p>
          
          <p>你可以参考<a href="http://docs.meteor.com/#deploying">官方文档</a>去了解更多关于如何直接访问你域名下的数据库，或者为你的应用设置一个自定义域名等等的相关信息。</p>
          
          <h3>部署在 Modulus</h3>
          
          <p><a href="https://modulus.io/">Modulus</a> 是一个部署 Node.js 应用 很好的选择。这是为数不多的 PaaS（platform-as-a-service 平台即服务）的提供商，并且已经正式支持 Meteor ，已经有不少人在它上面去搭建 Meteor 应用了。</p>
          
          <p>你可以通过阅读他们的<a href="http://help.modulus.io/customer/portal/articles/1647770-using-meteor-with-modulus">部署 Meteor 应用指南</a>去了解更多关于 Modulus 的信息。</p>
          
          <h3>Meteor Up</h3>
          
          <p>虽然每天都有新的云端解决方案出来，但是它们通常都有自己的一些问题和限制。目前，把 Meteor 应用部署在自己的服务器才是一个最好的方式。然而麻烦的是，部署到自己的服务器并不是那么简单，尤其如果你注重产品部署上去的质量的话。</p>
          
          <p><a href="https://github.com/arunoda/meteor-up">Meteor Up</a> （简称 <code>mup</code> ）是另一个通过命令行的操作去帮助你解决安装和部署问题。所以让我们看看如何通过 Meteor Up 来部署 Microscope。</p>
          
          <p>在此之前，我们需要一个服务器来发布。我们建议使用 <a href="http://digitalocean.com/">Digital Ocean</a>（每月最低5美元），或者  <a href="http://aws.amazon.com/">AWS</a>（它为小型实例提供免费，如果你只是想试玩玩 Meteor Up 就已经足够了）。</p>
          
          <p>无论选择哪种服务，你应该要解决这三样东西：你服务器的 IP 地址，登录账号（通常是 <code>root</code> 或者 <code>ubuntu</code> ）和登录密码。将它们安全地保存起来，我们很快就会用到。</p>
          
          <h3>Meteor Up 的初始化</h3>
          
          <p>首先，我们需要通过 <code>npm</code> 去安装 Meteor Up：</p>
          <pre class="highlight shell">npm install -g mup</pre>
          <p>然后我们将创建一个单独的目录，为我们的 Meteor Up 提供一个特定的部署环境。我们使用单独的目录出于两个原因：第一，这可以很好的避免里面包含任何你 Git 存储库的隐藏文件，尤其如果你是在公共代码库去操作。</p>
          
          <p>第二，通过使用多个单独的目录，我们能够并行地进行多个 Meteor Up 管理和配置。这将会用在实际产品的部署以及分段实例的部署。</p>
          
          <p>所以我们来创建这个新目录，并使用它来初始化一个新的 Meteor Up 项目：</p>
          <pre class="highlight shell">mkdir ~/microscope-deploy
<span class="nb">cd</span> ~/microscope-deploy
mup init</pre>
          <div class="note"><h3>通过 Dropbox 分享</h3>
          
          <p>为了确保你和你的团队都使用相同的部署设置，一个很好的方法就是把你的 Meteor Up 配置文件夹放在你的 Dropbox 上，或者任何类似的服务上。</p>
          </div>
          
          <h3>Meteor Up 的配置</h3>
          
          <p>当初始化一个新项目的时候，Meteor Up 会为了创建两个文件： <code>mup.json</code> 和 <code>settings.json</code> 。</p>
          
          <p><code>mup.json</code> 会保存所有我们部署的相关设置，而 <code>settings.json</code> 会保存所有应用的相关设置（OAuth token、Analytics token，等等）。</p>
          
          <p>下一步就是去配置你的 <code>mup.json</code> 文件。 <code>mup.json</code> 会默认在执行 <code>mup init</code> 的时候生成，而你要做的就是把空白的填上：</p>
          <pre class="highlight javascript"><span class="p">{</span>
  <span class="c1">//server authentication info
</span>  <span class="s2">"servers"</span><span class="err">:</span> <span class="p">[{</span>
    <span class="s2">"host"</span><span class="p">:</span> <span class="s2">"hostname"</span><span class="p">,</span>
    <span class="s2">"username"</span><span class="p">:</span> <span class="s2">"root"</span><span class="p">,</span>
    <span class="s2">"password"</span><span class="p">:</span> <span class="s2">"password"</span>
    <span class="c1">//or pem file (ssh based authentication)
</span>    <span class="c1">//"pem": "~/.ssh/id_rsa"
</span>  <span class="p">}],</span>

  <span class="c1">//install MongoDB in the server
</span>  <span class="s2">"setupMongo"</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span>

  <span class="c1">//location of app (local directory)
</span>  <span class="s2">"app"</span><span class="err">:</span> <span class="s2">"/path/to/the/app"</span><span class="p">,</span>

  <span class="c1">//configure environmental
</span>  <span class="s2">"env"</span><span class="err">:</span> <span class="p">{</span>
    <span class="s2">"ROOT_URL"</span><span class="p">:</span> <span class="s2">"http://supersite.com"</span>
  <span class="p">}</span>
<span class="p">}</span></pre>
          <div class="caption">mup.json</div>
          
          <p>让我们了解一下这些设置。</p>
          
          <p><strong>服务器身份验证</strong></p>
          
          <p>你会注意到 Meteor Up 提供了基于密码和基于私钥（PEM）的身份验证，所以它几乎可以用于任何的云提供商。</p>
          
          <p><strong>重要提示</strong>：如果你选择使用基于密码的身份验证，确保你在这之前已经安装了 <code>sshpass</code> （<a href="https://gist.github.com/arunoda/7790979">使用指南</a>）。</p>
          
          <p><strong>MongoDB 配置</strong></p>
          
          <p>下一步是为你的应用配置 MongoDB 数据库。我们建议使用 <a href="https://www.compose.io/">Compose</a> 或者其他提供云端 MongoDB 的提供商，因为它们提供专业支持和更好的管理工具。</p>
          
          <p>如果你决定使用 Compose ，把 <code>setupMongo</code> 设置为 <code>false</code> ，并添加 <code>MONGO_URL</code> 环境变量到 <code>mup.json</code> 中的 <code>env</code> 模块。如果你决定通过 Meteor Up 去访问 MongoDB ，只需要设置 <code>setupMongo</code> 为 <code>true</code> ，然后 Meteor Up 会完成剩下的工作。</p>
          
          <p><strong>Meteor 应用路径</strong></p>
          
          <p>因为 Meteor Up 的配置作用在不同的目录，我们需要通过  <code>app</code> 属性去把 Meteor Up 指回到应用。只需要设置你完整的本地路径，当你位于你的应用目录里面的时候，你可以使用 <code>pwd</code> 命令去获取它。</p>
          
          <p><strong>环境变量</strong></p>
          
          <p>你可以在 <code>env</code> 模块中指定应用的所有环境变量（比如： <code>ROOT_URL</code> ， <code>MAIL_URL</code> ， <code>MONGO_URL</code> 等等）</p>
          
          <h3>设置和部署</h3>
          
          <p>在我们可以部署之前，我们还需要设置服务器去为 Meteor 应用托管。Meteor Up 把这个复杂的过程封装在一个简单的命令上！</p>
          <pre class="highlight shell">mup setup</pre>
          <p>可能需要几分钟，这取决于服务器的性能和网络连接速度。设置成功后，终于可以去部署我们的应用：</p>
          <pre class="highlight shell">mup deploy</pre>
          <p>这将会打包我们的 Meteor 应用并部署到我们刚刚设置好的服务器上。</p>
          
          <h3>显示日志信息</h3>
          
          <p>日志也是非常重要的， Meteor Up 提供非常简单的方法去处理它，通过模仿 <code>tail -f</code> 命令，输入：</p>
          <pre class="highlight shell">mup logs -f</pre>
          <p>这一小节概述了 Meteor Up 的用法。了解更多关于它的信息，我们建议看看 <a href="https://github.com/arunoda/meteor-up">Meteor Up 在 GitHub 上详细介绍</a></p>
          
          <p>这三种部署 Meteor 应用的方式应该足够满足大多数的案例了。当然，我们知道一些人会喜欢更进一步地控制和设置他们的 Meteor 服务器。然而这将会是另一个主题，或者另一本书！</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="templates">模板</h2>
            <span class="chapter-number">3</span>
          </div>
          <p>为了更容易地进入 Meteor 的开发，我们将采用从外向内的方法来搭建项目。换句话说，我们将首先建立一个 HTML/JavaScript 的外壳，然后把它放到我们的项目里，内部细节处理稍后再说。</p>
          
          <p>这意味着在本章中，我们只关注 <code>/client</code> 目录里面的事情。</p>
          
          <p>让我们先在 <code>/client</code> 目录创建一个 <code>main.html</code>  文件，并写入以下代码：</p>
          <pre class="highlight html"><span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>Microscope<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-default"</span> <span class="na">role=</span><span class="s">"navigation"</span><span class="nt">&gt;</span> 
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>Microscope<span class="nt">&lt;/a&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main"</span><span class="nt">&gt;</span>
      {{&gt; postsList}}
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span></pre>
          <div class="caption">client/main.html</div>
          
          <p>这是我们主要的 App 模板。在上面看到很多熟悉的 HTML 标签，除了这个 <code>{{&gt; postsList}}</code> 标签，它是 <code>postsList</code> 模板的插入点，等一下我们就会说到。现在，先让我们创建更多的模板吧。</p>
          
          <h3>Meteor 模板</h3>
          
          <p>我们项目的核心是社会新闻网站，它是由一系列的帖子所组成的，而这正是我们要调用模板的原因。</p>
          
          <p>我们先在 <code>/client</code> 里面创建一个 <code>/templates</code> 目录。这里用来放我们所有的模板，这样可以保持项目结构的清晰整洁，接着在 <code>/templates</code> 里面再创建 <code>/posts</code> 目录来存放与帖子相关的模板。</p>
          
          <div class="note"><h3>查找文件</h3>
          
          <p>Meteor 的强大之处在于文件的查找。无论你把代码文件放在 <code>/client</code> 目录下的任何地方，Meteor 都可以找到它并且正确地进行编译。这意味着你永远都不需要手动编写 JavaScript 或 CSS 文件的调用路径。</p>
          
          <p>这也意味着你可能会把所有的文件放在同一目录，甚至所有的代码放在同一个文件。但由于 Meteor 会把一切的代码都编译到一个压缩的文件里面，因此我们更偏向于把项目弄得井井有条，使用更整洁的文件结构，提高项目的可读性。</p>
          </div>
          
          <p>接下来我们开始创建第二个模板。在 <code>client/templates/posts</code> 目录中，创建  <code>posts_list.html</code> :</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postsList"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"posts"</span><span class="nt">&gt;</span>
    {{#each posts}}
      {{&gt; postItem}}
    {{/each}}
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/posts_list.html</div>
          
          <p>和 <code>post_item.html</code> ：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postItem"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"post-content"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{url}}"</span><span class="nt">&gt;</span>{{title}}<span class="nt">&lt;/a&gt;&lt;span&gt;</span>{{domain}}<span class="nt">&lt;/span&gt;&lt;/h3&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/post_item.html</div>
          
          <p>注意模板的 <code>name="postsList"</code> 属性，它的作用是告诉 Meteor 去根据这个名称来跟踪这个模板的位置。（注意的是实际文件的文件名不相关。）</p>
          
          <p>是时候来介绍 Meteor 的模板系统 <strong>Spacebars</strong> 了。Spacebar 就是简单的 HTML 加上三件事情：<em>Inclusion</em> （有时也称作 “partial”）、<em>Expression</em> 和 <em>Block Helper</em>。</p>
          
          <p><em>Inclusion</em> ：通过 <code>{{&gt; templateName}}</code> 标记，简单直接地告诉 Meteor 这部分需要用相同名称的模板来取代（在我们的例子中就是 <code>postItem</code> ）。</p>
          
          <p><em>Expression</em> ：比如 <code>{{title}}</code> 标记，它要么是调用当前对象的属性，要么就是对应到当前模板管理器中定义的 helper 方法，并返回其方法值（后面会详细讨论）。</p>
          
          <p><em>Block Helper</em> ：在模板中控制流程的特殊标签，如 <code>{{#each}}…{{/each}}</code> 或 <code>{{#if}}…{{/if}}</code> 。</p>
          
          <div class="note"><h3>进一步学习</h3>
          
          <p>你如果想了解更多关于 Spacebars，可以参考 <a href="https://github.com/meteor/meteor/blob/devel/packages/spacebars/README.md">Spacebars 文档</a>。</p>
          </div>
          
          <p>有了这些知识，我们就可以很容易去理解了。</p>
          
          <p>首先，在 <code>postsList</code> 模板里，我们通过 <code>{{#each}}…{{/each}}</code> Block Helper 去遍历一个 <code>posts</code> 对象。然后，每次迭代我们去包含 <code>postItem</code> 模板。</p>
          
          <p>这个 <code>posts</code> 对象来自哪里？好问题。它实际上是一个 <strong>模板 helper</strong>，你可以想象它是动态值的占位符（placeholder）。</p>
          
          <p><code>postItem</code> 这个模板本身相当简单。它只使用三个标签： <code>{{url}}</code> 和 <code>{{title}}</code> 都返回其集合的属性，而 <code>{{domain}}</code> 则调用模板对应的 helper 方法。</p>
          
          <h3>模板 Helper</h3>
          
          <p>到目前为止我们已经学会了使用 Spacebars ，这只是在 HTML 的基础上多几个标签而已。不像其他语言如 PHP
 （甚至常规 HTML 页面，还包含了 JavaScript）， Meteor 
只是让模板和逻辑进行分离，而这些模板本身并不需要做很多复杂的事情。</p>
          
          <p>为了让连接变得更流畅，一个模板需要 <strong>helper</strong>。你可以想象这些 helper 就是厨师用食材（你的数据）烹饪好佳肴（模板），再由服务员端到你面前。</p>
          
          <p>换句话说，模板的作用局限于显示或循环变量，而 helper 则扮演着一个相当重要的角色：把值分配给每个变量。</p>
          
          <div class="note"><h3>Contoller 控制器?</h3>
          
          <p>我们也许会情不自禁地认为包含所有模板 helper 的文件是个 controller（控制器）。但这是很模糊的，因为 controller （至少在 MVC 情况下）通常有些不同的作用。</p>
          
          <p>所以我们决定远离那个术语，在谈论关于模板涉及的 JavaScript 代码时，就简单地称为“模板的 helper”或是“模板的逻辑”。</p>
          </div>
          
          <p>为简单起见，我们将采用与模板同名的方式来命名包含其 helper 的文件，区别是 <strong>.js</strong> 扩展名。那好让我们马上在 <code>/client/templates/posts</code> 目录下创建 <code>posts_list.js</code> 文件，开始构建我们第一个 helper：</p>
          <pre class="highlight javascript"><span class="kd">var</span> <span class="nx">postsData</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'Introducing Telescope'</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://sachagreif.com/introducing-telescope/'</span>
  <span class="p">},</span> 
  <span class="p">{</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'Meteor'</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://meteor.com'</span>
  <span class="p">},</span> 
  <span class="p">{</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'The Meteor Book'</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://themeteorbook.com'</span>
  <span class="p">}</span>
<span class="p">];</span>
<span class="nx">Template</span><span class="p">.</span><span class="nx">postsList</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">posts</span><span class="p">:</span> <span class="nx">postsData</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/posts_list.js</div>
          
          <p>如果你运行是正确的，你现在应该在浏览器中看到这样的画面：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/3-1.png" alt="我们的第一个带静态数据的模板"><figcaption>我们的第一个带静态数据的模板</figcaption></figure>
          
          <p>我们刚刚在做两件事情。首先我们放置一些虚拟的基本数据到 <code>postsData</code> 数组中。原本数据应该是来自数据库的，但由于我们还没有学习到该怎么做（下一章揭晓），所以我们先通过使用静态数据来“作弊”。</p>
          
          <p>然后，我们使用的是 Meteor 的 <code>Template.postsList.helpers()</code> 函数，建立了 <code>posts</code> 模板 helper 来返回刚刚定义的 <code>postsData</code> 数组。</p>
          
          <p>如果你记得，现在我们在 <code>postsList</code> 模板中使用这个 <code>posts</code> helper：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postsList"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"posts"</span><span class="nt">&gt;</span>
    {{#each posts}}
      {{&gt; postItem}}
    {{/each}}
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/posts_list.html</div>
          
          <p>定义 <code>posts</code> helper 就就让我们的模板可以使用它，所以模板就可以遍历 <code>postsData</code> 数组并将里面的每个对象发送到 <code>postItem</code> 模板中。</p>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 3-1</h4><p>添加了基本的 post 列表模板和静态数据。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter3-1" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter3-1.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <h3>关于 <code>domain</code> Helper</h3>
          
          <p>类似地，我们现在创建一个 <code>post_item.js</code> 文件来包含 <code>postItem</code> 模板的逻辑：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">domain</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'a'</span><span class="p">);</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_item.js</div>
          
          <p>这一次我们 <code>domain</code> helper 的值不再是一个数组，而是一个匿名函数。相比起我们之前简化的虚拟数据的例子，这种模式更为常见（而且更有用）。</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/3-2.png" alt="显示每个链接的域名。"><figcaption>显示每个链接的域名。</figcaption></figure>
          
          <p>这个 <code>domain</code> helper 方法通过 JavaScript 来获取一个 URL 地址并返回其域名。但是它一开始是从哪里获得 URL 地址呢？</p>
          
          <p>为了回答这个问题，我们需要回到我们的 <code>posts_list.html</code> 模板。<code>{{#each}}</code> 代码块不仅遍历我们数组，它还在<strong>代码块范围内将 <code>this</code> 的值赋予被遍历的对象</strong>。</p>
          
          <p>这意味着在 <code>{{#each}}</code> 标记之间，每个 post 都可以通过 <code>this</code> 依次访问，并且一直延伸到模板 helper（<code>post_item.js</code>）中。</p>
          
          <p>我们现在明白了为什么 <code>this.url</code> 会返回当前 post 的 URL。而且，如果我们在 <code>post_item.html</code> 模板里面使用 <code>{{title}}</code> 和 <code>{{url}}</code>，Meteor 就会知道需要去调用 <code>this.title</code> 和 <code>this.url</code> 去返回我们想要的正确值。</p>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 3-2</h4><p>设置 `postItem` 的 `domain` helper。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter3-2" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter3-2.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <div class="note"><h3>神奇的 JavaScript</h3>
          
          <p>尽管这对于 Meteor 来说并不特别，这里会简单解释一下上面“神奇的 JavaScript 代码”。首先，我们创建一个空的锚（<code>a</code>）HTML 标签并储存在内存中。</p>
          
          <p>然后我们将其 <code>href</code> 属性设置为当前 post 的 URL （正如我们刚刚讲到的，<code>this</code> 在 helper 中正是当前被操作的对象）。</p>
          
          <p>最后，我们利用 <code>a</code> 标签的特别的 <code>hostname</code> 属性来返回 URL 的域名。</p>
          </div>
          
          <p>如果你正确地紧跟着我们的进度，这时候你就会在浏览器中看到一个 post 列表。但这个列表只是调用了静态数据，它没有利用到 Meteor 实时性的特点。我们将在下一章向你展示该如何去修改！</p>
          
          <div class="note"><h3>动态代码重载</h3>
          
          <p>你可能已经注意到，当你修改文件的时候，不需要手动刷新页面，浏览器就会自动重新加载。</p>
          
          <p>这是因为 Meteor 跟踪了项目目录下的所有文件，当检测到其中一个文件发生改变，它就会自动刷新你的浏览器。</p>
          
          <p>Meteor 的动态代码重载是相当智能的，它甚至可以在两个刷新动作之间保存你的 App 状态。</p>
          </div>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="github">使用 Git 和 GitHub</h2>
            <span class="sidebar-marker">Sidebar</span>
            <span class="chapter-number">3.5</span>
          </div>
          <p><a href="https://github.com/">GitHub</a> 是一个开源项目的社交化代码存储空间，基于 <a href="http://git-scm.com/">Git</a> 作为版本控制系统。它的首要功能就是代码共享和项目协作。在本章你可以快速找到用 GitHub 学习本书的一些方法。</p>
          
          <p>本章节假设你不太了解 Git 和 GitHub。如果你已经熟悉他们了，你可以直接跳到下一章！</p>
          
          <h3>代码提交</h3>
          
          <p>Git 最基本的工作单元是<em>提交</em>。你可以把提交设想为你的代码库在某个特定时间的一个快照。</p>
          
          <p>与其简单地给你一个 Microsocope 项目的最终代码版本，我们更愿意把开发过程中每一步的快照都提供出来，这样你在 Github 上在线看到。</p>
          
          <p>比如，这个就是我们上一章最后一次提交 (https://github.com/DiscoverMeteor/Microscope/commit/chapter3-2) 
          看起来是这样的：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/s3-1.png" alt="GitHub 上的一次代码提交"><figcaption>GitHub 上的一次代码提交</figcaption></figure>
          
          <p>你可以看到 <code>post_item.js</code> 这个文件的“diff”（差异），换句话说就是这次提交改动了这个文件的什么地方。因为我们这个文件是新建的，所以你可以看到所有内容都是绿色高亮。</p>
          
          <p>让我们对比一下另外一个例子<a href="https://github.com/DiscoverMeteor/Microscope/commit/chapter13-1">本书中以后会用到的文件</a>：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/s3-2.png" alt="修改代码"><figcaption>修改代码</figcaption></figure>
          
          <p>这次，只有修改的代码行被高亮为绿色了。</p>
          
          <p>当然，有时候我们并不增加和修改代码，而是直接<a href="https://github.com/DiscoverMeteor/Microscope/commit/chapter12-2">删除</a>某些行：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/s3-3.png" alt="删除代码"><figcaption>删除代码</figcaption></figure>
          
          <p>好了，我们现在看到 GitHub 的第一个好处：一览代码的改动。</p>
          
          <h3>浏览提交的代码</h3>
          
          <p>Git 的提交视图给我们显示了本次提交的代码改动，但是有时候我们还是需要看看<em>没有修改</em>的
          那些代码，从而确认他们的代码看起来合理。</p>
          
          <p>好，让 GitHub 再次来解决这个问题。在提交页面上点击 <strong>Browse code（浏览代码）</strong>按钮：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/s3-5.png" alt="浏览代码按钮"><figcaption>浏览代码按钮</figcaption></figure>
          
          <p>你现在可以看到某次提交的时候代码库的样子了。</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/s3-6.png" alt="提交编号 3-2 的代码库。"><figcaption>提交编号 3-2 的代码库。</figcaption></figure>
          
          <p>GitHub 没有给我们足够的视觉提示让我们知道我们正在看一个提交，不过你可以通过与 “正常” 的主视图进行比较，就会发现文件结构的不同了：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/s3-7.png" alt="提交编号 14-2 的代码库。"><figcaption>提交编号 14-2 的代码库。</figcaption></figure>
          
          <h3>访问本地提交</h3>
          
          <p>我们刚刚看到在 Github 上如何在线浏览某个提交的整个代码。但是你是否想在本地也看到呢？比如你也许想退回到某次提交的代码状态测试一下那时候运行的样子。</p>
          
          <p>想做到这个你需要首次（也许你早已经不是首次了，但是至少在本书中是第一次用命令行）用 <code>git</code> 命令行。对于新手首先要确定你已经<a href="http://git-scm.com/downloads">安装</a>了 Git。然后 <strong>克隆 Clone</strong>（或者叫下载一份本地拷贝）一份 Microscope 的代码库。命令如下：</p>
          <pre class="highlight shell">git clone git@github.com:DiscoverMeteor/Microscope.git github_microscope</pre>
          <p>命令行最后的 <code>github_microscope</code> 实际上就是将会存代码库的本地目录名。假设你已有了 <code>microscope</code> 文件夹，那就随便起一个新名字（不是必须用和 GitHub 代码库相同的名字）。</p>
          
          <p>让我们 <code>cd</code> 进这个代码库，然后就可以使用 <code>git</code> 命令了。</p>
          <pre class="highlight shell"><span class="nb">cd </span>github_microscope</pre>
          <p>现在我们已经从 GitHub 克隆了代码库，我们已经下载了这个应用的 <em>全部</em> 代码，也就是说我们正在看的是最后一次提交。</p>
          
          <p>值得感激的是我们有办法<em>check out（签出）</em>代码回退到某一个特定的提交，而不会影响到其他提交。让我们试一下：</p>
          <pre class="highlight shell">git checkout chapter3-1
Node：checking out <span class="s1">'chapter3-1'</span>.

你现在是在 <span class="s1">'detached HEAD'</span> 状态. 你可以随便看看做点实验性的修改并提交。你只需再次签出代码即可放弃你的提交，而不会影响的任何其他分支。

如果你想建立新的分支来保留你的提交，你可以这样做（现在或者以后也行），迁出代码的时候使用 -b 参数。

举例：

  git checkout -b new_branch_name

HEAD is now at a004b56... Added basic posts list template and static data.</pre>
          <p>Git 通知你现在在 ‘分离头’ “detached HEAD” 状态，也就是说就 Git 而言， 你可以发现过去的历史提交但是不能修改。你可以想象一个巫婆用水晶球回顾历史。</p>
          
          <p>（注意 Git 还有让你 <em>改变</em> 历史提交的命令。这更像是时间旅行，不过那些不是我们本书需要讨论的范畴了。）</p>
          
          <p>你能够简单地输入 <code>chapter3-1</code> 是因为我们实现已经把所有的 Microscope 的提交都打了标签了。 如果你的提交没有标签，那么你需要先找到你的提交的 <strong>哈希码 hash</strong>，或者ID。</p>
          
          <p>再一次 GitHub 让我们可以轻松地在提交的右下角看到蓝色提交框中提交哈希码。如图所示：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/s3-4.png" alt="找到提交的哈希码"><figcaption>找到提交的哈希码</figcaption></figure>
          
          <p>这一次让我们试试哈希码而不是标签：</p>
          <pre class="highlight shell">git checkout c7af59e425cd4e17c20cf99e51c8cd78f82c9932
Previous HEAD position was a004b56... Added basic posts list template and static data.
HEAD is now at c7af59e... Augmented the postsList route to take a limit</pre>
          <p>好了，别再用水晶球看历史提交了，让我们想看看最新的代码状态，我们可以让 Git 签出主分支<strong>master</strong>：</p>
          <pre class="highlight shell">git checkout master</pre>
          <p>注意，你也可以现在运行 <code>meteor</code> 命令，即使是在“detached HEAD”的状态下。你也许首先需要运行一下 <code>meteor update</code> 命令，如果 Meteor 提示有丢失的代码包，因为 Microscope 的 Git 代码库没有包括包代码。</p>
          
          <h3>Historical Perspective</h3>
          
          <p>这里还有一种常见的情形：你看代码文件的时候发现有一些你以前没有见到过的改动。大多数情况是你不记得<strong>什么时候</strong>你改了这个文件。你可以逐个检查每个提交直到你发现某个提交造成了这个改动，不过还有一种更好的方法，那就是 GitHub 的 <strong>历史</strong> 功能。</p>
          
          <p>首先，在 GitHub 上找一个代码库里的文件，然后找到 “历史” 按钮：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/s3-8.png" alt="GitHub 的历史按钮"><figcaption>GitHub 的历史按钮</figcaption></figure>
          
          <p>你现在可以看到所有影响这个文件的提交历史：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/s3-9.png" alt="显示一个文件的历史"><figcaption>显示一个文件的历史</figcaption></figure>
          
          <h3>问责游戏</h3>
          
          <p>让我们看看<strong>问责</strong>：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/s3-10.png" alt="GitHub 的问责按钮"><figcaption>GitHub 的问责按钮</figcaption></figure>
          
          <p>这个简洁的视图给我们逐行显示了谁修改过这个文件，以及在哪次提交中修改的。（换句话说，知道软件搞坏了该找谁算账）：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/s3-11.png" alt="GitHub 问责视图"><figcaption>GitHub 问责视图</figcaption></figure>
          
          <p>现在的 Git 已经是一个相当复杂的工具了 - GitHub 也一样 - ，所以你不可能在这里覆盖所有功能。事实上，我们只是学习了一点皮毛。尽管如此，这点皮毛已经够我们在本书的学习中用了。</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="collections">集合</h2>
            <span class="chapter-number">4</span>
          </div>
          <p>在第一章我们提到了 Meteor 的核心功能， 那就是服务器端和客户端的自动数据同步。</p>
          
          <p>在这一章我们要仔细了解一下它是如何运作的，以及研究那个让它得以运行的关键技术: Meteor <strong>集合（Collection）</strong>。</p>
          
          <p>集合是一个特殊的数据结构，它将你的数据存储到持久的、服务器端的 MongoDB 数据库中，并且与每一个连接的用户浏览器进行实时地同步。</p>
          
          <p>我们想让我们的 post 永久保存并且要在用户之间共享，所以我们一开始要新建一个叫做 <code>Posts</code> 的 collection 来保存它们。</p>
          
          <p>我们现在做一个社交新闻应用， 所以第一件事儿就是做一个人们贴上来的帖子的连接列表。 我们叫它 ‘post’</p>
          
          <p>很自然， 我们需要把它们存起来。 Meteor 捆绑了 MongoDB 运行在服务器上作为<em>持久化</em>存储。</p>
          
          <p>因此，尽管一个用户在浏览器上有各种状态(比如他们正在阅读哪一页， 或者正在输入那一条评论)， 而服务器上，尤其是 Mongo，保存的是永久保留的<em>一致</em>数据。 说到<em>一致</em>， 我们是指对于所有用户来说都是一样的数据: 每个用户也许在看不同的页面， 但是帖子 Post 的主列表对所有用户来说却始终是一样的。</p>
          
          <p>这些数据在Meteor中被存储在集合（<strong>Collection</strong>）中。 集合是一种特殊的数据结构， 通过发布（publications）和订阅（subscriptions）机制把数据实时同步上行或者下行到连接着的各个用户的浏览器或者Mongo数据库中。
          让我们看看如何做到的。</p>
          
          <p>我们希望我们的帖子Post可以持久存储并分享给用户们， 所以我们一开始就要建立一个叫 <code>Posts</code> 的集合来存储他们。 如果你还没有在根文件夹建立一个叫做 <code>collections/</code> 的文件夹， 并在里面放一个 <code>posts.js</code> 的文件的话，那现在就加上。</p>
          <pre class="highlight javascript"><span class="nx">Posts</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span></pre>
          <div class="caption">lib/collections/posts.js</div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 4-1</h4><p>增加一个 post 集合</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter4-1" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter4-1.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>代码所在的目录既不是 <code>client/</code> 也不是 <code>server/</code> 所以 <code>Posts</code> 会共同存在运行在服务器和客户端。 然而，这个集合的使用在两种环境下十分不同。</p>
          
          <div class="note"><h3>要 Var 还是不要 Var?</h3>
          
          <p>在 Meteor 中，关键字 <code>var</code> 限制对象的作用域在文件范围内。 我们想要 <code>Posts</code> 作用于整个应用范围内，因此我们在这里不要 Var 这个关键字。</p>
          </div>
          
          <h3>存储数据</h3>
          
          <p>网络应用有三种基本方式保存数据，各种方式有不同的角色：</p>
          
          <ul>
          <li><strong>浏览器内存</strong>：像 JavaScript 变量的这些数据会保存在浏览器内存中，意味着他们不是永久性的：它们存在于当前浏览器标签中，当标签关闭后它们会消失。</li>
          <li><strong>浏览器存储</strong>：浏览器也可存储较为永久性的数据，使用 cookies 或<a href="http://diveintohtml5.info/storage.html">本地存储 Local Storage</a>。虽然数据会在不同 session 间保持，但是只是针对于当前用户（包括标签之间）但不能轻易地共享给其他用户。</li>
          <li><strong>服务器端数据库</strong>：你想永久保存数据并且提供给多个用户的最好方法是数据库（MongoDB 是 Meteor 应用默认的方案）。</li>
          </ul>
          
          <p>Meteor 使用所有三种方式，有时会从一个地方同步数据到另一个地方（我们会马上看到）。话虽如此，数据库仍然是包含数据主副本的“规范化的”数据源。</p>
          
          <h3>客户端与服务器</h3>
          
          <p>不在 <code>client/</code> 或 <code>server/</code> 文件夹中代码会在<strong>客户端和服务器端</strong>运行。所以 <code>Posts</code> 集合在<strong>客户端和服务器端</strong>都可用。但是，在各自环境下所起的作用有很大不同。</p>
          
          <p>在服务器，集合有一个任务就是和 Mongo 数据库联络，读取任何数据变化。 在这种情况下，它可以比对标准的数据库。</p>
          
          <p>在客户端，集合是一个<em>安全</em>拷贝来自于实时一致的数据<em>子集</em>。客户端的集合总是（通常）透明地实时更新数据子集。</p>
          
          <div class="note"><h3>Console，Console 与 Console</h3>
          
          <p>在这一章，我们开始使用<strong>浏览器控制台</strong>，不过不要和<strong>终端</strong>、<strong>Meteor Shell</strong> 或者 <strong>Mongo Shell</strong> 搞混了。 现在对它们做个比对。</p>
          
          <h4>终端命令行（Terminal）</h4>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/terminal.png" alt="终端命令行"><figcaption>终端命令行</figcaption></figure>
          
          <ul>
          <li>由操作系统启动</li>
          <li><strong>服务器端</strong> <code>console.log()</code> 会输出到这里</li>
          <li>有 <code>$</code> 提示符</li>
          <li>通常也被成为外壳程序 Shell，Bash</li>
          </ul>
          
          <h4>浏览器控制台（Browser Console）</h4>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/browser-console.png" alt="The Browser Console"><figcaption>The Browser Console</figcaption></figure>
          
          <ul>
          <li>在浏览器内启动，执行 Javascript 代码<br></li>
          <li><strong>客户端</strong>的 <code>console.log()</code> 会输出到这里</li>
          <li>提示符是 <code>❯</code></li>
          <li>也通常被称作 Javascript 控制台或者开发工具控制台（DevTools Console）</li>
          </ul>
          
          <h4>Meteor Shell</h4>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/meteor-shell.xml" alt="Meteor Shell"><figcaption>Meteor Shell</figcaption></figure>
          
          <ul>
          <li>在 Terminal 用 <code>meteor shell</code> 调用。</li>
          <li>使你直接接触到应用的服务器端代码。</li>
          <li>提示符：<code>&gt;</code>。</li>
          </ul>
          
          <h4>Mongo 外壳程序 (Mongo Shell)</h4>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/mongo-shell.png" alt="Mongo 外壳"><figcaption>Mongo 外壳</figcaption></figure>
          
          <ul>
          <li>从终端由 <code>meteor mongo</code> 或者 <code>mrt mongo</code> 来启动</li>
          <li>你可以在这里直接操作 App 的数据库</li>
          <li>提示符 <code>&gt;</code></li>
          <li>也被称作 Mongo 控制台 (Mongo Console)</li>
          </ul>
          
          <p>注意在各种情况下你都不需要敲提示符（<code>$</code> <code>❯</code> 或 <code>&gt;</code>）在命令前面。而且你可以认定任何不是用提示符起始的行都是前一个命令的输出结果。</p>
          </div>
          
          <h3>服务器端的集合</h3>
          
          <p>在服务器端，集合可以像 API 一样操作 Mongo 数据库。在服务器端的代码，你可以写像 <code>Posts.insert()</code> 或 <code>Posts.update()</code> 这样的 Mongo 命令，来对 Mongo 数据库中的 <code>posts</code> 集合进行操作。</p>
          
          <p>如果想直接看看 MongoDB 数据库，可以打开第二个终端窗口（这时候 Meteor 还在第一个终端窗口继续运行呢），在你应用的目录，输入命令 <code>meteor mongo</code> 启动 Mongo Shell 外壳程序。现在你可以输入标准的 Mongo 命令（如同以往，你可以敲 <code>ctrl+c</code> 快捷键退出）。比如让我们插入一个新的 post：</p>
          <pre class="highlight shell">meteor mongo

<span class="gp">&gt; </span>db.posts.insert<span class="o">({</span>title: <span class="s2">"A new post"</span><span class="o">})</span>;

<span class="gp">&gt; </span>db.posts.find<span class="o">()</span>;
<span class="o">{</span> <span class="s2">"_id"</span>: ObjectId<span class="o">(</span><span class="s2">".."</span><span class="o">)</span>, <span class="s2">"title"</span> : <span class="s2">"A new post"</span><span class="o">}</span>;</pre>
          <div class="caption">Mongo Shell</div>
          
          <div class="note"><h3>Meteor.com 上的 Mongo</h3>
          
          <p>注意如果你把应用部署在 *.meteor.com 上，你一样可以通过 <code>meteor mongo myApp</code> 的方式进入你应用的 Mongo shell 进行操作。</p>
          
          <p>而且你还可以输入 <code>meteor logs myApp</code> 得到你应用的 log 日志。</p>
          </div>
          
          <p>Mongo 的语法由于借鉴了 Javascript 的语法所以十分熟悉。我们现在在 Mongo 外壳里不做过多的数据操作，不过我们可以随时来这里检查数据确保他们正常存在。</p>
          
          <h3>客户端集合</h3>
          
          <p>客户端的集合更加有趣。当你在客户端申明 <code>Posts = new Mongo.Collection('posts');</code> 你实际上是创建了一个本地的，在浏览器缓存中的真实的 Mongo 集合。 当我们说客户端集合被"缓存"是指它保存了你数据的一个<em>子集</em>，而且对这些数据提供了十分<em>快速</em>的访问。</p>
          
          <p>有一点我们必须要明白，因为这是 Meteor 工作的一个基础: 通常说来，客户端的集合的数据是你 Mongo 数据库的所有数据的一个子集（毕竟我们不会想把<em>整个</em>数据库的数据全传到客户端来）。</p>
          
          <p>第二，那些数据是被存储在<em>浏览器内存</em>中的，也就是说访问这些数据几乎不需要时间，不像去服务器访问 <code>Posts.find()</code> 那样需要等待，因为数据事实上已经载入了。</p>
          
          <div class="note"><h3>介绍 MiniMongo</h3>
          
          <p>Meteor 的客户端 Mongo 的技术实现被成为 MiniMongo。它目前还不是一个完美的实现，而且你会发现偶尔 Mongo 的功能在这里不能实现。不过本书中涉及到的功能都是可以在 Mongo 和 MiniMongo 中实现的。</p>
          </div>
          
          <h3>客户端-服务器通讯</h3>
          
          <p>这一切最关键的是如何让客户端的集合数据与服务器端同名的集合数据同步（以我们现在这个例子来说是 <code>posts</code>）。</p>
          
          <p>与其现在就解释细节不如让我们先来看看发生了什么。</p>
          
          <p>现在我们打开两个浏览器窗口，分别打开他们的浏览器控制台。然后在终端命令行打开 Mongo 外壳程序。</p>
          
          <p>现在可以在这三个地方看到我们早前时候建立的那个文档。(注意，我们应用的<em>用户界面</em>依然显示着我们之前的三个演示 post，请忽略它们。)</p>
          <pre class="highlight shell"><span class="gp">&gt; </span>db.posts.find<span class="o">()</span>;
<span class="o">{</span>title: <span class="s2">"A new post"</span>, _id: ObjectId<span class="o">(</span><span class="s2">".."</span><span class="o">)}</span>;</pre>
          <div class="caption"> Mongo 外壳</div>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">();</span>
<span class="p">{</span><span class="na">title</span><span class="p">:</span> <span class="s2">"A new post"</span><span class="p">,</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">LocalCollection</span><span class="p">.</span><span class="nx">_ObjectID</span><span class="p">};</span></pre>
          <div class="caption">第一个浏览器控制台</div>
          
          <p>让我们来创建一个帖子。在其中一个浏览器窗口中运行这个插入命令：</p>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">();</span>
<span class="mi">1</span>
<span class="err">❯</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">title</span><span class="p">:</span> <span class="s2">"A second post"</span><span class="p">});</span>
<span class="s1">'xxx'</span>
<span class="err">❯</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">();</span>
<span class="mi">2</span></pre>
          <div class="caption">第一个浏览器控制台</div>
          
          <p>毫无疑问，这个帖子被加入到本地集合中。现在让我们查看一下 Mongo：</p>
          <pre class="highlight shell">❯ db.posts.find<span class="o">()</span>;
<span class="o">{</span>title: <span class="s2">"A new post"</span>, _id: ObjectId<span class="o">(</span><span class="s2">".."</span><span class="o">)}</span>;
<span class="o">{</span>title: <span class="s2">"A second post"</span>, _id: <span class="s1">'yyy'</span><span class="o">}</span>;</pre>
          <div class="caption">Mongo 外壳</div>
          
          <p>如同你所看见的那样，这个帖子一路上行一直到 Mongo 数据库中，而我们却没有为这个连接客户端和服务器的过程写任何一行代码。（严格地说，我们的确写了<em>一行</em>代码：<code>new Mongo.Collection('posts')</code>）。但是这没关系！</p>
          
          <p>现在到第二个浏览器窗口的控制台中输入这个命令：</p>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">();</span>
<span class="mi">2</span></pre>
          <div class="caption">第二个浏览器的控制台</div>
          
          <p>这个帖子居然也在这儿！甚至于我们连刷新都没有在第二个浏览器做过，更何况我们也没有写任何代码来推送更新。这一切想魔术一般 - 而且是即时的，尽管这一切以后看起来都很显而易见。</p>
          
          <p>实际情况是服务器端的集合被客户端的集合通知说有一个新帖子，然后执行了一个任务把这个帖子放入 Mongo 数据库，进而会送到所有连接着的 <code>post</code> 即可。</p>
          
          <p>在浏览器的控制台取出所有的帖子没什么用处。我们以后会学习如何把这些数据显示在模板中，并把这个简单的 HTML 原型变成一个有用的实时 Web 应用。</p>
          
          <h3>保持实时</h3>
          
          <p>从浏览器控制台看到集合算是一件事儿，我们更应该关注的是能在屏幕上显示数据和数据的变化。要做到这一点，我们需要把我们的应用从一个单一显示静态数据的<code>页面</code>变成可以实时动态数据的<code>应用</code>。</p>
          
          <p>让我们看怎么做。</p>
          
          <h3>从数据库提取数据</h3>
          
          <p>首先我们先放点数据在数据库里。我们要做的是让服务器第一次初始启动的时候从一个数据文件中读取数据结构存在<code>Posts</code> 集合中。</p>
          
          <p>首先我们要确保数据库中没有数据。我们使用 <code>meteor reset</code> 命令清空数据库初始化我们的项目。当然，如果在真实的正在运行的正式项目上请务必十分小心。</p>
          
          <p>停止 Meteor 服务（通过键入 <code>ctrl-c</code>） 然后在命令行输入：</p>
          <pre class="highlight shell">meteor reset</pre>
          <p>这个 reset 命令彻底地把 Mongo 数据库清空了。在开发的时候这个命令很有用，尤其当我们的数据库发生数据混乱的时候。</p>
          
          <p>现在重启我们的 Meteor 应用：</p>
          <pre class="highlight shell">meteor</pre>
          <p>现在数据库已经清空，我们可以增加下面的代码以便在服务器启动时候检查数据库 <code>Posts</code> 集合，如果为空则载入三条帖子。</p>
          <pre class="highlight javascript"><span class="k">if</span> <span class="p">(</span><span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">()</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'Introducing Telescope'</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://sachagreif.com/introducing-telescope/'</span>
  <span class="p">});</span>

  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'Meteor'</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://meteor.com'</span>
  <span class="p">});</span>

  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'The Meteor Book'</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://themeteorbook.com'</span>
  <span class="p">});</span>
<span class="p">}</span></pre>
          <div class="caption">server/fixtures.js</div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 4-2</h4><p>在 posts 集合中加入数据.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter4-2" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter4-2.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>我们把这个文件放到了 <code>server/</code>目录中，因此永远不会被加载到任何用户的浏览器中。这段代码在服务器启动的时候会立即运行，然后调用<code>插入</code>功能在数据库的 <code>posts</code> 集合中插入三条简单的帖子。因为我们还没有加入任何数据安全功能，所以无论在服务器还是在客户端运行这个文件都事实上没有区别的。</p>
          
          <p>现在我们用 <code>meteor</code> 命令启动服务，这三条帖子会被装在到数据库中。</p>
          
          <h3>动态数据</h3>
          
          <p>现在如果我们打开一个浏览器的控制台，我们可以看到这三个帖子都被转载到 MiniMongo 中了：</p>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">fetch</span><span class="p">();</span></pre>
          <div class="caption">浏览器控制台</div>
          
          <p>要把这些 post 渲染到 HTML 中，我们需要用模板 helper。</p>
          
          <p>在第三章中，我们看到 Meteor 允许我们把 <em>数据上下文</em> 捆绑到我们的 Spacebars 模板上，从而用 HTML 视图显示这些简单的数据结构。 我们可以同样把我们的集合数据捆绑起来。我们马上就替换掉静态的 <code>postsData</code> Javascript 对象成为一个动态地集合。</p>
          
          <p>现在请随手删掉<code>postsData</code> 代码。下面是 <code>posts_list.js</code> 修改后的样子：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postsList</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">posts</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/posts_list.js</div><div class="lines-highlight" data-lines="2~4" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 4-3</h4><p>把集合连接到 `postsList` 模板上。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter4-3" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter4-3.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <div class="note"><h3>查找与提取</h3>
          
          <p>在 Meteor 中，<code>find()</code> 返回值是一个<em>游标</em>。游标是一种<a href="http://docs.meteor.com/#find">从动数据源</a>。如果你想输出内容，你可以对游标使用 <code>fetch()</code> 来把游标转换成数组。</p>
          
          <p>Meteor 十分智能地在应用中保持游标状态而避免动不动就把游标变成数组。这就造成了你不会经常在 Meteor 代码中看到 <code>fetch()</code> 被调用（基于同样原因，我们在上述例子中也没有使用 fetch ）。</p>
          </div>
          
          <p>现在，与其把帖子们变成静态的数组，不如直接把游标赋给 <code>posts</code> 帮助方法。但是如何做得到呢？如果我们回到浏览器上，我们可以看到：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/4-3.png" alt="使用活数据"><figcaption>使用活数据</figcaption></figure>
          
          <p>我们可以清晰地看到 <code>{{#each}}</code> 帮助方法已经枚举了 <code>Posts</code> 中的所有帖子，而且显示到屏幕上。服务器端的集合从 Mongo 数据库中取出贴子数据，通过网络传到客户端的集合中，进而 handlers 的帮助方法 把这些数据加载到模板中。</p>
          
          <p>现在我们只需要再走一步；让我们通过控制台增加另一个帖子：</p>
          <pre class="highlight javascript"><span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
  <span class="na">title</span><span class="p">:</span> <span class="s1">'Meteor Docs'</span><span class="p">,</span>
  <span class="na">author</span><span class="p">:</span> <span class="s1">'Tom Coleman'</span><span class="p">,</span> 
  <span class="na">url</span><span class="p">:</span> <span class="s1">'http://docs.meteor.com'</span>
<span class="p">});</span></pre>
          <div class="caption">浏览器控制台</div>
          
          <p>再看浏览器 -  你会看到这些：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/4-4.png" alt="通过控制台增加帖子"><figcaption>通过控制台增加帖子</figcaption></figure>
          
          <p>你刚才第一次看到从动功能生效了。当我们告诉 handlebars 去枚举 <code>Posts.find()</code> 游标的时候，它自己知道如何发现游标的变动，从而用最简单的方式将变化后的正确数据显示到屏幕上。</p>
          
          <div class="note"><h3>检查 DOM 变动</h3>
          
          <p>在目前的情况下，最简单的变动应该就是增加一个 <code>&lt;div class="post"&gt;...&lt;/div&gt;</code>。 如果你想看看是否的确如此，你可以打开 DOM 检查器然后选择某个已经存在的帖子的 <code>&lt;div&gt;</code> 。</p>
          
          <p>现在在 Javascript 控制台，插入另外一个帖子。当你回到检查器，会发现一条新的 <code>&lt;div&gt;</code> 对应了新增的那个帖子。同时，原先选中的<em>那个</em>旧的 <code>&lt;div&gt;</code> 仍然存在。这是一种判断元素是否被重新渲染的有效方式。</p>
          </div>
          
          <h3>连接集合: 发布与订阅</h3>
          
          <p>到此为止，我们仍然用着 <code>autopublish</code> 这个包，这个包并不是为正式产品化的应用程序准备的。正如它的名字陈述的那样，它简单地把整个集合分享给所有连接的客户端。这个可不是我们期望的样子，所以让我们去掉它。</p>
          
          <p>打开一个终端窗口，输入：</p>
          <pre class="highlight shell">meteor remove autopublish</pre>
          <p>这个操作有了立即的反应。当你打开浏览器，你会发现所有的帖子都不见了！这是因为我们一直依赖于 <code>autopublish</code> 来让我们的客户端可以镜像般地得到数据库中的所有帖子。</p>
          
          <p>最终我们需要做得到我们仅仅把我们客户端需要看到的帖子传输过来（需要考虑分页的情况）。不过暂时我们可以先设置把 <code>Posts</code> 所有帖子都发布出来。</p>
          
          <p>为达到这个目的，我们建立一个简单的 <code>Publish()</code> 函数，它仅仅返回一个反映所有帖子的游标。</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
<span class="p">});</span></pre>
          <div class="caption">server/publications.js</div>
          
          <p>在客户端我们需要<em>订阅</em>这个发布。我们仅仅需要增加这样一行到 <code>main.js</code> 文件中：</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span></pre>
          <div class="caption">client/main.js</div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 4-4</h4><p>删除 `autopublish` 并建立基本的发布功能</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter4-4" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter4-4.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>如果你现在看一眼浏览器，发现帖子都回来了。哇！好险啊！</p>
          
          <h3>总结</h3>
          
          <p>我们都做了什么？尽管我们还没有用户界面，至少我们已经有了一个能用的应用。我们可以把这个应用部署到网络上，（使用浏览器的控制台）发帖子，并看到帖子显示在其他用户的浏览器上。</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="publications-and-subscriptions">发布与订阅</h2>
            <span class="sidebar-marker">Sidebar</span>
            <span class="chapter-number">4.5</span>
          </div>
          <p>发布（Publication）和订阅（Subscription）是 Meteor 的最基本最重要的概念之一，但是如果你是刚刚开始接触 Meteor 的话，也是有些难度的。</p>
          
          <p>这已经导致不少误解，比如认为 Meteor 是不安全的，或者说 Meteor 应用无法处理大量数据等等。</p>
          
          <p>人们起初会感觉这些概念很迷惑很大程度上是因为 Meteor 像变魔法一样替你做了很多事儿。尽管这些魔法最终看起来很有效，但是它们掩盖了后台真正做的工作（好像魔术一样）。所以让我们剥去魔法的外衣来看看究竟发生了什么。</p>
          
          <h3>过去的日子</h3>
          
          <p>首先，让我们回顾一下2011年之前，当 Meteor 还没有诞生的时候的老日子。比如说我们要建立一个简单的 Rails app。当用户来我们的站点，客户端（举例说浏览器）向我们的服务器端的 app 发送请求。</p>
          
          <p>App 的第一个任务就是搞清楚这个客户请求什么数据。这个可能是搜索结果的第12页、玛丽的用户信息、鲍勃的最新20条微博，等等等等。 你可以想想成为一个书店的伙计在书架之间帮你寻找你要的书。</p>
          
          <p>当正确的数据被找到，这个 App 的下一个任务就是把数据转换成好看的，人类可读的 HTML 格式（对于 API 而言是 JSON 串）。</p>
          
          <p>用书店来举例，那就相当于是把你刚买的书包好，然后装入一个漂亮的袋子。这就是著名的 MVC（模型-视图-控制器）模式中的视图部分。</p>
          
          <p>最终，App 把 HTML 代码送到客户端。这个 App 的任务也就交差了。它可以去买瓶啤酒然后等着下一个请求。</p>
          
          <h3>Meteor 的方式</h3>
          
          <p>让我们看看 Meteor 相对之下是多么的特别。正如我们看到的，Meteor 的关键性创新在于 Rails 程序只跑在<strong>服务器</strong>上，而一个 Meteor App 还包括在<strong>客户端</strong>（浏览器）上运行的客户端组件。</p>
          
          <figure class="diagram pull-right"><img src="DiscoverMeteor_files/client-server2x.png" alt="推送数据库子集到客户端"><figcaption>推送数据库子集到客户端</figcaption></figure>
          
          <p>这就相当于书店的伙计不仅仅在书店里帮你找书，还跟你回家，每天晚上读给你听（这听起来怪怪的）。</p>
          
          <p>这种架构可以让 Meteor 做更多很酷的事情，其中一件主要的就是 Metoer 变得<a href="http://docs.meteor.com/#sevenprinciples">数据库无处不在</a>。简单说，Meteor 把你的数据拿出一部分子集<em>复制到客户端</em>。</p>
          
          <p>这样后两个主要结果：第一，服务器不再发送 HTML 代码到客户端，而是发送<strong>真实的原始数据</strong>，让客户端决定如何处理<a href="http://docs.meteor.com/#sevenprinciples">线传数据</a>。第二，你可以不必等待服务器传回数据，而是<strong>立即访问甚至修改数据</strong>（<a href="http://docs.meteor.com/#sevenprinciples">延迟补偿 latency compensation</a>）。</p>
          
          <h3>发布</h3>
          
          <p>一个 App 的数据库可能用上万条数据，其中一些还可能是私用和保密敏感数据。显而易见我们不能简单地把数据库镜像到客户端去，无论是安全原因还是扩展性原因。</p>
          
          <p>所以我们需要告诉 Meteor 那些数据<strong>子集</strong>是需要送到客户端，我们将用<strong>发布</strong>功能来做这个事儿。</p>
          
          <p>让我们来回到 Microscope。这里是我们 App 数据库中的所有帖子：</p>
          
          <figure class="diagram pull-center"><img src="DiscoverMeteor_files/collections-12x.png" alt="数据库中的所有帖子数据"><figcaption>数据库中的所有帖子数据</figcaption></figure>
          
          <p>尽管实际上不存在但是我们还是假设我们的帖子中有几条因为言语不当被打了特殊标记的。我们需要把他们留在数据库中但是不希望让用户看到（发送去客户端）。</p>
          
          <p>我们第一个任务就是告诉 Meteor 那些数据我们<em>要</em>发送去客户端。我们告诉 Meteor 我们只<strong>发布</strong>没有打标记的帖子。</p>
          
          <figure class="diagram pull-center"><img src="DiscoverMeteor_files/collections-22x.png" alt="排除做过标记的帖子"><figcaption>排除做过标记的帖子</figcaption></figure>
          
          <p>这里是对应的代码，在服务器端代码中。</p>
          <pre class="highlight javascript"><span class="c1">// 在服务器端
</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">flagged</span><span class="p">:</span> <span class="kc">false</span><span class="p">});</span> 
<span class="p">});</span></pre>
          <p>这就保证客户端<strong>无论如何</strong>也无法看到打了标记的帖子了。这就是 Meteor App 如何做到安全性的：保证只发布你让这个当前用户看到的数据。</p>
          
          <div class="note"><h3>DDP</h3>
          
          <p>基本上我们可以把发布/订阅模式想象成为一个漏斗，从服务器端（数据源）过滤数据传送到客户端（目标）。</p>
          
          <p>这个漏斗的专属协议叫做 <strong>DDP</strong>（分布式数据协议 Distributed Data Protocol 的缩写）。如果想了解 DDP 的更多细节，可以通过看 Matt DeBergalis（Meteor 创始人之一）<a href="http://2012.realtimeconf.com/video/matt-debergalis">在 Real-time 大会上的讲演视频</a>，或者来自 Chris Mather 的这个<a href="http://www.eventedmind.com/posts/meteor-subscriptions-and-ddp">截屏视频</a>，来学习关于这个概念更多的细节。</p>
          </div>
          
          <h3>订阅</h3>
          
          <p>就算是我们想把打了标记的帖子也发送给客户端，我们也不能把成千上万的帖子一股脑都发出去。我们需要一个机制让客户端来确定那些子集是他们在某个特别时候特别需要的，这就是<strong>订阅</strong>这个功能的用途。</p>
          
          <p>通过 MiniMongo，客户端 MongoDB 的应用，你订阅的数据会被<strong>镜像</strong>到客户端。 </p>
          
          <p>举个例子，让我们现在浏览一下 Bob Smith 的个人页面，这里只会显示<em>他的</em>帖子。</p>
          
          <figure class="diagram pull-center"><img src="DiscoverMeteor_files/collections-32x.png" alt="订阅 Bob 的帖子镜像到客户端。"><figcaption>订阅 Bob 的帖子镜像到客户端。</figcaption></figure>
          
          <p>首先，我们给发布功能加一个参数：</p>
          <pre class="highlight javascript"><span class="c1">// 在服务器端
</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">author</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">flagged</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">author</span><span class="p">:</span> <span class="nx">author</span><span class="p">});</span>
<span class="p">});</span></pre>
          <p>然后我们在客户端<em>订阅</em>这个发布时定义同一个参数。</p>
          <pre class="highlight javascript"><span class="c1">// 在客户端
</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="s1">'bob-smith'</span><span class="p">);</span></pre>
          <p>这就是我们让 Meteor 程序在客户端能够具有可伸缩性：不去订阅<em>全部</em>数据，而是指选择你现在需要的数据去订阅。这样的话，你就可以避免消耗大量的客户端内存，无论服务器端的总数据量有多大。</p>
          
          <h3>查找</h3>
          
          <p>现在 Bob 的帖子恰巧涵盖了多个类别（比如：“JavaScript”、“Ruby”和“Python”）。也许我们仍然需要把 Bob 的所有帖子都装入内存，但是我们现在只想显示属于“JavaScript”类别的帖子。这就是“查找”的用途。</p>
          
          <figure class="diagram pull-center"><img src="DiscoverMeteor_files/collections-42x.png" alt="在客户端选择一个数据子集。"><figcaption>在客户端选择一个数据子集。</figcaption></figure>
          
          <p>正如我们在服务器上做的一样，我们用了 <code>Posts.find()</code> 函数来选择数据的子集：</p>
          <pre class="highlight javascript"><span class="c1">// 在客户端
</span><span class="nx">Template</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">posts</span><span class="p">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">author</span><span class="p">:</span> <span class="s1">'bob-smith'</span><span class="p">,</span> <span class="na">category</span><span class="p">:</span> <span class="s1">'JavaScript'</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <p>现在我们应该明白订阅和发布机制了，让我们在深入了解一些常见的应用模式。</p>
          
          <h3>自动发布（Autopublish）</h3>
          
          <p>如果你从头开始建立一个 Meteor 项目（比如，使用 <code>meteor create</code> 命令)，系统会自动包含并启用一个叫做 <code>autopublish</code> 的包。让我们说说这个包是干什么的。</p>
          
          <p><code>autopublish</code> 的目的是让 Meteor 应用有个简单的起步阶段，它简单地直接把服务器上的<em>全部数据</em>镜像到客户端，因此你就不用管发布和订阅了。</p>
          
          <figure class="diagram pull-center"><img src="DiscoverMeteor_files/autopublish2x.png" alt="自动发布"><figcaption>自动发布</figcaption></figure>
          
          <p>那么这究竟是如何工作的呢？假设在服务器端我们有一个集合叫做 <code>posts</code>。自动发布包就会自动地把 Mongo 数据库中这个集合的所有的数据（帖子）发送到客户端的名为 <code>‘posts’</code> 的集合中（假设客户端的确有这样一个集合）。</p>
          
          <p>因此，如果你使用自动发布，你就不需要考虑发布。数据一致，而且事情变得十分简单。当然，这样的话会有一个明显的问题，就是你的所有数据都被缓存到所有用户的电脑中。</p>
          
          <p>基于这个原因，自动发布只在你起步阶段且还未考虑发布之前时使用。</p>
          
          <h3>发布全部集合</h3>
          
          <p>一旦你删除掉 <code>autopublish</code> 这个包，你马上就会发现在浏览器上没有数据了。一个简单的解决方法就是重复自动发布所做的工作， 那就是发布所有数据。比如：</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'allPosts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
<span class="p">});</span></pre>
          <figure class="diagram pull-center"><img src="DiscoverMeteor_files/fullcollection2x.png" alt="发布所有集合"><figcaption>发布所有集合</figcaption></figure>
          
          <p>我们还是发布了所有集合，但是至少我们现在可以自己控制哪个集合我们发布哪个不发布。比如现在这个例子，我们发布了 <code>Posts</code> 集合但是并没有发布 <code>Comments</code>。</p>
          
          <h3>发布部分集合</h3>
          
          <p>下一步我们要做的是发布集合中的<em>部分</em>记录。比如我们只发布来自于某个作者的帖子：</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'somePosts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s1">'author'</span><span class="err">:</span> <span class="s1">'Tom'</span><span class="p">});</span>
<span class="p">});</span></pre>
          <figure class="diagram pull-center"><img src="DiscoverMeteor_files/partialcollection2x.png" alt="发布集合的一部分"><figcaption>发布集合的一部分</figcaption></figure>
          
          <div class="note"><h3>幕后真相</h3>
          
          <p>如果你已经阅读了 <a href="http://docs.meteor.com/#publishandsubscribe">Meteor 发布文档</a>，你可能被诸如 <code>added()</code> 和 <code>ready()</code> 之类的用来设置客户端记录属性的函数搞晕了，而且还纠结于似乎我们从来没有使用过这些方法。</p>
          
          <p>原因在于 Meteor 提供了十分重要的简化：<code>_publishCursor()</code> 方法。你也没有看到我们用这个方法对吧？也许我们没有直接用，但是如果你在发布函数中返回了一个<a href="http://zh.discovermeteor.com/chapter/meteor-vocabulary/">游标</a>（比如，<code>Posts.find({'author':'Tom'})</code>），那个就是 Meteor 使用这个方法的时候。</p>
          
          <p>当 Meteor 看到 <code>somePosts</code> 发布函数返回了一个游标，它会调用 <code>_publishCursor()</code> 去 —— 你猜猜看 —— 自动发布这个游标。</p>
          
          <p>下面就是 <code>_publishCursor()</code> 做的工作：</p>
          
          <ul>
          <li>它检查服务器端的集合的名称</li>
          <li>它从游标中找到所有的符合要求的文档，然后发送到客户端的<em>同名</em>集合中。（它使用了<code>.added()</code> 函数来完成的）</li>
          <li>当新的文档加入集合了，或者删除或者改变了，它会把这些改动发送到客户端的集合。（它使用 <code>.observe()</code> 来监控游标，使用 <code>.added()</code>, <code>.changed()</code> 和 <code>removed()</code> 来增删改）。</li>
          </ul>
          
          <p>所以在上述的例子中，我们可以保证用户只会在客户端缓存中得到他们感兴趣的帖子（在这里例子中是 Tom 发的帖子）。</p>
          </div>
          
          <h3>发布部分字段</h3>
          
          <p>我们已经看到如何发布部分帖子，但是我们还需要再精简！让我们看看如何只发布指定的部分<em>字段</em>。</p>
          
          <p>如同以前我们使用 <code>find()</code> 返回一个游标，现在我们来去掉一些字段。</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'allPosts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="na">fields</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">date</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">}});</span>
<span class="p">});</span></pre>
          <figure class="diagram pull-center"><img src="DiscoverMeteor_files/partialproperties2x.png" alt="发布部分字段"><figcaption>发布部分字段</figcaption></figure>
          
          <p>实际上，我们可以同时使用上述两种技术，只发布作者是 Tom 的帖子，并且隐藏 date 日期字段:</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'allPosts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s1">'author'</span><span class="err">:</span> <span class="s1">'Tom'</span><span class="p">},</span> <span class="p">{</span><span class="na">fields</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">date</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">}});</span>
<span class="p">});</span></pre>
          <h3>总结</h3>
          
          <p>我们已经从发布所有集合的所有文档的所有字段（通过 <code>autopublish</code>），到发布<em>个别</em>集合的<em>个别</em>文档的<em>个别</em>字段。</p>
          
          <p>这已经覆盖了 Meteor 的发布的基本内容，而且这些基本技巧已经足够涵盖大部分的用例了。</p>
          
          <p>有时，你需要进一步来组合、连接或融合发布。我们在以后的章节中讲到这些内容！</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="routing">路由</h2>
            <span class="chapter-number">5</span>
          </div>
          <p>现在，我们已经创建了一个帖子列表页面（最终是由用户提交的），我们还需要添加一个单独的帖子页面，提供给用户评论对应的帖子。</p>
          
          <p>我们希望可以通过<strong>固定链接</strong>访问到每个单独的帖子页面，URL 形式是 <code>http://myapp.com/posts/xyz</code>（这里的 <code>xyz</code> 是 MongoDB 的 <code>_id</code> 标识符），对于每个帖子来说是唯一的。</p>
          
          <p>这意味着我们需要某些<strong>路由</strong>来看看浏览器的地址栏里面的路径是什么，并相应地显示正确的内容。</p>
          
          <h3>添加 Iron Router 包</h3>
          
          <p><a href="https://github.com/EventedMind/iron-router">Iron Router</a> 是特别为了 Meteor Apps 开发的路由包。</p>
          
          <p>它不仅能帮助路由（设置路径），还能帮助过滤（为这些路径分配跳转），甚至能管理订阅（控制路径可以访问哪些数据）。（注意：Iron Router 是由本书<em>《Discover Meteor》</em>的其中一名作者 Tom Coleman 参与开发的。)</p>
          
          <p>首先，让我们从 Atmosphere 中安装这个包：</p>
          <pre class="highlight shell">meteor add iron:router</pre>
          <div class="caption">Terminal 终端</div>
          
          <p>这个命令是下载并安装 Iron Router 包到我们的 App，这样我们就可以使用了。请注意，在能够顺利使用这个包之前，你可能需要重启你的 Meteor 应用（通过按 <code>ctrl + c</code> 就能停止进程，然后输入 <code>meteor</code> 再次启动它）。</p>
          
          <div class="note"><h3>路由器的词汇</h3>
          
          <p>在本章我们会接触很多路由器的不同功能。如果你对类似 Rails 的框架有一定实践经验的话，你可能已经很熟悉大部分的这些词汇概念了。但是如果没有的话，这里有一个快速词汇表让你来了解一下：</p>
          
          <ul>
          <li><strong>路由规则（Route）</strong>：路由规则是路由的基本元素。它的工作就是当用户访问 App 的某个 URL 的时候，告诉 App 应该做什么，返回什么东西。 </li>
          <li><strong>路径（Path）</strong>：路径是访问 App 的 URL。它可以是静态的（<code>/terms_of_service</code>）或者动态的（<code>/posts/xyz</code>），甚至还可以包含查询参数（<code>/search?keyword=meteor</code>）。</li>
          <li><strong>目录（Segment）</strong>：路径的一部分，使用正斜杠（<code>/</code>）进行分隔。</li>
          <li><strong>Hooks</strong>：Hooks 是可以执行在路由之前，之后，甚至是路由正在进行的时候。一个典型的例子是，在显示一个页面之前检测用户是否拥有这个权限。</li>
          <li><strong>过滤器（Filter）</strong>：过滤器类似于 Hooks ，为一个或者多个路由规则定义的全局过滤器。</li>
          <li><strong>路由模板（Route Template）</strong>：每个路由规则指向的 Meteor 模板。如果你不指定，路由器将会默认去寻找一个具有相同名称的模板。</li>
          <li><strong>布局（Layout）</strong>：你可以想象成一个数码相框的布局。它们包含所有的 HTML 代码放置在当前的模板中，即使模板发生改变它们也不会变。</li>
          <li><strong>控制器（Controller）</strong>：有时候，你会发现很多你的模板都在重复使用一些参数。为了不重复你的代码，你可以让这些路由规则继承一个<strong>路由控制器（Routing Controller）</strong>去包含所有的路由逻辑。</li>
          </ul>
          
          <p>关于更多 Iron Router 的信息，请查看  <a href="https://github.com/EventedMind/iron-router">GitHub上面的完整文档</a>. </p>
          </div>
          
          <h3>路由：把 URL 映射到模板</h3>
          
          <p>到目前为止，我们已经使用了一些固定模板（比如 <code>{{&gt; postsList}}</code>）来为我们布局。因此，尽管我们 App 的内容还可以更改，但是页面的基本结构都已经不变了：一个头（header），它下面是帖子列表。</p>
          
          <p>Iron Router 负责处理在 HTML <code>&lt;body&gt;</code> 标签里面该呈现什么，让我们摆脱了这个枷锁。所以我们不会再自己去定义标签里面的内容，取而代之的是，我们将路由器指定到一个包含 <code>{{&gt; yield}}</code> 标签的布局模板。</p>
          
          <p>这个 <code>{{&gt; yield}}</code> 标签将会定义一个动态区域，它会自动呈现对应于当前线路的相应模板（从现在起，我们将指定这个特殊的模板叫 “route templates”）：</p>
          
          <figure class="diagram pull-center"><img src="DiscoverMeteor_files/router-diagram2x.png" alt="布局和模板。"><figcaption>布局和模板。</figcaption></figure>
          
          <p>我们将开始构建我们的布局和添加 <code>{{&gt; yield}}</code> 标签。首先，我们先从 <code>main.html</code> 文件里面删除 <code>&lt;body&gt;</code> 标签，并把它的内容放到它们共同的模板 <code>layout.html</code> 里面（保存在新的 <code>client/templates/application</code> 文件夹中）。</p>
          
          <p>我们把 <code>main.html</code> 删减内容之后应该是这样的：</p>
          <pre class="highlight html"><span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>Microscope<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span></pre>
          <div class="caption">client/main.html</div>
          
          <p>而新创建的 <code>layout.html</code> 现在将会包含 App 的外层布局：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"layout"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-default"</span> <span class="na">role=</span><span class="s">"navigation"</span><span class="nt">&gt;</span> 
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>Microscope<span class="nt">&lt;/a&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main"</span> <span class="na">class=</span><span class="s">"row-fluid"</span><span class="nt">&gt;</span>
      {{&gt; yield}}
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/application/layout.html</div>
          
          <p>你会注意到我们已经把 <code>yield</code> helper 取代了 <code>postsList</code> 模板。</p>
          
          <p>完成之后，我们浏览器标签中的内容会消失，浏览器控制台会显示一个错误。这是因为我们还没有告诉路由怎样处理 <code>/</code> URL，所以它仅仅呈现一个空的模板。</p>
          
          <p>接下来，我们可以恢复之前的根路径 <code>/</code> URL 映射到 <code>postsList</code> 模板。然后我们在根目录创建一个 <code>/lib</code> 目录，并在里面创建 <code>router.js</code> 文件：</p>
          <pre class="highlight javascript"><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
  <span class="na">layoutTemplate</span><span class="p">:</span> <span class="s1">'layout'</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">});</span></pre>
          <div class="caption">lib/router.js</div>
          
          <p>我们已经完成了两件重要的事情。第一，我们已经告诉路由器使用我们刚刚创建的 <code>layout</code> 模板作为所有路由的默认布局。</p>
          
          <p>第二，我们已经定义了一个名为 <code>postsList</code> 的路由规则，并映射到 <code>/</code> 路径。</p>
          
          <div class="note"><h3><code>/lib</code> 文件夹</h3>
          
          <p>你放在 <code>/lib</code> 文件夹里面的所有文件都会在你的 App 运行的时候确保首先被加载（可能除了 smart 包）。这是放置需要随时准备使用的辅助代码的好地方。</p>
          
          <p>不过有一点注意的是：因为 <code>/lib</code> 文件夹并不是放在 <code>/client</code> 或 <code>/server</code> 文件夹里面，这意味着它的代码将会同时存在于客户端和服务器。</p>
          </div>
          
          <h3>路由规则的名字</h3>
          
          <p>在这里我们先清除一些歧义。我们有一个路由规则，叫做叫 <code>postsList</code> ，同时我们也有一个名字叫 <code>postsList</code> 的<strong>模板</strong>。这里是怎么回事？</p>
          
          <p>默认情况下，Iron Router 会为这个路由规则，指定相同名字的模板。而如果路径（<code>path</code> 参数）没有指定，它也会根据路由规则的名字，去指定同样名字的<strong>路径</strong>。举个例子，在上面的设置中，如果我们不提供 <code>path</code> 参数，那么访问 <code>/postsList</code> 将会自动获取到 <code>postList</code> 模板。</p>
          
          <p>你可能想知道为什么我们需要在一开始去制定路由规则。这是因为 Iron Router 的部分功能需要使用路由规则去生成 App 的链接信息。其中最常见的一个是 <code>{{pathFor}}</code> 的 Spacebars helper，它需要返回路由规则的 URL 路径。</p>
          
          <p>我们希望主页链接到帖子列表页面，所以除了指定静态的 <code>/</code> URL ，我们还可以使用 Spacebars helper。虽然它们的效果是一样的，不过这给了我们更多的灵活性，如果我们更改了路由规则的映射路径，helper 仍然可以输出正确的 URL 。</p>
          <pre class="highlight html"><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-default"</span> <span class="na">role=</span><span class="s">"navigation"</span><span class="nt">&gt;</span> 
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"{{pathFor 'postsList'}}"</span><span class="nt">&gt;</span>Microscope<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>

//...</pre>
          <div class="caption">client/templates/application/layout.html</div><div class="lines-highlight" data-lines="3" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 5-1</h4><p>非常基本的路由。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter5-1" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter5-1.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <h3>等待数据</h3>
          
          <p>如果你要部署当前版本的 App（或启动起来去使用上面的链接），你会注意到在所有帖子完全出现之前，列表里面会空了一段时间。这是因为在第一次加载页面的时候，要等到 <code>posts</code> 订阅完成后，即从服务器抓取完帖子的数据，才能有帖子显示在页面上。</p>
          
          <p>这应该要有一个更好的用户体验，比如提供一些视觉上的反馈让用户知道正在读取数据，这样用户才会去继续等待。</p>
          
          <p>幸好 Iron Router 给了我们一个简单的方法去实现它。我们把订阅放到 <code>waitOn</code> 的返回上。</p>
          
          <p>我们把 <code>posts</code> 订阅从 <code>main.js</code> 移到路由文件中：</p>
          <pre class="highlight javascript"><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
  <span class="na">layoutTemplate</span><span class="p">:</span> <span class="s1">'layout'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">});</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="3" data-class="added"></div>
          
          <p>我们这里所谈论的是对于网站的<em>每个</em>路由（我们现在只有一个，但是我们马上会添加更多！）我们都订阅了 <code>posts</code> 订阅。</p>
          
          <p>这和我们之前做的（订阅原来被放在了 <code>main.js</code> 文件中，这文件现在应该是空的了，可以删除）关键区别在于 Iron Router 现在可以得知路由什么时候准备好——即当路由得到它需要渲染的数据时。</p>
          
          <h3>Get A Load Of This</h3>
          
          <p>如果我们只是显示一个空的模板的话，得知 <code>postsList</code> 路由已准备好也做不了什么事情。幸好 Iron Router 自带了一个延缓显示模板的方法，在路由调用模板准备好前，显示一个 <code>loding</code> 加载模板：</p>
          <pre class="highlight javascript"><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
  <span class="na">layoutTemplate</span><span class="p">:</span> <span class="s1">'layout'</span><span class="p">,</span>
  <span class="na">loadingTemplate</span><span class="p">:</span> <span class="s1">'loading'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">});</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="3,4" data-class="added"></div>
          
          <p>注意，因为我们在路由器级别上全局定义了 <code>waitOn</code> 方法，所以这个只会在用户第一次访问你的 App 的时候发生一次。在那之后，数据已经被加载到了浏览器的内存，路由器不需要再次去等待它。</p>
          
          <p>最后一块拼图是加载模板。我们将会使用 <code>spin</code> 包去创建一个帅气的动画加载画面。通过 <code>meteor add sacha:spin</code> 去添加它，然后在 <code>client/templates/includes</code> 文件夹内创建 <code>loading</code> 模板：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"loading"</span><span class="nt">&gt;</span>
  {{&gt;spinner}}
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/includes/loading.html</div>
          
          <p>注意 <code>{{&gt; spinner}}</code> 是 <code>spin</code> 包中的一个模板标签。尽管这部分是来自我们的 App 之外，不过我们就像其他模板一样去使用它就可以了。</p>
          
          <p>这是一个好办法去等待你的订阅，不仅为了用户体验，还因为它可以顺利地确保数据可以马上体现在模板上。这消除了需要处理的模板被呈现之前，底层数据必须可用的问题，这往往需要复杂的解决方案。</p>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 5-2</h4><p>等待帖子的订阅。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter5-2" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter5-2.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <div class="note"><h3>第一次接触响应性</h3>
          
          <p>响应性是 Meteor 的一个核心部分，虽然我们没有真正的接触到，但我们的加载模板给了我们去接触这个概念的机会。</p>
          
          <p>如果数据还没有加载完成的时候重定向去一个加载模板是很好，不过路由器如何知道在什么时候数据加载完，然后用户应该要重定向回到原本的页面呢？</p>
          
          <p>刚刚我们说的这个就是响应性的体现，不过别担心，很快你会了解到关于它的更多东西。</p>
          </div>
          
          <h3>路由到一个特定的帖子</h3>
          
          <p>既然我们已经看到了如何路由到 <code>postsList</code> 模板上，现在让我们建立一个路由来显示一个帖子的详细信息吧。</p>
          
          <p>这里有一个问题：我们不能继续单独定义路由规则与路径的映射，因为可能有成千上万个。所以我们需要建立一个<strong>动态</strong>的路由规则，并让路由规则去显示我们要查看的帖子。</p>
          
          <p>首先，我们将创建一个新的模板，简单地呈现相同的我们使用在帖子列表的模板。</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postPage"</span><span class="nt">&gt;</span>
  {{&gt; postItem}}
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/post_page.html</div>
          
          <p>我们以后还会添加更多的元素在这个模板上（如注释），但现在它将仅仅作为放置 <code>{{&gt; postItem}}</code> 的外壳。</p>
          
          <p>我们准备创建另一个路由规则，这次 URL 路径 <code>/posts/&lt;ID&gt;</code> 映射到 <code>postPage</code> 模板:</p>
          <pre class="highlight javascript"><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
  <span class="na">layoutTemplate</span><span class="p">:</span> <span class="s1">'layout'</span><span class="p">,</span>
  <span class="na">loadingTemplate</span><span class="p">:</span> <span class="s1">'loading'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">});</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/posts/:_id'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postPage'</span>
<span class="p">});</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="8~10" data-class="added"></div>
          
          <p>这个特殊的 <code>:_id</code> 标记告诉路由器两件事：第一，去匹配任何符合 <code>/posts/xyz/</code>（“xyz”可以是任意字符）格式的路线。第二，无论“xyz”里面是什么，都会把它放到路由器的 <code>params</code> 数组中的 <code>_id</code> 属性里面去。</p>
          
          <p>请注意，我们这里只使用 <code>_id</code> 只是为了方便起见。路由器是没有办法知道你是通过一个实际的 <code>_id</code> ，还是仅仅通过一些随机的字符去访问。</p>
          
          <p>我们现在路由到正确的模板了，但是我们仍然漏了一个事情：路由器通过这个帖子的 <code>_id</code> 可以知道我们想显示哪个帖子，但模板还没有线索。那么，我们要如果解决这个问题呢？</p>
          
          <p>值得庆幸的是，路由器有一个聪明的内置解决方案：它允许你指定一个<strong>数据源</strong>。你可以把数据源想象成填充的一个美味的蛋糕去填充模板和布局。简单的说，就是你的模板要填上：</p>
          
          <figure class="diagram pull-center"><img src="DiscoverMeteor_files/router-diagram-22x.png" alt="The data context."><figcaption>The data context.</figcaption></figure>
          
          <p>在我们的例子中，我们可以从 URL 上获取 <code>_id</code> ，并通过它找到我们的帖子从而获得正确的数据源：</p>
          <pre class="highlight javascript"><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
  <span class="na">layoutTemplate</span><span class="p">:</span> <span class="s1">'layout'</span><span class="p">,</span>
  <span class="na">loadingTemplate</span><span class="p">:</span> <span class="s1">'loading'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">});</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/posts/:_id'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postPage'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="10" data-class="added"></div>
          
          <p>所以每次用户访问这条路由规则，我们会找到合适的帖子并将其传递给模板。记住，<code>findOne</code> 返回的是一个与查询相匹配的帖子，而仅仅需要提供一个 <code>id</code> 作为参数，它可以简写成 <code>{_id: id}</code> 。</p>
          
          <p>在路由规则的 <code>data</code> 方法里面，<code>this</code> 对应于当前匹配的路由对象，我们可以使用 <code>this.params</code> 去访问一个比配项（在 <code>path</code> 中通过 <code>:</code> 前缀去表示它们）。</p>
          
          <div class="note"><h3>更多关于数据源</h3>
          
          <p>通过设置模板的<strong>数据源</strong>，你可以在模板 helper 里面控制 <code>this</code> 的值。</p>
          
          <p>这个工作通常会隐式地被 <code>{{#each}}</code> 迭代器完成，它会自动设置对应的数据源到每个正在迭代的当前项中：</p>
          
          <pre><code class="html">{{#each widgets}}
  {{&gt; widgetItem}}
{{/each}}
</code></pre>
          
          <p>当然我们也可以使用 {{#with}} 去显式地操作，它就像简单地说“拿这个对象，提供给下面的模板应用”。例如，我们可以这样写：</p>
          
          <pre><code class="html">{{#with myWidget}}
  {{&gt; widgetPage}}
{{/with}}
</code></pre>
          
          <p>因此通过传递数据源作为<strong>参数</strong>给模板调用也可以实现相同的效果，所以前面的代码块可以重写为：</p>
          
          <pre><code class="js">{{&gt; widgetPage myWidget}}
</code></pre>
          
          <p>想深入了解数据源，建议<a href="https://www.discovermeteor.com/blog/a-guide-to-meteor-templates-data-contexts/">阅读我们的博客帖子</a>。</p>
          </div>
          
          <h3>使用动态的路由 Helper</h3>
          
          <p>最后，我们 要创建一个新的“评论”按钮，并指向正确的帖子页面。我们可以做一些像 <code>&lt;a href="/posts/{{_id}}"&gt;</code> 这种动态模式，不过使用路由 Helper 会更可靠一点。</p>
          
          <p>我们已经把帖子路由规则命名为 <code>postPage</code> ，所以我们可以使用 <code>{{pathFor 'postPage'}}</code> helper ：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postItem"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"post-content"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{url}}"</span><span class="nt">&gt;</span>{{title}}<span class="nt">&lt;/a&gt;&lt;span&gt;</span>{{domain}}<span class="nt">&lt;/span&gt;&lt;/h3&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postPage'}}"</span> <span class="na">class=</span><span class="s">"discuss btn btn-default"</span><span class="nt">&gt;</span>Discuss<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/post_item.html</div><div class="lines-highlight" data-lines="6" data-class="added"></div><div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 5-3</h4><p>路由到一个单独的帖子页面。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter5-3" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter5-3.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>不过等等，路由器到底如何准确地知道从 <code>/posts/xyz</code> 中的哪个位置去获得 <code>xyz</code> 路径？毕竟，我们没有传递任何的 <code>_id</code> 给它。</p>
          
          <p>事实证明，Iron Router 是足够聪明地自己去发现它。我们告诉路由器使用 <code>postPage</code> 路由规则，而路由器知道这条规则的某些地方需要使用 <code>_id</code>（因为这是我们定义 <code>path</code> 的办法）。</p>
          
          <p>因此，路由器将会在 <code>{{pathFor 'postPage'}}</code> 的上下文环境（即 <code>this</code> 对象）中寻找这个 <code>_id</code>。而在这个例子中，<code>this</code> 对象对应着一个帖子，它就是我们要寻找的拥有 <code>_id</code> 属性的地方。</p>
          
          <p>又或者，你可以通过传递 Helper 的第二个参数，来明确指定需要找的 <code>_id</code> 在哪里。例如，<code>{{pathFor 'postPage' someOtherPost}}</code>。实际情况下，如果要获取帖子列表中前一个或者后一个的链接，我们就会使用这种模式。</p>
          
          <p>为了看看它是否已经正常运作，我们去浏览帖子列表页面并点击其中一个“Discuss”的链接。你应该看到类似这样的：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/5-2.png" alt="一个单独的帖子页面。"><figcaption>一个单独的帖子页面。</figcaption></figure>
          
          <div class="note"><h3>HTML5 pushState</h3>
          
          <p>这里我们需要知道的是，这些 URL 变化的产生原因是正在使用 <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/API/DOM/Manipulating_the_browser_history?redirectlocale=en-US&amp;redirectslug=Web%2FGuide%2FDOM%2FManipulating_the_browser_history">HTML5 pushState</a>. </p>
          
          <p>路由器通过处理 URLs 的点击去访问网站的内部，这样可以防止浏览器跳出我们的 App ，而不只是为了必要的改变 App 的状态。</p>
          
          <p>如果一切运作正常的话，页面应该会瞬间改变。事实上，有时候事情变化得过快，可能需要某种类型的过渡页面。这是本章的范围之外的，但却是一个有趣的话题。</p>
          </div>
          
          <h3>帖子无法找到</h3>
          
          <p>让我们别忘了路由工作两种方式：改变我们访问的页面 URL，也能显示我们改变 <em>URL</em> 的新页面。所以我们需要解决当某用户输入<em>错误的</em> URL 时的情况。</p>
          
          <p>幸好，Iron Rounter 可以通过 <code>notFoundTemplate</code> 选项来为我们解决这个问题。</p>
          
          <p>首先，我们设置一个新模板来显示简单的 404 错误 信息：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"notFound"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"not-found jumbotron"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span>404<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;p&gt;</span>Sorry, we couldn't find a page at this address. 抱歉，我们无法找到该页面。<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/application/not_found.html</div>
          
          <p>然后，我们将 Iron Rounter 指向这个模板：</p>
          <pre class="highlight javascript"><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
  <span class="na">layoutTemplate</span><span class="p">:</span> <span class="s1">'layout'</span><span class="p">,</span>
  <span class="na">loadingTemplate</span><span class="p">:</span> <span class="s1">'loading'</span><span class="p">,</span>
  <span class="na">notFoundTemplate</span><span class="p">:</span> <span class="s1">'notFound'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="4" data-class="added"></div>
          
          <p>为了验证这个错误页面，你可以尝试随机输入 URL 像 <code>http://localhost:3000/nothing-here</code>。</p>
          
          <p>但是稍等，如果有人输入了像 <code>http://localhost:3000/posts/xyz</code> 这种格式的 URL，<code>xyz</code> <em>不是</em>一个合法的帖子 <code>_id</code> 怎么办？虽然是合法的路由，但是没有指向任何数据。</p>
          
          <p>幸好，如果我们在 <code>route.js</code> 结尾添加了特别的 <code>dataNotFound</code> hook，Iron Rounter 就能足够智能地解决这个问题。</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">onBeforeAction</span><span class="p">(</span><span class="s1">'dataNotFound'</span><span class="p">,</span> <span class="p">{</span><span class="na">only</span><span class="p">:</span> <span class="s1">'postPage'</span><span class="p">});</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="4" data-class="added"></div>
          
          <p>这会告诉 Iron Router 不仅在非法路由情况下，而且在 <code>postPage</code> 路由，每当 <code>data</code> 函数返回“falsy”（比如 <code>null</code>、<code>false</code>、<code>undefined</code> 或 空）对象时，显示“无法找到”的页面。</p>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 5-4</h4><p>添加了页面无法找到的模板。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter5-4" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter5-4.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <div class="note"><h3>为什么叫 “Iron”?</h3>
          
          <p>你也许会想知道命名“Iron Router”背后的故事。根据 Iron Router 的作者 Chris Mather，因为流星（meteor）主要由铁（iron）元素构成的事实。</p>
          </div>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="the-session">会话（Session）</h2>
            <span class="sidebar-marker">Sidebar</span>
            <span class="chapter-number">5.5</span>
          </div>
          <p>Meteor 是一个响应式框架。这意味着随着数据的变化， App 的改变并不需要你显式地做任何事情。</p>
          
          <p>事实上，我们已经看到过我们的模板是如何根据数据和路由规则的变化去进行改变的。</p>
          
          <p>我们将在后面的章节去深入了解这里面是如何工作的，但我们现在想介绍一些基本的响应性功能，它对于普通的 App 是非常有用的。</p>
          
          <h3>Meteor 的会话（Session）</h3>
          
          <p>现在在 Microscope 下，用户在 App 中的当前状态是完全包含在 URL 里面，并且需要从 URL （或者数据库）里面寻找。</p>
          
          <p>但是在许多情况下，你需要存储一些只对应于当前用户的应用程序版本的短暂状态（例如，一个元素是否显示或隐藏）。利用 Session 可以很方便地去做到这一点。</p>
          
          <p>Session 是一个全局的响应式数据存储。它全局性的意思是全局的单例对象：这个 Session 对象在全局都是可被访问到。全局变量通常被认为不是一件什么好事，不过在刚才的例子上，Session 可以作为中央通信总线用于项目的不同地方。</p>
          
          <h3>修改会话（Session）</h3>
          
          <p>会话 <code>Session</code> 是全局可访问的。设置一个 Session 的值，你可以调用：</p>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'pageTitle'</span><span class="p">,</span> <span class="s1">'A different title'</span><span class="p">);</span></pre>
          <div class="caption">浏览器控制台（Browser console）</div>
          
          <p>通过 <code>Session.get('mySessionProperty');</code> 你可以重新读取数据的内容，这是一个响应式的数据源，这意味着如果你把它放在一个 Helper 里面，你会看到 Helper 根据 Session 变量的改变而响应式地改变它的输出。</p>
          
          <p>让我们试一试，将下面的代码添加到布局模板：</p>
          <pre class="highlight html"><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"navbar navbar-default"</span> <span class="na">role=</span><span class="s">"navigation"</span><span class="nt">&gt;</span> 
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"{{pathFor 'postsList'}}"</span><span class="nt">&gt;</span>{{pageTitle}}<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span></pre>
          <div class="caption">client/templates/application/layout.html</div>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">pageTitle</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'pageTitle'</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/application/layout.js</div>
          
          <div class="note"><h3>关于附录（Sidebar）的代码</h3>
          
          <p>请注意在附录章节中的代码并不是本书主流程的一部分。所以要么创建一个新分支（如果你使用 Git），要么确保在本章结束后恢复你所做的改动。</p>
          </div>
          
          <p>Meteor 的自动重载（即使用后面讲到的“动态代码重载技术”（HCR）的页面自动刷新）会保存 Session 的变量，所以我们现在应该看到“不同的标题”显示在导航栏中。如果不是，再次输入之前的 <code>Session.set()</code> 命令。</p>
          
          <p>另外，如果我们去更改它的值（再次在浏览器控制台中），我们应该看到另一个标题显示：</p>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'pageTitle'</span><span class="p">,</span> <span class="s1">'A brand new title'</span><span class="p">);</span></pre>
          <div class="caption">Browser console</div>
          
          <p>由于 Session 的全局可访问性，所以这些变化可以作用到应用程序的任何地方。这给了我们很大的权力，但如果使用太多也可以是一个陷阱。</p>
          
          <p>另外，重点指出的是 Session 对象<em>不在</em>用户之间共享，甚至在浏览器标签之间。这就是为什么如果现在你在新浏览器标签打开你的应用，你会看到一个空网站标题。</p>
          
          <div class="note"><h3>相同的变化</h3>
          
          <p>如果你通过 <code>Session.set()</code> 去修改一个 Session 变量，并将其修改为相同的值，Meteor 会非常聪明的绕过繁琐的操作，避免不必要的方法调用。</p>
          </div>
          
          <h3>自动运行（Autorun）</h3>
          
          <p>我们看到响应式数据源的一个例子，并且看到了它在一个模板 Helper 里面的运作。尽管某些情况下 Meteor（如模板 Helper）是响应式的，但是大部分的 Meteor App 仍然是基于普通的非响应式的 JavaScript 代码。</p>
          
          <p>让我们假设有以下的代码片段在我们的 App：</p>
          <pre class="highlight javascript"><span class="nx">helloWorld</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'message'</span><span class="p">));</span>
<span class="p">}</span></pre>
          <p>尽管我们调用一个响应式会话（Session）变量，但它并不是在响应式的<em>上下文</em>中调用，所以当改变这个 Session 变量的时候，我们也不会自动运行 <code>alert</code> 函数。</p>
          
          <p>这个时候，就要引入<a href="http://docs.meteor.com/#Tracker_autorun">自动运行（Autorun）</a>机制了。顾名思义，每一次 <code>autorun</code> 上下文中的响应式数据源发生变化的时候，<code>autorun</code> 函数就会自动运行。</p>
          
          <p>尝试到浏览器控制台输入：</p>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Tracker</span><span class="p">.</span><span class="nx">autorun</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Value is: '</span> <span class="o">+</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'pageTitle'</span><span class="p">));</span> <span class="p">}</span> <span class="p">);</span>
<span class="nx">Value</span> <span class="nx">is</span><span class="err">:</span> <span class="nx">A</span> <span class="nx">brand</span> <span class="k">new</span> <span class="nx">title</span></pre>
          <div class="caption">浏览器控制台（Browser console）</div>
          
          <p>如你所料，放在 <code>autorun</code> 函数里面的代码将会运行一次，把数据输出到控制台。现在，让我们尝试去改变标题：</p>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'pageTitle'</span><span class="p">,</span> <span class="s1">'Yet another value'</span><span class="p">);</span>
<span class="nx">Value</span> <span class="nx">is</span><span class="err">:</span> <span class="nx">Yet</span> <span class="nx">another</span> <span class="nx">value</span></pre>
          <div class="caption">浏览器控制台（Browser console）</div>
          
          <p>神奇吧！随着 Session 变量的改变， <code>autorun</code> 知道它必须重新运行自己的代码，并把新的值重新输出到控制台。</p>
          
          <p>所以我们回到之前的例子，如果希望每次 Session 变量发生变化的时候引发新的警报（<code>alert</code>），我们需要做的就是将我们的代码封装在 <code>autorun</code> 函数里面：</p>
          <pre class="highlight javascript"><span class="nx">Tracker</span><span class="p">.</span><span class="nx">autorun</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'message'</span><span class="p">));</span>
<span class="p">});</span></pre>
          <p>正如我们前面看到的，<code>autorun</code> 会自动跟踪响应式数据源，在它们变化的时候作出响应的反应。</p>
          
          <h3>动态代码重载技术（Hot Code Reload）</h3>
          
          <p>在 Microscope 的开发过程中，我们已经用过 Meteor 的动态代码重载技术（HCR）去节省时间：当我们修改并保存一个源代码的文件后，Meteor 会立刻检测到变化，直接重启正在运行的 Meteor 服务器，并通知每个客户端重新加载该页面。</p>
          
          <p>这类似于页面的自动刷新，但有一个很重要的差异。</p>
          
          <p>为了找出那是什么，先重置一下之前改过的 Session 变量：</p>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'pageTitle'</span><span class="p">,</span> <span class="s1">'A brand new title'</span><span class="p">);</span>
<span class="err">❯</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'pageTitle'</span><span class="p">);</span>
<span class="s1">'A brand new title'</span></pre>
          <div class="caption">浏览器控制台（Browser console）</div>
          
          <p>如果我们手动去重载浏览器窗口，自然就会丢失我们的 Session 变量（因为这将会创建一个新的会话）。另一方面，如果我们是引发动态代码重载（即，通过修改并保存我们的源文件）去重新加载页面，Session 变量却仍然存在。现在去试一试！</p>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'pageTitle'</span><span class="p">);</span>
<span class="s1">'A brand new title'</span></pre>
          <div class="caption">浏览器控制台（Browser console）</div>
          
          <p>因此，如果使用 Session 变量来保存用户状态，用户几乎不会察觉到动态代码重载的发生。因为它将保留所有 Session 变量的值。这可以使我们在部署新版本的时候，用户发生中断的机会降到最低。</p>
          
          <p>再想一想，这意味着，只要我们做到用 URL 和 Session 把所有状态保存下来，那么当更新版本的时候，客户端<strong>正在运行</strong>的应用程序就可以动态重载，不丢失任何数据。</p>
          
          <p>现在去检验一下当我们去手动刷新页面的时候发生了什么：</p>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'pageTitle'</span><span class="p">);</span>
<span class="kc">null</span></pre>
          <div class="caption">浏览器控制台（Browser console）</div>
          
          <p>当我们重载页面时，我们丢失了 Session 。在 HCR 中，Meteor 将 Session 
保存到浏览器的本地存储并且在重载的之后再一次加载它。然而，在重载页面时发生的丢失行为是有一定道理的：如果用户重新加载页面，就好像他们已经再次浏览
相同的 URL ，而且其他用户都会看到他们访问的 URL，所以他们应该重置为初始状态。</p>
          
          <p>从中我们应该要学会：</p>
          
          <ol>
          <li>应该在 Session 或者 URL 中存储用户状态。从而在动态代码重载的时候，让用户发生中断的机会降到最低。</li>
          <li>尽可能使用 <strong>URL</strong> 去存储你想要共享在用户之间的状态。</li>
          </ol>
          
          <p>以上总结了我们对会话（Session）——— Meteor 最有用的功能之一的探索。不要忘了在进行下一章之前，恢复你对代码的改动。</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="adding-users">添加用户</h2>
            <span class="chapter-number">6</span>
          </div>
          <p>到目前为止，我们已经以较合理的方式去创建并显示一些静态数据，并将其连接到成一个简单的数据原型。</p>
          
          <p>尽管我们的界面是根据变化的数据进行即时响应的，并且数据的实时插入或更改的都会在界面上得到体现。然而，我们的网站似乎还没有提供用户去修改数据的页面。实际上，我们甚至连用户都还没有！</p>
          
          <p>下面让我们看看如何去解决这个问题吧。</p>
          
          <h3>账户：让用户变得简单</h3>
          
          <p>在大多数的 web 框架，添加用户帐户是一个熟悉而又麻烦的工作。然而，你所做的每一个项目几乎都要用到，但它都不曾让我们觉得简单过。甚至如果当你要处理开放授权（OAuth）或其他第三方身份验证的时候，这些工作往往会变得更加恶心和复杂。</p>
          
          <p>幸运的是， Meteor 可以帮你轻松解决。由于 Meteor 包的代码可以同时运行在服务器（JavaScript）和客户端（JavaScript、HTML 和 CSS），这样我们就可以很轻松地得到一个账户系统。</p>
          
          <p>我们可以使用 Meteor 内置的账户界面（通过 <code>meteor add accounts-ui</code> ），但是由于我们已经在构建 App 的时候用了 Bootstrap 包，所以我们将使用 <code>accounts-ui-bootstrap-3</code> 包去代替（别担心，唯一的区别只是里面的样式不同）。我们在终端输入：</p>
          <pre class="highlight shell">meteor add ian:accounts-ui-bootstrap-3
meteor add accounts-password</pre>
          <div class="caption">Terminal</div>
          
          <p>这两个命令的作用是把一些特别的账户模板提供到我们的项目，然后就可以通过 <code>{{loginButtons}}</code> helper 在我们的网站中使用。温馨提示：你可以去控制登录框下拉菜单的对齐方向，通过添加其 <code>align</code> 属性（例如：<code>{{loginButtons  align="right"}}</code>）。</p>
          
          <p>我们将按钮添加到我们的头部（header）模板。这样头部包含的内容将会越来越多了，下面我们为它腾出更多的空间吧（我们将把它放在 <code>client/templates/includes/</code> ）。同时我们使用一些额外的标记和 class <a href="http://getbootstrap.com/components/#navbar">请参考 Bootstrap</a> 来使界面更好看：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"layout"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    {{&gt; header}}
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main"</span> <span class="na">class=</span><span class="s">"row-fluid"</span><span class="nt">&gt;</span>
      {{&gt; yield}}
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/application/layout.html</div><div class="lines-highlight" data-lines="3~6" data-class="added"></div>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"header"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-default"</span> <span class="na">role=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"navbar-toggle collapsed"</span> <span class="na">data-toggle=</span><span class="s">"collapse"</span> <span class="na">data-target=</span><span class="s">"#navigation"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"sr-only"</span><span class="nt">&gt;</span>Toggle navigation<span class="nt">&lt;/span&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"{{pathFor 'postsList'}}"</span><span class="nt">&gt;</span>Microscope<span class="nt">&lt;/a&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse navbar-collapse"</span> <span class="na">id=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
          {{&gt; loginButtons}}
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/includes/header.html</div>
          
          <p>现在，去浏览我们的 App，我们会看到账户登录的按钮出现在网站的右上角。</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/6-1.png" alt="Meteor 内置的账户界面"><figcaption>Meteor 内置的账户界面</figcaption></figure>
          
          <p>这样我们就可以用它来注册，登录，改变密码，它拥有和其他所有网站一样的账户系统功能。</p>
          
          <p>如何告诉我们的账户系统要求用户需要通过用户名密码来登录？只需配置一个 Accounts.ui 模块到一个名叫 <code>config.js</code> 的文件里面，并把文件放在 <code>client/helpers/</code> 中：</p>
          <pre class="highlight javascript"><span class="nx">Accounts</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
  <span class="na">passwordSignupFields</span><span class="p">:</span> <span class="s1">'USERNAME_ONLY'</span>
<span class="p">});</span></pre>
          <div class="caption">client/helpers/config.js</div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 6-1</h4><p>添加账户和它的模板到头（header）模板</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter6-1" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter6-1.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <h3>创建我们的第一个用户</h3>
          
          <p>接下来去注册一个帐户：然后“登录”按钮会变成显示你的用户名。这说明了一个用户帐户已经创建成功。但是，用户帐户的数据来自哪里呢？</p>
          
          <p>在添加 <code>accounts</code> 包以后， Meteor 已经创造了一个新的集合，它可以通过 <code>Meteor.users</code> 去访问。为了验证它，打开你的浏览器控制台并输入：</p>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">();</span></pre>
          <div class="caption">浏览器控制台（Browser console）</div>
          
          <p>控制台应该会返回一个用户对象，如果你仔细看看，可以找到你的用户名，以及唯一标识你账号的 <code>_id</code> 。注意，你还可以通过 <code>Meteor.user()</code> 获得当前登录的用户。</p>
          
          <p>现在我们注销并再次注册一个不同的用户名。 <code>Meteor.user()</code> 现在应该返回第二个注册的用户。但是等一等，我们看看先运行：</p>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">();</span>
<span class="mi">1</span></pre>
          <div class="caption">浏览器控制台（Browser console）</div>
          
          <p>控制台返回的是1？难道不是2吗？第一个用户被删除了吗？如果你再次登录第一个用户，你会发现并没有被删除。</p>
          
          <p>让我们去 Mongo 数据库里面查查看吧。进入 Mongo 数据库（在终端输入 <code>meteor mongo</code> ）输入以下代码：</p>
          <pre class="highlight shell"><span class="gp">&gt; </span>db.users.count<span class="o">()</span>
2</pre>
          <div class="caption">Mongo console</div>
          
          <p>确定是存在两个用户。可是刚刚为什么我们在浏览器中只看到一个呢？</p>
          
          <h3>发布的谜团!</h3>
          
          <p>如果你回想起第4章，可能还记得我们移除了 <code>autopublish</code> 包，我们阻止了集合从服务器自动发送所有数据到每个访问的客户端。然后我们创建了发布和订阅方法来实现数据的传输。</p>
          
          <p>但我们并没有设置过任何用户的发布方法。那为什么我们还可以看到用户的数据呢？</p>
          
          <p>答案就是账户包确实“自动发布”了当前登录用户的基本账户信息。如果没有的话，该用户是无法登录到网站的！</p>
          
          <p>不过账户包只发布了<strong>当前</strong>登录的用户。这就解释了为什么一个用户看不到另一个帐户的详细信息了。</p>
          
          <p>所以发布的只是当前登录用户的用户对象（而且当你注销之后就没有了）。</p>
          
          <p>更重要的是，我们用户的集合似乎在服务器和客户端中并不是包含完全相同的字段。在 Mongo 数据库中，用户拥有大量的数据。为了检验一下，回到你的 Mongo 终端并输入：</p>
          <pre class="highlight shell"><span class="gp">&gt; </span>db.users.find<span class="o">()</span>
<span class="o">{</span>
  <span class="s2">"_id"</span>: <span class="s2">"H5kKyxtbkLhmPgtqs"</span>,
  <span class="s2">"createdAt"</span>: ISODate<span class="o">(</span><span class="s2">"2015-02-10T08:26:48.196Z"</span><span class="o">)</span>,
  <span class="s2">"profile"</span>: <span class="o">{}</span>,
  <span class="s2">"services"</span>: <span class="o">{</span>
    <span class="s2">"password"</span>: <span class="o">{</span>
      <span class="s2">"bcrypt"</span>: <span class="s2">"</span><span class="nv">$2a$10$yGPywo3</span><span class="s2">/53IHsdffdwe766roZviT03YBGltJ0UG"</span>
    <span class="o">}</span>,
    <span class="s2">"resume"</span>: <span class="o">{</span>
      <span class="s2">"loginTokens"</span>: <span class="o">[{</span>
        <span class="s2">"when"</span>: ISODate<span class="o">(</span><span class="s2">"2015-02-10T08:26:48.203Z"</span><span class="o">)</span>,
        <span class="s2">"hashedToken"</span>: <span class="s2">"npxGH7Rmkuxcv098wzz+qR0/jHl0EAGWr0D9ZpOw="</span>
      <span class="o">}]</span>
    <span class="o">}</span>
  <span class="o">}</span>,
  <span class="s2">"username"</span>: <span class="s2">"sacha"</span>
<span class="o">}</span></pre>
          <div class="caption">Mongo console</div>
          
          <p>但是在浏览器中，用户对象的字段就比较少了，可以通过输入这样的命令看到：</p>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">();</span>
<span class="nb">Object</span> <span class="p">{</span><span class="na">_id</span><span class="p">:</span> <span class="s2">"kYdBd9hr3fWPGPcii"</span><span class="p">,</span> <span class="na">username</span><span class="p">:</span> <span class="s2">"tmeasday"</span><span class="p">}</span></pre>
          <div class="caption">浏览器控制台（Browser console）</div>
          
          <p>这个例子向我们展示了本地集合是如何成为一个<strong>安全的</strong>数据库<strong>数据子集</strong>。登录用户只能看到那些足够去配合客户端工作（例如：登陆）的集合属性。以后你会知道这是一个非常值得学习的模式。</p>
          
          <p>但这并不意味着你就不能把更多的用户数据发布出来。你可以参考<a href="http://docs.meteor.com/#meteor_users"> Meteor 说明文档</a>，看看 <code>Meteor.users</code> 集合是如何选择性地发布更多的字段。</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="reactivity">响应式</h2>
            <span class="sidebar-marker">Sidebar</span>
            <span class="chapter-number">6.5</span>
          </div>
          <p>如果说集合是 Meteor 的核心功能，那么<strong>响应式</strong>可以能让这个核心功能更强大。</p>
          
          <p>集合从根本上改变你的应用程序的数据处理方式。从而不必手动检查数据更改（例如，通过一个 AJAX 调用），再根据这些变化去修改 HTML 页面，Meteor 可以随时检测到数据的更改，并将它无缝地应用到你的用户界面上。</p>
          
          <p>让我们思考一下：在后台，当底层的数据集合被更新以后， Meteor 能够马上修改用户界面的<strong>任何</strong>部分。</p>
          
          <p>这个实时性的方法是通过使用 <code>.observe()</code> ，当指向数据的指针发生改变时就会触发回调。我们可以通过这些回调去更改 DOM （我们的网页呈现的 HTML ）。就像这样的代码：</p>
          <pre class="highlight javascript"><span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">observe</span><span class="p">({</span>
  <span class="na">added</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// when 'added' callback fires, add HTML element
</span>    <span class="nx">$</span><span class="p">(</span><span class="s1">'ul'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;li id="'</span> <span class="o">+</span> <span class="nx">post</span><span class="p">.</span><span class="nx">_id</span> <span class="o">+</span> <span class="s1">'"&gt;'</span> <span class="o">+</span> <span class="nx">post</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">'&lt;/li&gt;'</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="na">changed</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// when 'changed' callback fires, modify HTML element's text
</span>    <span class="nx">$</span><span class="p">(</span><span class="s1">'ul li#'</span> <span class="o">+</span> <span class="nx">post</span><span class="p">.</span><span class="nx">_id</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="na">removed</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// when 'removed' callback fires, remove HTML element
</span>    <span class="nx">$</span><span class="p">(</span><span class="s1">'ul li#'</span> <span class="o">+</span> <span class="nx">post</span><span class="p">.</span><span class="nx">_id</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <p>可能你已经知道这样的代码是如何把复杂的事情快速地进行处理。想象一下如果我们去修改帖子的<strong>任何一个属性</strong>，就会伴随着页面中帖子 <code>&lt;li&gt;</code> 标签的更改。当我们开始依赖于更多个数据信息的时候，甚至还可以进行更为复杂的处理，这些都能实时地进行。</p>
          
          <div class="note"><h3>我们应该什么时候去使用 <code>observe()</code> ?</h3>
          
          <p>使用上述的模式有时候很有必要的，尤其是在处理第三方小部件的时候。比如，假设我们想要基于集合数据去实时添加或删除在地图上的位置（也就是说显示当前登录用户的位置）。</p>
          
          <p>在这种情况下，为了让地图能跟 Meteor 的集合进行“交谈”，你就需要使用 <code>observe()</code> 的回调方法去应对数据变化。例如，你需要依赖其中 <code>added</code> 和 <code>removed</code> 的回调方法去调用地图 API 中的 <code>dropPin()</code> 或 <code>removePin()</code> 方法。</p>
          </div>
          
          <h3>声明式方法</h3>
          
          <p>Meteor 为我们提供了一个更好的办法：声明式方法，它的核心就是响应式。这种声明让我们定义了对象之间的关系，并让他们保持同步，而我们就不必为每个的可能发生的修改去指定相应的行为。</p>
          
          <p>这是一个强大的概念，因为有许多实时性的输入，都可能发生在我们不可预测的时间中。通过声明式方法去声明我们该如何基于响应式数据去呈现 HTML ，这样 Meteor 就可以完成对这些数据的监控工作，并且把用户界面直接与数据进行绑定。</p>
          
          <p>总的来说，去代替 <code>observe</code> 的回调，Meteor 可以让我们这些写：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postsList"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;ul&gt;</span>
    {{#each posts}}
      <span class="nt">&lt;li&gt;</span>{{title}}<span class="nt">&lt;/li&gt;</span>
    {{/each}}
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <p>然后获取我们的帖子列表：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postsList</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">posts</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <p>在后台，其实 Meteor 替我们使用了 <code>observe()</code> 的回调方法，并当响应式数据被更改的时候，对相关页面进行重新的渲染。</p>
          
          <h3>Meteor 的依赖跟踪：Computations</h3>
          
          <p>Meteor 是一个实时性、响应式的框架，但并不是<strong>所有</strong>的代码在 Meteor App 里面都是响应式的。如果是这样，当有任何数据发生改变时，你的 App 都会自动进行重新运行。相反，响应式只是在特定区域的代码中发生，我们称这些区域为 <strong>Computations</strong> 。</p>
          
          <p>换句话说， Computations 代码块是根据响应式数据的变化去运行。如果你有一个响应式数据源（例如，一个 Session 变量）并且希望及时去响应它，你需要建立一个 Computations。</p>
          
          <p>请注意，你一般不需要显式地做到这一点，因为 Meteor 已经让每个模板去呈现它自己的 Computation （意思就是模板 Helper 中的代码和回调函数默认都是响应式的）。</p>
          
          <p>Computations 用到的响应式数据源都会被它跟踪，这样就可以知道响应式数据什么时候发生变化。这是通过 Computations 中的 <code>invalidate()</code> 方法实现的。</p>
          
          <p>Computations 一般只是简单地用来判断页面上的无效内容，这通常是发生在模板的 
Computations（尽管模板 Computations 可能也会去做一些让页面更有效的工作）。当然如果你需要，你也可以使用更多 
Computations 的功能，不过在实际中可能比较少用到。</p>
          
          <h3>建立一个 Computations</h3>
          
          <p>现在我们去理解一下 Computations 背后的工作原理，实际上要设置一个 Computations 是出乎意料的简单。我们只需要在 <code>Tracker.autorun</code> 方法中加上需要的代码块，让它变成响应式的 Computations ：</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">startup</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">Tracker</span><span class="p">.</span><span class="nx">autorun</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'There are '</span> <span class="o">+</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">()</span> <span class="o">+</span> <span class="s1">' posts'</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></pre>
          <p>注意我们需要把 <code>Tracker</code> 代码块放进 <code>Meteor.startup()</code> 块中，来确保它在 Meteor 完成加载 <code>Posts</code> 集合后只运行一次。</p>
          
          <p>在后台，<code>autorun</code> 会创建一个 Computation ，当数据源发生变化的时候就会自动重新运行。这样我们就建立了一个非常简单的  Computation ，去把帖子的数量输出到控制台上。因为 <code>Posts.find()</code> 是一个响应式数据源，它将负责告诉 Computation 每次帖子数量发生变化的时候去重新运行。</p>
          <pre class="highlight javascript"><span class="o">&gt;</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">title</span><span class="p">:</span> <span class="s1">'New Post'</span><span class="p">});</span>
<span class="nx">There</span> <span class="nx">are</span> <span class="mi">4</span> <span class="nx">posts</span><span class="p">.</span></pre>
          <p>综上所述，我们可以把响应式数据通过一种很自然的方式与代码进行绑定，这样后台的依赖系统将会在合适的时间去重新运行这段代码。</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="creating-posts">创建帖子</h2>
            <span class="chapter-number">7</span>
          </div>
          <p>我们曾经轻松地通过控制台去使用 <code>Posts.insert</code> 来创建帖子并插入到数据库。但我们不可能指望用户去打开控制台来创建一个新的帖子吧？</p>
          
          <p>所以我们需要在用户界面上创建一些表单控件，让用户在我们的 App 上发布一些新的帖子。</p>
          
          <h3>构建新帖子的提交页面</h3>
          
          <p>我们首先为新帖子的提交页面定义一个路线：</p>
          <pre class="highlight javascript"><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
  <span class="na">layoutTemplate</span><span class="p">:</span> <span class="s1">'layout'</span><span class="p">,</span>
  <span class="na">loadingTemplate</span><span class="p">:</span> <span class="s1">'loading'</span><span class="p">,</span>
  <span class="na">notFoundTemplate</span><span class="p">:</span> <span class="s1">'notFound'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/posts/:_id'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postPage'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/submit'</span><span class="p">,</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'postSubmit'</span><span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">onBeforeAction</span><span class="p">(</span><span class="s1">'dataNotFound'</span><span class="p">,</span> <span class="p">{</span><span class="na">only</span><span class="p">:</span> <span class="s1">'postPage'</span><span class="p">});</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="15" data-class="added"></div>
          
          <h3>在头部（Header）添加一个链接</h3>
          
          <p>定义了这条路线后，现在我们可以在头部模板（Header）中添加一个访问我们提交页面的链接：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"header"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-default"</span> <span class="na">role=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"navbar-toggle collapsed"</span> <span class="na">data-toggle=</span><span class="s">"collapse"</span> <span class="na">data-target=</span><span class="s">"#navigation"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"sr-only"</span><span class="nt">&gt;</span>Toggle navigation<span class="nt">&lt;/span&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"{{pathFor 'postsList'}}"</span><span class="nt">&gt;</span>Microscope<span class="nt">&lt;/a&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse navbar-collapse"</span> <span class="na">id=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postSubmit'}}"</span><span class="nt">&gt;</span>Submit Post<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
          {{&gt; loginButtons}}
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/includes/header.html</div><div class="lines-highlight" data-lines="14~16" data-class="added"></div>
          
          <p>设置了这个路线就意味着如果用户浏览 <code>/submit</code> 的 URL 路径， Meteor 会显示 <code>postSubmit</code> 模板。 下面让我们来写这个模板吧：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postSubmit"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"main form"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">"control-label"</span> <span class="na">for=</span><span class="s">"url"</span><span class="nt">&gt;</span>URL<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"controls"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">id=</span><span class="s">"url"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">""</span> <span class="na">placeholder=</span><span class="s">"Your URL"</span> <span class="na">class=</span><span class="s">"form-control"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">"control-label"</span> <span class="na">for=</span><span class="s">"title"</span><span class="nt">&gt;</span>Title<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"controls"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"title"</span> <span class="na">id=</span><span class="s">"title"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">""</span> <span class="na">placeholder=</span><span class="s">"Name your post"</span> <span class="na">class=</span><span class="s">"form-control"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Submit"</span> <span class="na">class=</span><span class="s">"btn btn-primary"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/post_submit.html</div>
          
          <p>注意：这里有大量的标签样式，只不过都来自于 Twitter Bootstrap。只有表单元素是必不可少的，样式的设置只是让我们的 App 更好看一点。在浏览器中显示：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/7-1.png" alt="帖子提交页面"><figcaption>帖子提交页面</figcaption></figure>
          
          <p>这是一个简单的表单页面，不需要担心它的提交事件，因为我们会通过 JavaScript 拦截表单的提交事件并更新数据。（但如果你考虑到一旦禁用了 JavaScript 的话， Meteor App 就会完全失效）。</p>
          
          <h3>创建帖子</h3>
          
          <p>让我们将一个事件处理绑定到表单的 <code>submit</code> 事件。最好使用 <code>submit</code> 事件（而不是按钮的 <code>click</code> 事件），因为这会覆盖所有可能的提交方式（比如敲击回车键）。</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postSubmit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'submit form'</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">url</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=url]'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="na">title</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=title]'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">};</span>

    <span class="nx">post</span><span class="p">.</span><span class="nx">_id</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">'postPage'</span><span class="p">,</span> <span class="nx">post</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_submit.js</div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 7-1</h4><p>添加一个帖子提交页面并把链接放到头部（Header）。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter7-1" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter7-1.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>这个函数使用 <a href="http://jquery.com/">jQuery</a> 去获取我们表单字段的值，并填充到一个新的帖子对象。我们需要调用 <code>event</code> 的 <code>preventDefault</code> 方法来确保浏览器不会再继续尝试提交表单。</p>
          
          <p>最后，我们要跳转到新的帖子页面。 <code>insert()</code> 方法把这个对象插入到数据库并返回插入对象的 <code>_id</code> 值，路由器的 <code>go()</code> 方法将构建一个帖子页面的 URL 提供我们访问。</p>
          
          <p>最终的结果是用户点击提交时，创建一个帖子，然后用户浏览器将立即跳到帖子创建页面。</p>
          
          <h3>添加一些安全检查</h3>
          
          <p>创建帖子这功能看起来都很好，但我们不想让随机浏览的游客都可以这样做：我们希望他们必须登录。首先可以对登出的用户隐藏帖子创建页面的链接。不过，没有登录的用户仍然可以在浏览器控制台中创建一个帖子，这是我们不能允许的。</p>
          
          <p>值得庆幸的是数据安全已经集成在 Meteor 的集合中，只是在默认情况下它是关闭的。这样的设置可以使你在刚开始构建 App 的时候更加轻松。</p>
          
          <p>我们的 App 不再需要这些辅助了，果断扔掉吧！我们去删除 <code>insecure</code> 包（恢复数据安全）：</p>
          <pre class="highlight shell">meteor remove insecure</pre>
          <div class="caption">Terminal 终端</div>
          
          <p>执行以后你会注意到，帖子的提交页面不可用了。这是因为没有了 <code>insecure</code> 包，从客户端插入帖子集合已经<em>不再被允许了</em>。</p>
          
          <p>我们需要给出一些明确的规则告诉 Meteor ，什么时候才能允许客户插入帖子，否则我们只能从服务端插入。</p>
          
          <h3>允许帖子插入</h3>
          
          <p>首先，为了让我们的提交页面再次可用，我们先展示如何允许从客户端插入数据。事实上，我们最终还会用不同的技术去解决这个问题，但是现在，先做一些简单的处理吧：</p>
          <pre class="highlight javascript"><span class="nx">Posts</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span>

<span class="nx">Posts</span><span class="p">.</span><span class="nx">allow</span><span class="p">({</span>
  <span class="na">insert</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 只允许登录用户添加帖子
</span>    <span class="k">return</span> <span class="o">!!</span> <span class="nx">userId</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">lib/collections/posts.js</div><div class="lines-highlight" data-lines="3~8" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 7-2</h4><p>移除 insecure 包并允许插入帖子</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter7-2" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter7-2.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p><code>Posts.allow</code> 是告诉 Meteor：这是一些允许客户端去修改帖子集合的条件。上面的代码，等于说“只要客户拥有 <code>userId</code> 就允许去插入帖子”。</p>
          
          <p>这个拥有 <code>userId</code> 用户的修改会传递到 <code>allow</code> 和 <code>deny</code> 的方法（如果没有用户登录就返回 <code>null</code>），这个判断通常都是准确的。因为用户帐户是绑定到 Meteor 核心里面的，我们可以依靠 <code>userId</code> 去判断。</p>
          
          <p>我们可以去验证一下，注销登录并创建一个帖子，你在控制台看到的应该是这样：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/7-2.png" alt="Insert failed: Access denied（插入失败：拒绝访问）"><figcaption>Insert failed: Access denied（插入失败：拒绝访问）</figcaption></figure>
          
          <p>然而，我们仍然需要处理一些问题：</p>
          
          <ul>
          <li>登出后的用户仍然可以访问帖子创建页面。</li>
          <li>帖子并没有以任何方式与用户进行绑定（没有在服务器上的代码去执行这个）。</li>
          <li>允许创建指向相同的 URL 的多个帖子。</li>
          </ul>
          
          <p>让我们来解决这些问题吧！</p>
          
          <h3>帖子创建页面的可访问性</h3>
          
          <p>让我们首先阻止已登出的用户看到帖子创建页面。我们会在路由器中，通过定义一个 <strong>路由 Hook</strong> 。</p>
          
          <p>Hook 在路由过程中进行拦截并可能改变路由器的跳转。你可以把它当作一个保安，检查你的凭据才能让你通过（或者把你带走）。</p>
          
          <p>我们需要做的是检查用户是否登录，如果他们没有登录，呈现出来的是 <code>accessDenied</code> 模板而不是 <code>postSubmit</code> 模板。 让我们去修改 router.js 文件：</p>
          <pre class="highlight javascript"><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
  <span class="na">layoutTemplate</span><span class="p">:</span> <span class="s1">'layout'</span><span class="p">,</span>
  <span class="na">loadingTemplate</span><span class="p">:</span> <span class="s1">'loading'</span><span class="p">,</span>
  <span class="na">notFoundTemplate</span><span class="p">:</span> <span class="s1">'notFound'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/posts/:_id'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postPage'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/submit'</span><span class="p">,</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'postSubmit'</span><span class="p">});</span>

<span class="kd">var</span> <span class="nx">requireLogin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'accessDenied'</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">onBeforeAction</span><span class="p">(</span><span class="s1">'dataNotFound'</span><span class="p">,</span> <span class="p">{</span><span class="na">only</span><span class="p">:</span> <span class="s1">'postPage'</span><span class="p">});</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">onBeforeAction</span><span class="p">(</span><span class="nx">requireLogin</span><span class="p">,</span> <span class="p">{</span><span class="na">only</span><span class="p">:</span> <span class="s1">'postSubmit'</span><span class="p">});</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="17~23,26" data-class="added"></div>
          
          <p>我们还要创建拒绝访问模板：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"accessDenied"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"access-denied jumbotron"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span>Access Denied<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;p&gt;</span>You can't get here! Please log in.<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/includes/access_denied.html</div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 7-3</h4><p>当没有登录的时候拒绝访问帖子创建页面</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter7-3" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter7-3.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>如果你不登录去访问 http://localhost:3000/submit/ ，你将会看到：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/7-3.png" alt="拒绝访问模板"><figcaption>拒绝访问模板</figcaption></figure>
          
          <p>路由器 Hooks 的好处是<strong>响应式</strong>。这意味着当用户登录的时候，我们不需要考虑回调或者其他类似的方法，它就可以马上知道。当用户状态变为已登录的时候，路由器的页面模板立即从 <code>accessDenied</code> 变为 <code>postSubmit</code>，而我们无需编写任何代码来去控制它。</p>
          
          <p>登录，然后尝试刷新页面。你可能注意到，拒绝访问的页面会短暂地出现在帖子创建页面。这是因为在服务器去检测当前用户之前，Meteor 会尽可能快的去渲染模板。</p>
          
          <p>为了避免这个问题（这是一种常见的问题，你将会看到更多去处理客户端和服务器之间错综复杂的延迟），我们将短暂显示一个加载的画面，腾出足够时间让我们去判断用户是否有权访问。</p>
          
          <p>毕竟在这之前，我们不知道用户是否有正确的登录凭证，而我们也不能直接显示 <code>accessDenied</code> 或 <code>postSubmit</code> 模板。</p>
          
          <p>所以修改 Hook 去使用我们的加载模板，同时判断 <code>Meteor.loggingIn()</code> 是否为真：</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="kd">var</span> <span class="nx">requireLogin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">loggingIn</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">loadingTemplate</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'accessDenied'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">onBeforeAction</span><span class="p">(</span><span class="s1">'dataNotFound'</span><span class="p">,</span> <span class="p">{</span><span class="na">only</span><span class="p">:</span> <span class="s1">'postPage'</span><span class="p">});</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">onBeforeAction</span><span class="p">(</span><span class="nx">requireLogin</span><span class="p">,</span> <span class="p">{</span><span class="na">only</span><span class="p">:</span> <span class="s1">'postSubmit'</span><span class="p">});</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="5~10" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 7-4</h4><p>在等待登录的时候显示一个加载画面</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter7-4" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter7-4.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <h3>隐藏链接</h3>
          
          <p>当他们注销登录之后就隐藏这个链接，这是最简单的方法去防止用户试图访问不被授权的页面。我们做到这一点很简单：</p>
          <pre class="highlight html">//...

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav"</span><span class="nt">&gt;</span>
  {{#if currentUser}}<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postSubmit'}}"</span><span class="nt">&gt;</span>Submit Post<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>{{/if}}
<span class="nt">&lt;/ul&gt;</span>

//...</pre>
          <div class="caption">client/templates/includes/header.html</div><div class="lines-highlight" data-lines="3~5" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 7-5</h4><p>只在登录后才显示创建帖子链接</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter7-5" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter7-5.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p><code>currentUser</code> 的 Helper 是通过 <code>accounts</code> 包提供给我们的，它相当于是 <code>Meteor.user()</code> 的调用。因为它是响应式的，链接将会在你登入或者登出的的时候出现或者消失。</p>
          
          <h3>Meteor 内置方法：更好的抽象和安全</h3>
          
          <p>我们让没有登录的用户无法访问帖子创建页面，并且不允许这样的用户通过使用控制台去创建帖子。然而，仍有一些更多的事情我们需要考虑：</p>
          
          <ul>
          <li>帖子的时间戳。</li>
          <li>确保拥有相同 URL 的帖子不能再次创建。</li>
          <li>添加帖子的作者的详细信息（ID 、用户名等）。</li>
          </ul>
          
          <p>你可能会想我们可以把这些事情放到我们的 <code>submit</code> 事件中去处理。但是实际上，我们很快就会遇到一系列的问题。</p>
          
          <ul>
          <li>对于时间戳，我们并不是总需要依赖用户计算机的时间是否正确。</li>
          <li>客户并不知道所有发布到该网站的帖子的 URL 。他们只能知道目前看到的帖子（稍后我们将看看这是如何工作），所以没有办法在每个客户端中确保 URL 是否唯一的。</li>
          <li>最后，虽然我们可以在客户端添加用户的详细信息，但是我们不能确保其准确性，因为可能有人会使用浏览器控制台去进行编辑更改。</li>
          </ul>
          
          <p>因为这些问题，最好是保持我们的事件处理方法里面足够简单，如果我们所做的事情超过最基本的插入或更新数据集合，那么可以使用 Meteor 的内置方法 。</p>
          
          <p>Meteor 内置方法是一种服务器端方法提供给客户端调用。其实我们对它并不陌生–事实上在后台， <code>Collection</code> 的 <code>insert</code>、<code>update</code> 和 <code>remove</code> 都属于 Meteor 内置方法。下面看看我们如何自己来创建。</p>
          
          <p>让我们回到 <code>post_submit.js</code> 文件，不再是直接插入到 <code>Posts</code> 集合，我们将调用一个名为 <code>postInsert</code> 的内置方法：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postSubmit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'submit form'</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">url</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=url]'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="na">title</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=title]'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">};</span>

    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">'postInsert'</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 显示错误信息并退出
</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>

      <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">'postPage'</span><span class="p">,</span> <span class="p">{</span><span class="na">_id</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">_id</span><span class="p">});</span>  
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_submit.js</div><div class="lines-highlight" data-lines="10~16" data-class="added"></div>
          
          <p><code>Meteor.call</code> 方法通过第一个参数来调用其方法。你可以为调用方法提供参数（在这种情况下，由表单数据来构建的 <code>post</code> 对象），最后加上一个回调，它将在服务器的方法完成后执行。</p>
          
          <p>Meteor 方法回调总会有两个参数，<code>error</code> 和 <code>result</code>。如果 <code>error</code> 参数由于某种原因存在的话，我们会警告用户（使用 <code>return</code> 来终止回调）。如果正常运行的话，我们将用户转到刚刚创建好的帖子评论页面。</p>
          
          <h3>安全检查</h3>
          
          <p>我们趁现在这个机会添加 <a href="http://docs.meteor.com/#auditargumentchecks"><code>audit-argument-checks</code></a> 包来增加一些安全性。</p>
          
          <p>这个包让你根据预定义的模式检查任何 JavaScript 对象。对于我们来说，我们使用它来检查调用方法的用户是否登陆（通过确认 <code>Meteor.userId()</code> 是否是个 <code>String</code> 字符串），然后 <code>postAttributes</code> 对象是否包含 <code>title</code> 和<code>url</code> 字符串，来保证我们不会添加任意数据到数据库中。</p>
          
          <p>首先让我们定义 <code>postInsert</code> 方法，在我们的 <code>collections/post.js</code> 文件中。从 <code>posts.js</code> 文件中删除 <code>allow()</code> 代码块，因为 Meteor 方法会绕过它们。</p>
          
          <p>然后我们 <code>extend</code> <code>postAttributes</code> 对象另外三个属性：用户的 <code>_id</code> 和 <code>username</code>，还有帖子的 <code>submitted</code> 时间戳，在将整个数据插入数据库之前，并返回给用户 <code>_id</code> 值（换句话说，在 JavaScript 对象里的 原始 caller 方法）</p>
          <pre class="highlight javascript"><span class="nx">Posts</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>
  <span class="na">postInsert</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">check</span><span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">(),</span> <span class="nb">String</span><span class="p">);</span>
    <span class="nx">check</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">title</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
      <span class="na">url</span><span class="p">:</span> <span class="nb">String</span>
    <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> 
      <span class="na">author</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> 
      <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="nx">postId</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">lib/collections/posts.js</div><div class="lines-highlight" data-lines="3~24" data-class="added"></div>
          
          <p>注意的是 <code>_.extend()</code> 方法来自于 <a href="http://underscorejs.org/">Underscore</a> 库，作用是将一个对象的属性传递给另一个对象。</p>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 7-6</h4><p>使用一个内置方法来提交帖子。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter7-6" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter7-6.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <div class="note"><h3>再见 Allow/Deny</h3>
          
          <p>因为 Meteor Methods 是在服务器上执行，所以 Meteor 假设它们是可信任的。这样的话，Meteor 方法就会绕过任何 allow/deny 回调。</p>
          
          <p>如果你真的想在<em>服务器端</em>每次 <code>insert</code>、<code>update</code> 或 <code>remove</code> 之前，运行一些代码的话，我们建议你查看 <a href="https://github.com/matb33/meteor-collection-hooks">collection-hooks</a>  代码包的相关信息。</p>
          </div>
          
          <h3>防止重复</h3>
          
          <p>我们在完成这个方法之前还要在添加一项检查。如果之前的帖子拥有了同样的 URL，我们不会再次添加这个链接，反而会引导用户到已存在的帖子上。</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>
  <span class="na">postInsert</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">check</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nb">String</span><span class="p">);</span>
    <span class="nx">check</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">title</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
      <span class="na">url</span><span class="p">:</span> <span class="nb">String</span>
    <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">postWithSameLink</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">url</span><span class="p">:</span> <span class="nx">postAttributes</span><span class="p">.</span><span class="nx">url</span><span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">postWithSameLink</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="na">postExists</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">_id</span><span class="p">:</span> <span class="nx">postWithSameLink</span><span class="p">.</span><span class="nx">_id</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> 
      <span class="na">author</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> 
      <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="nx">postId</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">lib/collections/posts.js</div><div class="lines-highlight" data-lines="9~15" data-class="added"></div>
          
          <p>我们在数据库中搜寻是否存在相同的 URL。如果找到，我们 <code>return</code> 返回那帖子的 <code>_id</code> 和 <code>postExists: true</code> 来让用户知道这个特别的情况。</p>
          
          <p>由于我们调用了一个 <code>return</code>，方法就会到此停止，而不会执行 <code>insert</code> 声明，因此优雅地防止了任何重复。</p>
          
          <p>剩下的就是用 <code>postExists</code> 信息通过我们客户端的事件 helper 来显示警告信息：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postSubmit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'submit form'</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">url</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=url]'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="na">title</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=title]'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">};</span>

    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">'postInsert'</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 向用户显示错误信息并终止
</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>

      <span class="c1">// 显示结果，跳转页面
</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">postExists</span><span class="p">)</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s1">'This link has already been posted（该链接已经存在）'</span><span class="p">);</span>

      <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">'postPage'</span><span class="p">,</span> <span class="p">{</span><span class="na">_id</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">_id</span><span class="p">});</span>  
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_submit.js</div><div class="lines-highlight" data-lines="15~17" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 7-7</h4><p>强制帖子 URL 的唯一性。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter7-7" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter7-7.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <h3>帖子排序</h3>
          
          <p>现在我们已经在所有的帖子中添加了日期，确保可以使用这个属性去进行帖子的分类。这样，我们就可以使用 Mongo 数据库的 <code>sort</code> 运算方法，根据这个字段去把对象进行排序，并且标识它们是升序还是降序。</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postsList</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">posts</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="na">sort</span><span class="p">:</span> <span class="p">{</span><span class="na">submitted</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}});</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/posts_list.js</div><div class="lines-highlight" data-lines="3" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 7-8</h4><p>帖子通过时间戳进行排序。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter7-8" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter7-8.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>花了一点功夫，我们终于有了一个用户界面，让用户安全地在我们的 App 中输入内容！</p>
          
          <p>但任何一个 App 如果允许用户去创建内容，同时也需要给他们一个方式来编辑或删除它。这就是下一章将会说到的。</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="latency-compensation">延迟补偿</h2>
            <span class="sidebar-marker">Sidebar</span>
            <span class="chapter-number">7.5</span>
          </div>
          <p>在上一章，我们介绍了 Meteor 的一个新概念：<strong>内置方法</strong>。</p>
          
          <figure class="diagram pull-right"><img src="DiscoverMeteor_files/latency12x.png" alt="没有延迟补偿的情况"><figcaption>没有延迟补偿的情况</figcaption></figure>
          
          <p>Meteor 的内置方法是一种在服务器上执行一系列命令的结构化方法。在示例中，我们使用内置方法是为了确保新帖子是通过作者的姓名和 ID ，以及当前服务器时间去标记。</p>
          
          <p>然而，如果 Meteor 用最基本的方式去执行内置方法，我们会注意到一些问题。想一想下面事件的序列（注：为演示方便，时间戳值是随机的生成的）：</p>
          
          <ul>
          <li><em>+0ms:</em> 用户单击提交按钮，浏览器触发内置方法的调用。</li>
          <li><em>+200ms:</em> 服务器更改 Mongo 数据库。</li>
          <li><em>+500ms:</em> 客户端接收到这些变化，并更新页面反映更改结果。</li>
          </ul>
          
          <p>如果这是 Meteor 的操作方式，它会有一个很短的时间差去看到这样的执行操作的结果（延时的多少会取决于你的服务器性能）。但我们不可能让这些情况出现在 Web 应用程序中！</p>
          
          <h3>延迟补偿</h3>
          
          <figure class="diagram pull-right"><img src="DiscoverMeteor_files/latency22x.png" alt="延迟补偿的情况"><figcaption>延迟补偿的情况</figcaption></figure>
          
          <p>为了避免这个问题，Meteor 引入了一个叫做<strong>延迟补偿（Latency Compensation）</strong>的概念。如果我们把 <code>post</code> 方法的定义放在 <code>collections/</code> 目录下。这意味着它在服务端和客户端上都存在，而且是同时运行！</p>
          
          <p>当你使用内置方法的时候，客户端会发送请求到服务器去调用，同时还模仿服务器内置方法去操作本地数据库集合。所以现在我们的工作流程是：</p>
          
          <ul>
          <li><em>+0ms:</em> 用户单击提交按钮，浏览器触发内置方法的调用。</li>
          <li><em>+0ms:</em> 客户端模仿内置方法操作本地的数据集合和以及通过更改页面来反映这一变化。</li>
          <li><em>+200ms:</em> 服务器更改 Mongo 数据库。</li>
          <li><em>+500ms:</em> 客户端接收这些更改并取消刚刚的模仿操作，根据服务器的更改覆盖它们（通常是相同的）。页面的变化反映了这一过程。</li>
          </ul>
          
          <p>这样用户就会立刻看到变化。服务器的响应返回一段时间后，根据服务器数据库发送过来的更改请求，本地数据库可能会或可能不会有明显的改变。因此，我们应该学会确保本地数据尽可能地与服务器数据库保持一致。</p>
          
          <h3>观察延迟补偿</h3>
          
          <p>我们可以对 <code>post</code> 内置方法的调用稍作改动。为此，我们将会通过 npm 包 <code>futures</code> ，使用一些高级的编程方式去把延迟对象放到我们的内置方法调用里面。</p>
          
          <p>我们将使用 <code>isServer</code> 去问 Meteor 现在所调用的内置方法是在客户端被调用（作为一个存根 Stub）或是在服务器端。这个存根 <a href="http://docs.meteor.com/#methods_header">stub</a> 是模仿内置方法在客户端运行的模拟方法，而“真正的”内置方法是在服务器上运行的。</p>
          
          <p>所以我们会询问 Meteor 这部分代码是否在服务器端执行。如果是，我们会在帖子的标题后面添加 <code>(server)</code> 字符串。如果不是，我们将添加 <code>(client)</code> 字符串：</p>
          <pre class="highlight javascript"><span class="nx">Posts</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>
  <span class="na">postInsert</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">check</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nb">String</span><span class="p">);</span>
    <span class="nx">check</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">title</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
      <span class="na">url</span><span class="p">:</span> <span class="nb">String</span>
    <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">isServer</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">postAttributes</span><span class="p">.</span><span class="nx">title</span> <span class="o">+=</span> <span class="s2">"(server)"</span><span class="p">;</span>
      <span class="c1">// wait for 5 seconds
</span>      <span class="nx">Meteor</span><span class="p">.</span><span class="nx">_sleepForMs</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">postAttributes</span><span class="p">.</span><span class="nx">title</span> <span class="o">+=</span> <span class="s2">"(client)"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">postWithSameLink</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">url</span><span class="p">:</span> <span class="nx">postAttributes</span><span class="p">.</span><span class="nx">url</span><span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">postWithSameLink</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="na">postExists</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">_id</span><span class="p">:</span> <span class="nx">postWithSameLink</span><span class="p">.</span><span class="nx">_id</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> 
      <span class="na">author</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> 
      <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="nx">postId</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">collections/posts.js</div><div class="lines-highlight" data-lines="11~17" data-class="added"></div>
          
          <p>如果我们到此为止，这个演示就不那么有意义。当前，看起来就像是帖子表单提交后暂停了5秒钟，然后转到主帖子列表，没发生其他事情。</p>
          
          <p>为了理解这是为什么，让我们看看帖子提交的事件 handler：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postSubmit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'submit form'</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">url</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=url]'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="na">title</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=title]'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">};</span>

    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">'postInsert'</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// display the error to the user and abort
</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>

      <span class="c1">// show this result but route anyway
</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">postExists</span><span class="p">)</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s1">'This link has already been posted'</span><span class="p">);</span>

      <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">'postPage'</span><span class="p">,</span> <span class="p">{</span><span class="na">_id</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">_id</span><span class="p">});</span>  
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_submit.js</div>
          
          <p>我们在方法 call 回调函数中放了 <code>Router.go()</code> 路由函数。</p>
          
          <p>现在的行为通常是正确的。毕竟，你不能在确定他们帖子提交是否有效之前去跳转用户，只是因为如果立即跳转走，然后几秒钟后再转回到原始帖子页面去更正数据，这会非常令人困惑。</p>
          
          <p>但是对于这个例子而言，我们想立即看看结果。所以我们将路由更改到 <code>postsList</code> 路由（我们还不能路由到帖子，因为在方法之外我们不知道帖子的 <code>_id</code>），把它从回调函数中移出来，看看会发生什么：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postSubmit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'submit form'</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">url</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=url]'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="na">title</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=title]'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">};</span>

    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">'postInsert'</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// display the error to the user and abort
</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>

      <span class="c1">// show this result but route anyway
</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">postExists</span><span class="p">)</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s1">'This link has already been posted'</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">'postsList'</span><span class="p">);</span>  

  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_submit.js</div><div class="lines-highlight" data-lines="20" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 7-5-1</h4><p>Demonstrate the order that posts appear using a sleep.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/sidebar7-5-1" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-sidebar7-5-1.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>如果我们现在创建一个帖子，我们可以清楚地看到延迟补偿。首先，插入一个标题带 <code>(client)</code> 的帖子（列表的第一个帖子，链接到 GitHub）：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/s5-1.png" alt="我们的帖子首先储存在客户端集合"><figcaption>我们的帖子首先储存在客户端集合</figcaption></figure>
          
          <p>接着，五秒之后，它就会被服务器插入的真正帖子文档所替代：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/s5-2.png" alt="我们的帖子在客户端收到来自服务器端集合传来的更新"><figcaption>我们的帖子在客户端收到来自服务器端集合传来的更新</figcaption></figure>
          
          <h3>客户端集合内置方法</h3>
          
          <p>通过上面所说的，你可能会认为内置方法很复杂，但事实上它们也可以相当简单。实际上我们已经用过三个非常简单的内置方法：集合的操作方法 <code>insert</code>、<code>update</code> 和 <code>remove</code>。</p>
          
          <p>当你定义一个服务器集合称为 <code>'posts'</code> ，你已经隐式地定义了这三个内置方法： <code>posts/insert</code>、<code>posts/update</code> 和 <code>posts/delete</code>。换句话说，当你在本地集合中调用 <code>Posts.insert()</code>，你已经在调用延时补偿方法来做下面这两件事：</p>
          
          <ol>
          <li>检查我们是否允许通过调用 <code>allow</code> 和 <code>deny</code> 方法的回调去操作集合（然而这并不需要发生在内置方法的模拟）。</li>
          <li>实际地修改底层的数据库。</li>
          </ol>
          
          <h3>内置方法的相互调用</h3>
          
          <p>你可能已经意识到当我们插入帖子的时候，<code>post</code> 的内置方法调用了另一个内置方法（<code>posts/insert</code>）。这是如何工作的呢？</p>
          
          <p>当模拟方法（客户端版本的内置方法）开始运行，模拟方法执行 <code>insert</code>（插入的是本地集合）时，我们不叫它真正的服务器端 <code>insert</code>，但我们会认为<em>服务器端</em>的 <code>post</code> 也将会同样的被插入。</p>
          
          <p>因此，当服务器端的 <code>post</code> 调用内置方法 <code>insert</code> 的时候更加没有必要去担心的客户端模拟方法，它肯定能够在客户端顺利地插入。</p>
          
          <p>像之前一样，在阅读下一章之前，不要忘记还原你所做的更改。</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="editing-posts">编辑帖子</h2>
            <span class="chapter-number">8</span>
          </div>
          <p>上一章，我们已经学会了创建帖子，下面来学习编辑和删除它们。页面的代码非常简单，让我们在这个时候来谈论一下 Meteor 是如何管理用户权限。</p>
          
          <p>让我们先设置我们的路由器，添加一个可以访问帖子编辑页的路径，并设置它的数据上下文：</p>
          <pre class="highlight javascript"><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
  <span class="na">layoutTemplate</span><span class="p">:</span> <span class="s1">'layout'</span><span class="p">,</span>
  <span class="na">loadingTemplate</span><span class="p">:</span> <span class="s1">'loading'</span><span class="p">,</span>
  <span class="na">notFoundTemplate</span><span class="p">:</span> <span class="s1">'notFound'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/posts/:_id'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postPage'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/posts/:_id/edit'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postEdit'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/submit'</span><span class="p">,</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'postSubmit'</span><span class="p">});</span>

<span class="kd">var</span> <span class="nx">requireLogin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">loggingIn</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">loadingTemplate</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'accessDenied'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">onBeforeAction</span><span class="p">(</span><span class="s1">'dataNotFound'</span><span class="p">,</span> <span class="p">{</span><span class="na">only</span><span class="p">:</span> <span class="s1">'postPage'</span><span class="p">});</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">onBeforeAction</span><span class="p">(</span><span class="nx">requireLogin</span><span class="p">,</span> <span class="p">{</span><span class="na">only</span><span class="p">:</span> <span class="s1">'postSubmit'</span><span class="p">});</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="15~18" data-class="added"></div>
          
          <h3>帖子编辑模板</h3>
          
          <p>我们可以现在专注模板了。我们的 <code>postEdit</code> 模板就包含一个相当标准的表单：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postEdit"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"main form"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">"control-label"</span> <span class="na">for=</span><span class="s">"url"</span><span class="nt">&gt;</span>URL<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"controls"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">id=</span><span class="s">"url"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"{{url}}"</span> <span class="na">placeholder=</span><span class="s">"Your URL"</span> <span class="na">class=</span><span class="s">"form-control"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">"control-label"</span> <span class="na">for=</span><span class="s">"title"</span><span class="nt">&gt;</span>Title<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"controls"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"title"</span> <span class="na">id=</span><span class="s">"title"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"{{title}}"</span> <span class="na">placeholder=</span><span class="s">"Name your post"</span> <span class="na">class=</span><span class="s">"form-control"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Submit"</span> <span class="na">class=</span><span class="s">"btn btn-primary submit"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;hr/&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"btn btn-danger delete"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Delete post<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/post_edit.html</div>
          
          <p>用 <code>post_edit.js</code> 来配合这个的模板：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postEdit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'submit form'</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">currentPostId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">postProperties</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">url</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=url]'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="na">title</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=title]'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nx">Posts</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">currentPostId</span><span class="p">,</span> <span class="p">{</span><span class="na">$set</span><span class="p">:</span> <span class="nx">postProperties</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 向用户显示错误信息
</span>        <span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">'postPage'</span><span class="p">,</span> <span class="p">{</span><span class="na">_id</span><span class="p">:</span> <span class="nx">currentPostId</span><span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">},</span>

  <span class="s1">'click .delete'</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">confirm</span><span class="p">(</span><span class="s2">"Delete this post?"</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">currentPostId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
      <span class="nx">Posts</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">currentPostId</span><span class="p">);</span>
      <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">'postsList'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_edit.js</div>
          
          <p>相信你现在已经对这些代码都相当的熟悉了。</p>
          
          <p>我们有两个事件回调函数：一个用于表单的 <code>submit</code> 事件，一个用于删除链接的 <code>click</code> 事件。</p>
          
          <p>删除链接的回调函数是非常简单的：先防止默认点击事件，然后提示确认窗口。如果确认删除，它将从模板的数据上下文中获得当前帖子的 ID ，然后删除它，最后把用户重定向到主页。</p>
          
          <p>更新的回调函数需要长一点时间，但并不复杂。在防止默认提交事件然后获取了当前帖子之后，我们将从表单中获取相关字段的值，并将它们存储在一个 <code>postProperties</code> 的对象中。</p>
          
          <p>然后，我们把该对象通过 <a href="http://docs.mongodb.org/manual/reference/operator/update/set/"><code>$set</code></a> 操作符（只更新指定字段的值，保留其他字段的值）传递给 Meteor 的 <code>Collection.update()</code> 方法，并通过回调函数去判断如果更新失败就显示错误信息；如果更新成功了，将自动返回到该帖子的页面。</p>
          
          <h3>添加链接</h3>
          
          <p>我们还应该添加一个编辑帖子的链接，以便用户可以访问到帖子编辑页面：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postItem"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"post-content"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{url}}"</span><span class="nt">&gt;</span>{{title}}<span class="nt">&lt;/a&gt;&lt;span&gt;</span>{{domain}}<span class="nt">&lt;/span&gt;&lt;/h3&gt;</span>
      <span class="nt">&lt;p&gt;</span>
        submitted by {{author}}
        {{#if ownPost}}<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postEdit'}}"</span><span class="nt">&gt;</span>Edit<span class="nt">&lt;/a&gt;</span>{{/if}}
      <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postPage'}}"</span> <span class="na">class=</span><span class="s">"discuss btn btn-default"</span><span class="nt">&gt;</span>Discuss<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/post_item.html</div><div class="lines-highlight" data-lines="5~8" data-class="added"></div>
          
          <p>当然，我们不能让你的帖子提供给其他用户去编辑。这就要通过 <code>ownPost</code> helper 来帮忙：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">ownPost</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">userId</span> <span class="o">===</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="na">domain</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'a'</span><span class="p">);</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_item.js</div><div class="lines-highlight" data-lines="2~4" data-class="added"></div>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/8-1.png" alt="帖子编辑表单。"><figcaption>帖子编辑表单。</figcaption></figure>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 8-1</h4><p>添加帖子编辑表单。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter8-1" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter8-1.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>我们的帖子编辑表单看起来很好，但是目前还不能够进行任何的编辑，这是为什么？</p>
          
          <h3>设置权限</h3>
          
          <p>自从我们移除了 <code>insecure</code> 包，现在所有客户端的修改都会被拒绝。</p>
          
          <p>为了解决这个问题，我们需要建立一些权限规则。首先，在 <code>lib</code> 目录下创建一个新的 <code>permissions.js</code> 文件。这样做将会首先加载我们权限文件（它在服务端和客户端都可以被加载到）：</p>
          <pre class="highlight javascript"><span class="c1">// check that the userId specified owns the documents
</span><span class="nx">ownsDocument</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">doc</span> <span class="o">&amp;&amp;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">userId</span> <span class="o">===</span> <span class="nx">userId</span><span class="p">;</span>
<span class="p">}</span></pre>
          <div class="caption">lib/permissions.js</div>
          
          <p>在<a href="http://zh.discovermeteor.com/chapter/creating-posts">创建帖子</a>这个章节，我们抛弃了 <code>allow()</code> 方法，因为我们只通过服务端方法去插入新的帖子（绕过了 <code>allow()</code> 方法）。</p>
          
          <p>但是现在我们要在客户端编辑和删除帖子！我们回到 <code>posts.js</code> 文件并添加 <code>allow()</code> ：</p>
          <pre class="highlight javascript"><span class="nx">Posts</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span>

<span class="nx">Posts</span><span class="p">.</span><span class="nx">allow</span><span class="p">({</span>
  <span class="na">update</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">post</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">ownsDocument</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">post</span><span class="p">);</span> <span class="p">},</span>
  <span class="na">remove</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">post</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">ownsDocument</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">post</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">lib/collections/posts.js</div><div class="lines-highlight" data-lines="3~6" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 8-2</h4><p>添加基本权限来检查帖子的拥有者。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter8-2" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter8-2.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <h3>限制编辑</h3>
          
          <p>尽管你可以编辑自己的帖子，但并不意味着你可以允许去编辑帖子的<strong>每个</strong>属性。例如，我们不允许用户创建一个帖子之后，再将其分配给其他用户。</p>
          
          <p>我们用 Meteor 的 <code>deny()</code> 方法，以确保用户只能编辑特定的字段：</p>
          <pre class="highlight javascript"><span class="nx">Posts</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span>

<span class="nx">Posts</span><span class="p">.</span><span class="nx">allow</span><span class="p">({</span>
  <span class="na">update</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">post</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">ownsDocument</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">post</span><span class="p">);</span> <span class="p">},</span>
  <span class="na">remove</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">post</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">ownsDocument</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">post</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Posts</span><span class="p">.</span><span class="nx">deny</span><span class="p">({</span>
  <span class="na">update</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="nx">fieldNames</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 只能更改如下两个字段：
</span>    <span class="k">return</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">without</span><span class="p">(</span><span class="nx">fieldNames</span><span class="p">,</span> <span class="s1">'url'</span><span class="p">,</span> <span class="s1">'title'</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">lib/collections/posts.js</div><div class="lines-highlight" data-lines="8~13" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 8-3</h4><p>只允许更改帖子的某些属性。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter8-3" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter8-3.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>代码中的 <code>fieldNames</code> 数组，它包含了需要被修改的字段，并使用  <a href="http://underscorejs.org/">Underscore</a> 的 <code>without()</code> 方法返回一个<em>不包含</em> <code>url</code> 和 <code>title</code> 字段的子数组。</p>
          
          <p>正常情况下，这个数组应该是空的，它的长度应该是0。如果有人采取其他操作，这个数组的长度将变为1或更多，回调函数将返回 <code>true</code> （因此禁止更新）。</p>
          
          <p>你也许注意到了在我们的代码中没有检查链接是否重复的代码。这就意味着用户成功添加一个链接后，再编辑时就会绕过检查。这个问题同样可以通过为编辑帖子表单使用 Meteor 内置方法来解决，但是我们将它作为练习留给读者。</p>
          
          <div class="note"><h3>内置方法的回调 vs 客户端数据操作</h3>
          
          <p>创建帖子，我们使用的是 <code>postInsert</code> 的内置方法，而编辑和删除帖子，我们直接在客户端调用 <code>update</code> 和 <code>remove</code>，并通过 <code>allow</code> 和 <code>deny</code> 去限制使用权限。</p>
          
          <p>我们该如何去选择使用呢？</p>
          
          <p>当操作相对比较直观，你可以通过 <code>allow</code> 和 <code>deny</code> 去设置你的规则的时候，直接在客户端进行操作通常会更简单。</p>
          
          <p>然而，一旦你需要做一些在用户控制以外的事情（比如设置一个新帖子的时间戳，或者把帖子分配到正确的用户），这种情况使用内置方法会更好。</p>
          
          <p>内置方法也适用在其他的一些情景：</p>
          
          <ul>
          <li>当你需要通过内置方法的回调函数去获得返回值的时候，而不是等待响应和同步才传递的数据。</li>
          <li>对于一些繁重的数据库操作，比如要提取大量的数据集合。</li>
          <li>计算或者合计数据的时候（比如：计数、平均值、求和）。</li>
          </ul>
          
          <p><a href="https://www.discovermeteor.com/blog/meteor-methods-client-side-operations/">请阅读我们的 blog</a> 来深入了解这个话题。</p>
          </div>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="allow-and-deny">允许和拒绝</h2>
            <span class="sidebar-marker">Sidebar</span>
            <span class="chapter-number">8.5</span>
          </div>
          <p>Meteor 的安全系统不需要我们在每次修改数据的时候，在各自的函数里面进行手动检查。</p>
          
          <p>例如，对于一个博客系统，我们常常需要做很多操作，往新帖子上添加属性，当发布帖子的时候进行特定检查。这些操作都是围绕帖子（post）这个对象进行的，所以我们应该为帖子设置一个专门的函数进行安全检查。</p>
          
          <p>但在另一方面，我们又不希望为修改帖子或删除帖子这些简单的操作编写特定的函数。我们只需要在这些操作之前，检查用户是否有权限就可以了。这时我们就需要用到允许（allow）和拒绝（deny）回调函数。</p>
          
          <p>这些回调函数可以方便地让我们定义哪些数据可以被修改，哪些可以被删除。另外，这些回调函数还整合了用户系统（account system），用以判断权限。</p>
          
          <h3>多个回调函数</h3>
          
          <p>我们可以根据需要定义多个允许 <code>allow</code> 回调函数。但是我们只需要其中<em>至少有一个</em>返回 <code>true</code> 就可以让操作通过验证。当 <code>Post.insert</code> 被调用时（无论是在我们 app 的客户端代码调用，还是在浏览器控制台调用），服务器会逐个运行为 insert 设置的允许（allow）回调函数，直到其中一个返回 <code>true</code> 为止。如果这样的允许回调函数不存在，服务器就不会允许 insert 操作，并给客户端返回一个 <code>403</code> 错误。</p>
          
          <p>类似地，我们也可以定义一个或者多个拒绝 <code>deny</code> 回调函数。如果其中一个回调函数返回 <code>true</code>，操作就会被取消，并且返回 <code>403</code>。这意味着，一个成功的 insert 操作要求至少一个返回 <code>true</code> 的允许 <code>allow</code> 回调函数，并且<em>所有</em>拒绝 <code>deny</code> 回调函数都返回 <code>false</code>。</p>
          
          <figure class="diagram "><img src="DiscoverMeteor_files/allow_deny2x.png" alt="注：n/e 表示该函数没有被执行"><figcaption>注：n/e 表示该函数没有被执行</figcaption></figure>
          
          <p>更直观地说，Meteor 从拒绝回调函数开始，然后是 <code>allow</code> 函数，逐一执行，直到有一个返回 <code>true</code>。</p>
          
          <p>这个模式的一个实际例子就是，建立两个 <code>allow()</code> 允许回调函数，一个用于检查帖子是否属于当前用户，另外一个用于检查当前用户是否管理员。如果当前用户是管理员，由于至少有一个回调函数返回 <code>true</code>，那就确保他们可以更新任何帖子。</p>
          
          <h3>延迟补偿</h3>
          
          <p>还记得我们前面说过，数据库的可变函数（例如 <code>.update()</code>）使用了一种延迟补偿技术。所以，当你尝试从浏览器的控制台删除一篇不属于你的帖子的时候，你会看到帖子短时间内消失，但马上又会重新出现。这是因为帖子并没有真正从后台删除，删除操作被后台拒绝了。</p>
          
          <p>这样的行为在控制台上不是问题（开发者可以随意支配数据进行开发）。但是，你需要确保这样的行为不会出现在用户界面上。比如说，你需要确保对于用户不能删除的帖子，用户不会看到删除键。</p>
          
          <p>庆幸的是，你可以在客户端和服务端使用一样的代码进行权限管理（例如，你可以写一个 <code>canDeletePost(user, post)</code> 函数，把它放在一个共享的 <code>/lib</code> 文件夹下面），这样做通常不需要太多额外的代码。</p>
          
          <h3>服务端权限</h3>
          
          <p>只有来自客户端的数据库操作需要被权限系统验证。服务端的<em>所有</em>操作都被认定为安全的，不需要被权限系统验证。</p>
          
          <p>这意味着如果你创建了一个服务端函数 <code>deletePost</code>，而且这个函数可以被客户端执行，那么任何用户都可以删除任何帖子了。因此，你可能不想那么做，除非你在函数中也验证用户权限。</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="errors">错误</h2>
            <span class="chapter-number">9</span>
          </div>
          <p>仅使用浏览器标准的 <code>alert()</code> 对话窗去警告用户他们的提交有错误有那么一点不令人满意，而且显然不是一个良好的用户体验。我们可以做得更好。</p>
          
          <p>相反，让我们建立一个更加灵活的错误报告机制，来更好地在不打断流程的情况下告诉用户到底发生了什么。</p>
          
          <p>我们要实现一个简单的系统，在窗口右上角显示新的错误信息，类似于流行的 Mac OS 应用程序 <a href="http://growl.info/">Growl</a>。</p>
          
          <h3>介绍本地集合（Local collection）</h3>
          
          <p>一开始，我们需要创建一个集合来存储我们的错误。既然错误只与当前会话相关，而且不需要以任何方式长久存在，我们要在这做点新鲜的事儿，创建一个<em>本地集合（Local collection）</em>。这意味着，错误 <code>Errors</code> 集合将会只存在于<em>浏览器</em>中，并且将不作任何尝试去同步回服务器。</p>
          
          <p>为实现它，我们在 <code>client</code> 文件夹中创建错误（确保这集合只在客户端存在），我们将它的 MongoDB 集合命名为 <code>null</code> （因为集合的数据将不会保存在服务器端的数据库中）：</p>
          <pre class="highlight javascript"><span class="c1">// 本地（仅客户端）集合
</span><span class="nx">Errors</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span></pre>
          <div class="caption">client/helpers/errors.js</div>
          
          <p>一开始，我们应该建立一个可以储存错误的集合。介于错误只是对于当前的会话，我们将采用及时性集合。这就意味着错误集合只存在于当前的浏览器，该集合不会与服务端同步。</p>
          
          <p>既然集合已经建立了，我们可以创建一个 <code>throwError</code> 函数用来添加新的错误。我们不需要担心 <code>allow</code> 和 <code>deny</code> 或其他任何的安全考虑，因为这个集合对于当前用户是“本地的”。</p>
          <pre class="highlight javascript"><span class="nx">throwError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Errors</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">message</span><span class="p">:</span> <span class="nx">message</span><span class="p">});</span>
<span class="p">};</span></pre>
          <div class="caption">client/helpers/errors.js</div>
          
          <p>使用本地集合去存储错误的优势在于，就像所有集合一样，它是响应性的————意味着我们可以以显示其他任何集合数据的同样的方式，去响应性地显示错误。</p>
          
          <h3>显示错误</h3>
          
          <p>我们将在主布局的顶部插入错误信息：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"layout"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    {{&gt; header}}
    {{&gt; errors}}
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main"</span> <span class="na">class=</span><span class="s">"row-fluid"</span><span class="nt">&gt;</span>
      {{&gt; yield}}
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/application/layout.html</div><div class="lines-highlight" data-lines="4" data-class="added"></div>
          
          <p>让我们现在在 <code>errors.html</code> 中创建 <code>errors</code> 和 <code>error</code> 模版：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"errors"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"errors"</span><span class="nt">&gt;</span>
    {{#each errors}}
      {{&gt; error}}
    {{/each}}
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span>

<span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"error"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-danger"</span> <span class="na">role=</span><span class="s">"alert"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"close"</span> <span class="na">data-dismiss=</span><span class="s">"alert"</span><span class="nt">&gt;</span><span class="ni">&amp;times;</span><span class="nt">&lt;/button&gt;</span>
    {{message}}
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/includes/errors.html</div>
          
          <div class="note"><h3>Twin 模版</h3>
          
          <p>你可能注意到我们在一个文件里面建立了两个模板。直到现在我们一直在遵循“一个文件， 一个模板”的标准，但对于 Meteor 而言，我们把所有模板放在同一个文件里也是一样的（但是这会让 <code>main.html</code> 的代码变得非常混乱！）。</p>
          
          <p>在当前情况下，因为这两个错误模板都比较小，我们破例将它们放在一个文件里，使我们的 repo 代码库更干净些。</p>
          </div>
          
          <p>我们只需要加上我们的模板 helper 就可以大功告成了！</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">errors</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Errors</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/includes/errors.js</div>
          
          <p>你可以尝试手动测试我们的新错误消息了。打开浏览器控制台，并输入：</p>
          <pre class="highlight javascript"><span class="nx">throwError</span><span class="p">(</span><span class="s2">"我就是一个错误!"</span><span class="p">);</span></pre>
          <figure class="screenshot "><img src="DiscoverMeteor_files/9-1.png" alt="测试错误消息。"><figcaption>测试错误消息。</figcaption></figure>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 9-1</h4><p>基本的错误报告。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter9-1" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter9-1.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <div class="note"><h3>两种类型的错误</h3>
          
          <p>在这一点上，重要的是要把“应用级（app-level）”的错误和“代码级（code-level）”的错误区别开来。</p>
          
          <p><strong>应用级</strong>错误一般是由用户触发，用户从而能够对症采取行动。这些包括像验证错误、权限错误、“未找到”错误，等等。这是是那种你希望展现给用户，以帮助他们解决他们刚刚遇到的任何问题的错误。</p>
          
          <p><strong>代码级</strong>错误，作为另一种类型，是实际的代码 bug 非期待情况下触发的，你可能<em>不希望</em>将错误直接呈现给用户，而是通过比如第三方错误跟踪服务（比如 <a href="http://kadira.io/">Kadira</a>）去跟踪错误。</p>
          
          <p>在本章中，我们将重点放在处理第一种类型的错误，而不是去抓虫子（bug）。</p>
          </div>
          
          <h3>创建错误</h3>
          
          <p>我们知道怎样显示错误，但我们还需要在发现之前去触发错误。实际上我们已经建立了良好的错误情境：重复帖子的警告。我们简单地用新的 <code>throwError</code> 函数去替代 <code>postSubmit</code> 事件 helper 中的 <code>alert</code> 调用：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postSubmit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'submit form'</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">url</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=url]'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="na">title</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=title]'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">};</span>

    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">'postInsert'</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// display the error to the user and abort
</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">throwError</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>

      <span class="c1">// show this result but route anyway
</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">postExists</span><span class="p">)</span>
        <span class="nx">throwError</span><span class="p">(</span><span class="s1">'This link has already been posted'</span><span class="p">);</span>

      <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">'postPage'</span><span class="p">,</span> <span class="p">{</span><span class="na">_id</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">_id</span><span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_submit.js</div><div class="lines-highlight" data-lines="13,17" data-class="added"></div>
          
          <p>既然到此，我们也针对 <code>postEdit</code> 事件 helper 做同样的事情：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postEdit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'submit form'</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">currentPostId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">postProperties</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">url</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=url]'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="na">title</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=title]'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nx">Posts</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">currentPostId</span><span class="p">,</span> <span class="p">{</span><span class="na">$set</span><span class="p">:</span> <span class="nx">postProperties</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// display the error to the user
</span>        <span class="nx">throwError</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">'postPage'</span><span class="p">,</span> <span class="p">{</span><span class="na">_id</span><span class="p">:</span> <span class="nx">currentPostId</span><span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="c1">//...
</span><span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_edit.js</div><div class="lines-highlight" data-lines="15" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 9-2</h4><p>实际使用错误报告。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter9-2" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter9-2.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>亲自试一试：尝试建立一个帖子并输入 URL <code>http://meteor.com</code>。因为这个 URL 已经存在了，你可以看到：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/9-2.png" alt="触发一个错误"><figcaption>触发一个错误</figcaption></figure>
          
          <h3>清理错误</h3>
          
          <p>你会注意到错误消息在几秒钟后自动消失。这是因为本书开头我们往样式表中添加的一些 CSS 而产生的魔力：</p>
          <pre class="highlight css"><span class="k">@keyframes</span> <span class="n">fadeOut</span> <span class="p">{</span>
  <span class="nt">0</span><span class="o">%</span> <span class="p">{</span><span class="nl">opacity</span><span class="p">:</span> <span class="m">0</span><span class="p">;}</span>
  <span class="nt">10</span><span class="o">%</span> <span class="p">{</span><span class="nl">opacity</span><span class="p">:</span> <span class="m">1</span><span class="p">;}</span>
  <span class="nt">90</span><span class="o">%</span> <span class="p">{</span><span class="nl">opacity</span><span class="p">:</span> <span class="m">1</span><span class="p">;}</span>
  <span class="nt">100</span><span class="o">%</span> <span class="p">{</span><span class="nl">opacity</span><span class="p">:</span> <span class="m">0</span><span class="p">;}</span>
<span class="p">}</span>

<span class="o">//...</span>

<span class="nc">.alert</span> <span class="p">{</span>
  <span class="nl">animation</span><span class="p">:</span> <span class="n">fadeOut</span> <span class="n">2700ms</span> <span class="n">ease-in</span> <span class="m">0s</span> <span class="m">1</span> <span class="n">forwards</span><span class="p">;</span>
  <span class="err">//...</span>
<span class="p">}</span></pre>
          <div class="caption">client/stylesheets/style.css</div>
          
          <p>我们定义了一个有四帧透明度属性变化（分别是 0%、10%、90% 和 100% 贯穿整个动画过程）的 <code>fadeOut</code> CSS 动画，并附在了 <code>.alert</code> class 样式。</p>
          
          <p>动画时长为 2700 毫秒，使用 <code>ease-in</code> 效果，有 0 秒延迟，运行一次，当动画完成时，最后停留在最后一帧。</p>
          
          <div class="note"><h3>动画 vs 动画</h3>
          
          <p>你也许在想为什么我们使用基于 CSS 的动画（预先定义，并且在我们应用控制以外），而不用 Meteor 本身来控制动画。</p>
          
          <p>虽然 Meteor 的确提供插入动画的支持，但是我们想在本章专注于错误。所以我们现在使用“笨”CSS 动画，我们把比较炫丽的东西留在以后的动画章节。</p>
          </div>
          
          <p>这可以工作了，但是如果你要触发多个错误（比如，通过提交三次同一个连接），你会看到错误信息会堆叠在一起：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/9-3.png" alt="堆栈溢出。"><figcaption>堆栈溢出。</figcaption></figure>
          
          <p>这是因为虽然 <code>.alert</code> 元素在视觉上消失了，但仍存留在 DOM 中。我们需要修正这个问题。</p>
          
          <p>这正是 Meteor 发光的情形。由于 <code>Errors</code> 集合是响应性的，我们要做的就是将旧的错误从集合中删除！</p>
          
          <p>我们用 <code>Meteor.setTimeout</code> 指定在一定时间（当前情形，3000毫秒）后执行一个回调函数。</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">errors</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Errors</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Template</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">onRendered</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
  <span class="nx">Meteor</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">Errors</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
  <span class="p">},</span> <span class="mi">3000</span><span class="p">);</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/includes/errors.js</div><div class="lines-highlight" data-lines="7~12" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 9-3</h4><p>在3秒后清除错误消息。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter9-3" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter9-3.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>一旦模板在浏览器中渲染完毕，<a href="http://docs.meteor.com/#/full/template_onRendered"><code>onRendered</code></a> 回调函数被触发。其中，<code>this</code> 是指当前模板实例，而 <code>this.data</code> 是当前被渲染的对象的数据（这种情况下是，一个错误）。</p>
          
          <h3>寻求验证</h3>
          
          <p>到现在为止，我们还没有对表单进行任何验证。至少，我们想让用户为新帖子提供 URL 和标题。那么我们确保他们这么做。</p>
          
          <p>我们要做两件事：第一，我们给任何有问题的表单字段的父 <code>div</code> 标签一个特别的 <code>has-error</code> CSS class。第二，我们在字段下方显示一个有用的错误消息。</p>
          
          <p>首先，我们要准备 <code>postSubmit</code> 模板来包含这些新 helper：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postSubmit"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"main form"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group {{errorClass 'url'}}"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">"control-label"</span> <span class="na">for=</span><span class="s">"url"</span><span class="nt">&gt;</span>URL<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"controls"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">id=</span><span class="s">"url"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">""</span> <span class="na">placeholder=</span><span class="s">"Your URL"</span> <span class="na">class=</span><span class="s">"form-control"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"help-block"</span><span class="nt">&gt;</span>{{errorMessage 'url'}}<span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group {{errorClass 'title'}}"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">"control-label"</span> <span class="na">for=</span><span class="s">"title"</span><span class="nt">&gt;</span>Title<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"controls"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"title"</span> <span class="na">id=</span><span class="s">"title"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">""</span> <span class="na">placeholder=</span><span class="s">"Name your post"</span> <span class="na">class=</span><span class="s">"form-control"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"help-block"</span><span class="nt">&gt;</span>{{errorMessage 'title'}}<span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Submit"</span> <span class="na">class=</span><span class="s">"btn btn-primary"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/post_submit.html</div><div class="lines-highlight" data-lines="3,7,10,14" data-class="added"></div>
          
          <p>注意我们传递参数（分别是 <code>url</code> 和 <code>title</code>）到每个 helper。这让我们两次重复使用同一个 helper，基于参数修改它的行为。</p>
          
          <p>现在到了有趣的部分：使这些 helper 真正做点什么事情。</p>
          
          <p>我们会用会话 <strong>Session</strong> 去存储包含任何潜在错误的 <code>postSubmitErrors</code> 对象。当用户使用表单时，这个对象会改变，也就是响应性地更新表单代码和内容。</p>
          
          <p>首先，当 <code>postSubmit</code> 模板被创建时，我们初始化对象。这确保用户不会看到上次访问该页面时遗留下的旧的错误消息。</p>
          
          <p>然后定义我们的两个模板 helper，紧盯 <code>Session.get('postSubmitErrors')</code> 的 <code>field</code> 属性（<code>field</code> 指 <code>url</code> 或 <code>title</code> 取决于我们如何调用 helper）。</p>
          
          <p><code>errorMessage</code> 只是返回消息本身，而 <code>errorClass</code> 检查消息是否<em>存在</em>，如果为真返回 <code>has-error</code>。</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postSubmit</span><span class="p">.</span><span class="nx">onCreated</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'postSubmitErrors'</span><span class="p">,</span> <span class="p">{});</span>
<span class="p">});</span>

<span class="nx">Template</span><span class="p">.</span><span class="nx">postSubmit</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">errorMessage</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'postSubmitErrors'</span><span class="p">)[</span><span class="nx">field</span><span class="p">];</span>
  <span class="p">},</span>
  <span class="na">errorClass</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!!</span><span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'postSubmitErrors'</span><span class="p">)[</span><span class="nx">field</span><span class="p">]</span> <span class="p">?</span> <span class="s1">'has-error'</span> <span class="p">:</span> <span class="s1">''</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">client/templates/posts/post_submit.js</div><div class="lines-highlight" data-lines="1~12" data-class="added"></div>
          
          <p>你可以测试 helper 是否工作正常，打开浏览器控制台并输入以下代码：</p>
          <pre class="highlight javascript"><span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'postSubmitErrors'</span><span class="p">,</span> <span class="p">{</span><span class="na">title</span><span class="p">:</span> <span class="s1">'Warning! Intruder detected. Now releasing robo-dogs.'</span><span class="p">});</span></pre>
          <div class="caption">浏览器控制台</div>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/9-4.png" alt="红色警告！Red alert!"><figcaption>红色警告！Red alert!</figcaption></figure>
          
          <p>下一步将 <code>postSubmitErrors</code> Session 会话对象绑在表单上。</p>
          
          <p>开始之前，我们在 <code>posts.js</code> 中添加一个新的 <code>validatePost</code> 函数来监视 <code>post</code> 对象，返回一个包含任何错误相关消息的（即，<code>title</code> 或 <code>url</code> 字段是否未填写）<code>errors</code> 对象：</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">validatePost</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">post</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">post</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span>
    <span class="nx">errors</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">"请填写标题"</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">post</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>
    <span class="nx">errors</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span>  <span class="s2">"请填写 URL"</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">errors</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//...
</span></pre>
          <div class="caption">lib/collections/posts.js</div><div class="lines-highlight" data-lines="3~13" data-class="added"></div>
          
          <p>我们通过 <code>postSubmit</code> 事件 helper 去调用这个函数：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postSubmit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'submit form'</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">url</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=url]'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="na">title</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=title]'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="nx">validatePost</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">title</span> <span class="o">||</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'postSubmitErrors'</span><span class="p">,</span> <span class="nx">errors</span><span class="p">);</span>

    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">'postInsert'</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 向用户显示错误信息并终止
</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">throwError</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>

      <span class="c1">// 显示这个结果且继续跳转
</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">postExists</span><span class="p">)</span>
        <span class="nx">throwError</span><span class="p">(</span><span class="s1">'This link has already been posted'</span><span class="p">);</span>

      <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">'postPage'</span><span class="p">,</span> <span class="p">{</span><span class="na">_id</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">_id</span><span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_submit.js</div><div class="lines-highlight" data-lines="10~12" data-class="added"></div>
          
          <p>注意如果出现任何错误，我们用 <code>return</code> 终止 helper 执行，而不是我们要实际地返回这个值。</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/9-5.png" alt="抓到错误."><figcaption>抓到错误.</figcaption></figure>
          
          <h3>服务器端验证</h3>
          
          <p>我们还没有完成。我们在<em>客户端</em>验证 URL 和标题是否存在，但是在<em>服务器端</em>呢？毕竟，还会有人仍然尝试通过浏览器控制台输入一个空帖子来手动调用 <code>postInsert</code> 方法。</p>
          
          <p>即使我们不需要在服务器端显示任何错误消息，但是我们依然要利用好那个 <code>validatePost</code> 函数。除了这次我们在 <code>postInsert</code> <em>方法</em>内调用它，而不只是在事件 helper：</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>
  <span class="na">postInsert</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">check</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nb">String</span><span class="p">);</span>
    <span class="nx">check</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">title</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
      <span class="na">url</span><span class="p">:</span> <span class="nb">String</span>
    <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="nx">validatePost</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">title</span> <span class="o">||</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s1">'invalid-post'</span><span class="p">,</span> <span class="s2">"你必须为你的帖子填写标题和 URL"</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">postWithSameLink</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">url</span><span class="p">:</span> <span class="nx">postAttributes</span><span class="p">.</span><span class="nx">url</span><span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">postWithSameLink</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="na">postExists</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">_id</span><span class="p">:</span> <span class="nx">postWithSameLink</span><span class="p">.</span><span class="nx">_id</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
      <span class="na">author</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
      <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="nx">postId</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">lib/collections/posts.js</div><div class="lines-highlight" data-lines="9~11" data-class="added"></div>
          
          <p>再次，用户正常情况下不必看到“你必须 为你的帖子填写标题和 URL”的消息。这仅会在当用户想绕过我们煞费苦心创建的用户界面而直接使用浏览器的情况下，才会显示。</p>
          
          <p>为了测试，打开浏览器控制台，输入一个没有 URL 的帖子：</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">'postInsert'</span><span class="p">,</span> <span class="p">{</span><span class="na">url</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="s1">'No URL here!'</span><span class="p">});</span></pre>
          <p>如果我们完成得顺利的话，你会得到一堆吓人的代码 和“你必须为你的帖子填写标题和 URL”的消息。</p>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 9-4</h4><p>验证帖子提交内容。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter9-4" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter9-4.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <h3>编辑验证</h3>
          
          <p>为了更加完善，我们为帖子<em>编辑</em>表单添加相同的验证。代码看起来十分相似。首先，是模板：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postEdit"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"main form"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group {{errorClass 'url'}}"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">"control-label"</span> <span class="na">for=</span><span class="s">"url"</span><span class="nt">&gt;</span>URL<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"controls"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">id=</span><span class="s">"url"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"{{url}}"</span> <span class="na">placeholder=</span><span class="s">"Your URL"</span> <span class="na">class=</span><span class="s">"form-control"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"help-block"</span><span class="nt">&gt;</span>{{errorMessage 'url'}}<span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group {{errorClass 'title'}}"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">"control-label"</span> <span class="na">for=</span><span class="s">"title"</span><span class="nt">&gt;</span>Title<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"controls"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"title"</span> <span class="na">id=</span><span class="s">"title"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"{{title}}"</span> <span class="na">placeholder=</span><span class="s">"Name your post"</span> <span class="na">class=</span><span class="s">"form-control"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"help-block"</span><span class="nt">&gt;</span>{{errorMessage 'title'}}<span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Submit"</span> <span class="na">class=</span><span class="s">"btn btn-primary submit"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;hr/&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"btn btn-danger delete"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Delete post<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/post_edit.html</div><div class="lines-highlight" data-lines="3,7,10,14" data-class="added"></div>
          
          <p>然后是模板 helper：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postEdit</span><span class="p">.</span><span class="nx">onCreated</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'postEditErrors'</span><span class="p">,</span> <span class="p">{});</span>
<span class="p">});</span>

<span class="nx">Template</span><span class="p">.</span><span class="nx">postEdit</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">errorMessage</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'postEditErrors'</span><span class="p">)[</span><span class="nx">field</span><span class="p">];</span>
  <span class="p">},</span>
  <span class="na">errorClass</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!!</span><span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'postEditErrors'</span><span class="p">)[</span><span class="nx">field</span><span class="p">]</span> <span class="p">?</span> <span class="s1">'has-error'</span> <span class="p">:</span> <span class="s1">''</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Template</span><span class="p">.</span><span class="nx">postEdit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'submit form'</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">currentPostId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">postProperties</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">url</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=url]'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="na">title</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=title]'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="nx">validatePost</span><span class="p">(</span><span class="nx">postProperties</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">title</span> <span class="o">||</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'postEditErrors'</span><span class="p">,</span> <span class="nx">errors</span><span class="p">);</span>

    <span class="nx">Posts</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">currentPostId</span><span class="p">,</span> <span class="p">{</span><span class="na">$set</span><span class="p">:</span> <span class="nx">postProperties</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 向用户显示错误消息
</span>        <span class="nx">throwError</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">'postPage'</span><span class="p">,</span> <span class="p">{</span><span class="na">_id</span><span class="p">:</span> <span class="nx">currentPostId</span><span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">},</span>

  <span class="s1">'click .delete'</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">confirm</span><span class="p">(</span><span class="s2">"Delete this post?"</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">currentPostId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
      <span class="nx">Posts</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">currentPostId</span><span class="p">);</span>
      <span class="nx">Router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="s1">'postsList'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_edit.js</div><div class="lines-highlight" data-lines="1~12,25~27,32" data-class="added"></div>
          
          <p>就像我们为帖子提交表单所做的，我们也想在服务器端验证帖子。请记住我们不是在用一个方法去编辑帖子，而是直接从客户端的 <code>update</code> 调用。</p>
          
          <p>这意味着我们必须添加一个新的 <code>deny</code> 回调函数：</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">Posts</span><span class="p">.</span><span class="nx">deny</span><span class="p">({</span>
  <span class="na">update</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="nx">fieldNames</span><span class="p">,</span> <span class="nx">modifier</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="nx">validatePost</span><span class="p">(</span><span class="nx">modifier</span><span class="p">.</span><span class="nx">$set</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">title</span> <span class="o">||</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">lib/collections/posts.js</div><div class="lines-highlight" data-lines="3~8" data-class="added"></div>
          
          <p>注意的是参数 <code>post</code> 是指<em>已存在的</em>帖子。我们想验证<em>更新</em>，所以我们在 <code>modifier</code> 的 <code>$set</code> 属性中调用 <code>validatePost</code>（就像是 <code>Posts.update({$set: {title: ..., url: ...}})</code>）。</p>
          
          <p>这会正常运行，因为 <code>modifier.$set</code> 像整个 <code>post</code> 对象那样包含同样两个 <code>title</code> 和 <code>url</code> 属性。当然，这也的确意味着只部分更新 <code>title</code> 或者 <code>url</code> 是不行的，但是实践中不应有问题。</p>
          
          <p>你也许注意到，这是我们第二个 <code>deny</code> 回调。当添加多个 <code>deny</code> 回调时，如果任何一个回调返回 <code>true</code>，运行就会失败。在此例中，这意味着 <code>update</code> 只有在面向 <code>title</code> 和 <code>url</code> 两个字段时才会成功，并且这些字段不能为空。</p>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 9-5</h4><p>当编辑时，验证帖子内容。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter9-5" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter9-5.meteor.com/" target="_blank">查看演示</a></div></div>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="creating-a-meteor-package">创建 Meteor Package</h2>
            <span class="sidebar-marker">Sidebar</span>
            <span class="chapter-number">9.5</span>
          </div>
          <p>我们在报告错误的工作中已经创建了可重复使用的模式，为什么不把它打包让 Meteor 社区的其他人都可使用呢？</p>
          
          <p>为了开始，我们需要一个 Meteor 开发者账号。你可以从 <a href="http://zh.discovermeteor.com/meteor.com">meteor.com</a> 申请，但是很有可能当你注册这本书的时候已经得到了。不管哪种情况，你应该搞清楚你的用户名是什么，因为我们会在本章中大量使用它。</p>
          
          <p>在本章中我们使用用户名 <code>tmeasday</code>，当然你也可以换成你自己的。</p>
          
          <p>首先我们需要创建一个结构来存放新的包。使用命令 <code>meteor create --package tmeasday:errors</code> 来完成。需要注意的是 Meteor 已经创建了一个名为 <code>packages/tmeasday:errors/</code> 的文件夹和一些文件。我们从编辑 <code>package.js</code> 开始，这文件会告诉 Meteor 如果使用这个包，有什么对象或函数要导出。</p>
          <pre class="highlight javascript"><span class="nx">Package</span><span class="p">.</span><span class="nx">describe</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="s2">"tmeasday:errors"</span><span class="p">,</span>
  <span class="na">summary</span><span class="p">:</span> <span class="s2">"A pattern to display application errors to the user"</span><span class="p">,</span>
  <span class="na">version</span><span class="p">:</span> <span class="s2">"1.0.0"</span>
<span class="p">});</span>

<span class="nx">Package</span><span class="p">.</span><span class="nx">onUse</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">where</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">api</span><span class="p">.</span><span class="nx">versionsFrom</span><span class="p">(</span><span class="s1">'0.9.0'</span><span class="p">);</span>

  <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">([</span><span class="s1">'minimongo'</span><span class="p">,</span> <span class="s1">'mongo-livedata'</span><span class="p">,</span> <span class="s1">'templating'</span><span class="p">],</span> <span class="s1">'client'</span><span class="p">);</span>

  <span class="nx">api</span><span class="p">.</span><span class="nx">addFiles</span><span class="p">([</span><span class="s1">'errors.js'</span><span class="p">,</span> <span class="s1">'errors_list.html'</span><span class="p">,</span> <span class="s1">'errors_list.js'</span><span class="p">],</span> <span class="s1">'client'</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="kr">export</span><span class="p">)</span> 
    <span class="nx">api</span><span class="p">.</span><span class="kr">export</span><span class="p">(</span><span class="s1">'Errors'</span><span class="p">);</span>
<span class="p">});</span></pre>
          <div class="caption">packages/tmeasday:errors/package.js</div>
          
          <p>当开发现实使用的 package 时，非常好的习惯就是在 <code>git</code> 部分的 <code>Package.describe</code> 代码块中，填写你代码库的 Git URL（比如，<code>https://github.com/tmeasday/meteor-errors.git</code>）。这样的话，用户可以浏览源代码，并且（假设你使用 GitHub）你的 package 的 readme 会显示在 Atomsphere 上。</p>
          
          <p>让我们添加 3 个文件到 package 中。（我们可以删除 Meteor 自动添加的模板）我们可以从 Microscope 中 pull 这些文件而不用做太多修改，除了一些合适的命名和稍微清晰的 API：</p>
          <pre class="highlight javascript"><span class="nx">Errors</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// Local (client-only) collection
</span>  <span class="nl">collection</span><span class="p">:</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span>

  <span class="nl">throw</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">message</span><span class="p">:</span> <span class="nx">message</span><span class="p">,</span> <span class="na">seen</span><span class="p">:</span> <span class="kc">false</span><span class="p">})</span>
  <span class="p">}</span>
<span class="p">};</span></pre>
          <div class="caption">packages/tmeasday:errors/errors.js</div>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"meteorErrors"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"errors"</span><span class="nt">&gt;</span>
    {{#each errors}}
      {{&gt; meteorError}}
    {{/each}}
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span>

<span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"meteorError"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-danger"</span> <span class="na">role=</span><span class="s">"alert"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"close"</span> <span class="na">data-dismiss=</span><span class="s">"alert"</span><span class="nt">&gt;</span><span class="ni">&amp;times;</span><span class="nt">&lt;/button&gt;</span>
    {{message}}
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">packages/tmeasday:errors/errors_list.html</div>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">meteorErrors</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">errors</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Template</span><span class="p">.</span><span class="nx">meteorError</span><span class="p">.</span><span class="nx">rendered</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
  <span class="nx">Meteor</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
  <span class="p">},</span> <span class="mi">3000</span><span class="p">);</span>
<span class="p">};</span></pre>
          <div class="caption">packages/tmeasday:errors/errors_list.js</div>
          
          <h3>在 Microscope 中测试 package</h3>
          
          <p>现在我们需要对 Microscope 做本地测试，以确保代码工作正确。为了链接包到项目，我们用命令 <code>meteor add tmeasday:errors</code>。然后，需要删除已经变得多余的现有文件：</p>
          <pre class="highlight shell">rm client/helpers/errors.js
rm client/templates/includes/errors.html
rm client/templates/includes/errors.js</pre>
          <div class="caption">在 bash console 上删除旧文件</div>
          
          <p>我们需要做的另一件事情是做一些小的更新，使用正确的 API：</p>
          <pre class="highlight html">  {{&gt; header}}
  {{&gt; meteorErrors}}</pre>
          <div class="caption">client/templates/application/layout.html</div>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">'postInsert'</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// display the error to the user
</span>    <span class="nx">Errors</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
</pre>
          <div class="caption">client/templates/posts/post_submit.js</div>
          <pre class="highlight javascript"><span class="nx">Posts</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">currentPostId</span><span class="p">,</span> <span class="p">{</span><span class="na">$set</span><span class="p">:</span> <span class="nx">postProperties</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// display the error to the user
</span>    <span class="nx">Errors</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span></pre>
          <div class="caption">client/templates/posts/post_edit.js</div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 9-5-1</h4><p>创建和链接基本的 errors package。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/sidebar9-5-1" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-sidebar9-5-1.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>一旦这些修改完成，我们就可恢复原来分包前的行为了。</p>
          
          <h3>写测试</h3>
          
          <p>开发包的第一个步骤是在一个应用程序中测试它，但接下来就是写一个测试套件，正确的测试包的行为。Meteor 本身自带 Tinytest（内置的包测试仪），它可以很容易地运行测试套件，以便与他人分享包时确保正确。</p>
          
          <p>让我们创建一个测试文件，使用 Tinytest 来运行一些对新的包测试：</p>
          <pre class="highlight javascript"><span class="nx">Tinytest</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s2">"Errors - collection"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">test</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">test</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({}).</span><span class="nx">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>

  <span class="nx">Errors</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="s1">'A new error!'</span><span class="p">);</span>
  <span class="nx">test</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({}).</span><span class="nx">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>

  <span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">({});</span>
<span class="p">});</span>

<span class="nx">Tinytest</span><span class="p">.</span><span class="nx">addAsync</span><span class="p">(</span><span class="s2">"Errors - template"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">test</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>  
  <span class="nx">Errors</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="s1">'A new error!'</span><span class="p">);</span>
  <span class="nx">test</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({}).</span><span class="nx">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>

  <span class="c1">// render the template
</span>  <span class="nx">UI</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">UI</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">Template</span><span class="p">.</span><span class="nx">meteorErrors</span><span class="p">),</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>

  <span class="nx">Meteor</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({}).</span><span class="nx">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">done</span><span class="p">();</span>
  <span class="p">},</span> <span class="mi">3500</span><span class="p">);</span>
<span class="p">});</span></pre>
          <div class="caption">packages/tmeasday:errors/errors_tests.js</div>
          
          <p>在这些测试中，我们检查基本的 <code>Meteor.Errors</code> 的功能是否工作，以及再次确认该模板中的 <code>rendered</code> 代码是否仍在工作。</p>
          
          <p>我们不会在这里写 Meteor 包测试的所有细节（而且 API 尚未最终确定，很有可能会有变化），但希望它是在一定程度上自我解释其工作原理。</p>
          
          <p>使用下面的代码告诉 Meteor 如何在 <code>package.js</code> 中运行测试：</p>
          <pre class="highlight javascript"><span class="nx">Package</span><span class="p">.</span><span class="nx">onTest</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">api</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'tmeasday:errors'</span><span class="p">,</span> <span class="s1">'client'</span><span class="p">);</span>
  <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">([</span><span class="s1">'tinytest'</span><span class="p">,</span> <span class="s1">'test-helpers'</span><span class="p">],</span> <span class="s1">'client'</span><span class="p">);</span>  

  <span class="nx">api</span><span class="p">.</span><span class="nx">addFiles</span><span class="p">(</span><span class="s1">'errors_tests.js'</span><span class="p">,</span> <span class="s1">'client'</span><span class="p">);</span>
<span class="p">});</span></pre>
          <div class="caption">packages/tmeasday:errors/package.js</div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 9-5-2</h4><p>为 package 添加测试。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/sidebar9-5-2" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-sidebar9-5-2.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>然后我们就可以运行测试：</p>
          <pre class="highlight shell">meteor <span class="nb">test</span>-packages tmeasday:errors</pre>
          <div class="caption">终端 Terminal</div>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/s7-1.png" alt="通过所有测试"><figcaption>通过所有测试</figcaption></figure>
          
          <h3>发布 package</h3>
          
          <p>现在我们要发布这个包，把它推送到 Meteor package 服务器，在 Atmopshere 中显示出来，让全世界的人都可使用。</p>
          
          <p>幸运的是这很容易。我们只是 <code>cd</code> 到包的目录，运行命令 <code>meteor publish --create</code>：</p>
          <pre class="highlight shell"><span class="nb">cd </span>packages/tmeasday:errors
meteor publish --create</pre>
          <div class="caption">终端 Terminal</div>
          
          <p>既然包已经发布，我们可以从项目中删除它，然后直接从 Atmopshere 重新添加它：</p>
          <pre class="highlight shell">rm -r packages/tmeasday:errors
meteor add tmeasday:errors</pre>
          <div class="caption">终端 Terminal（在应用最高级别运行）</div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 9-5-4</h4><p>从开发 tree 中删除 package。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/sidebar9-5-4" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-sidebar9-5-4.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>现在我们应该看到 Meteor 第一次下载了我们的 package。很棒！</p>
          
          <p>和往常的附录章节一样，确保先恢复你所做的改动，然后再进行下一章（或者在阅读本书其他章节时，考虑你所做的改动。）</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="comments">评论</h2>
            <span class="chapter-number">10</span>
          </div>
          <p>社交新闻网站的目标是创建一个用户社区，如果没有提供一种方式让人们互相交流，这将是很难做到的。因此在本章中，我们添加评论！</p>
          
          <p>我们首先创建一个新的集来存储评论，并在该集中添加一些初始数据。</p>
          <pre class="highlight javascript"><span class="nx">Comments</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">);</span></pre>
          <div class="caption">lib/collections/comments.js</div>
          <pre class="highlight javascript"><span class="c1">// Fixture data
</span><span class="k">if</span> <span class="p">(</span><span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">()</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>

  <span class="c1">// create two users
</span>  <span class="kd">var</span> <span class="nx">tomId</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">profile</span><span class="p">:</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'Tom Coleman'</span> <span class="p">}</span>
  <span class="p">});</span>
  <span class="kd">var</span> <span class="nx">tom</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">tomId</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">sachaId</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">profile</span><span class="p">:</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'Sacha Greif'</span> <span class="p">}</span>
  <span class="p">});</span>
  <span class="kd">var</span> <span class="nx">sacha</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">sachaId</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">telescopeId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'Introducing Telescope'</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://sachagreif.com/introducing-telescope/'</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
  <span class="p">});</span>

  <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">postId</span><span class="p">:</span> <span class="nx">telescopeId</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="na">body</span><span class="p">:</span> <span class="s1">'Interesting project Sacha, can I get involved?'</span>
  <span class="p">});</span>

  <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">postId</span><span class="p">:</span> <span class="nx">telescopeId</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="na">body</span><span class="p">:</span> <span class="s1">'You sure can Tom!'</span>
  <span class="p">});</span>

  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'Meteor'</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://meteor.com'</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
  <span class="p">});</span>

  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'The Meteor Book'</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://themeteorbook.com'</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
  <span class="p">});</span>
<span class="p">}</span></pre>
          <div class="caption">server/fixtures.js</div>
          
          <p>不要忘记来发布和订阅我们这个新的集合：</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
<span class="p">});</span></pre>
          <div class="caption">server/publications.js</div><div class="lines-highlight" data-lines="5,6,7" data-class="added"></div>
          <pre class="highlight javascript"><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
  <span class="na">layoutTemplate</span><span class="p">:</span> <span class="s1">'layout'</span><span class="p">,</span>
  <span class="na">loadingTemplate</span><span class="p">:</span> <span class="s1">'loading'</span><span class="p">,</span>
  <span class="na">notFoundTemplate</span><span class="p">:</span> <span class="s1">'notFound'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">),</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">)];</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="5~7" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 10-1</h4><p>添加评论集合、发布/订阅，和测试数据。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter10-1" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter10-1.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>请注意，为了使用新的数据，你需要命令 <code>Meteor reset</code> 清除数据库。不要忘了创建一个新的用户，并重新登录！</p>
          
          <p>首先，我们在数据库中创建了几个（假的）用户，并从数据库中用他们的 <code>id</code> 选择出来。然后给第一篇添加注释，链接注释到帖子（<code>postId</code>）和用户（<code>userId</code>）。同时我们还添加了提交日期，评论内容和一个非规范化的作者 <code>author</code> 项。</p>
          
          <p>此外我们在路由器中增加等待一个含有评论和帖子订阅的<em>数组</em>。</p>
          
          <h3>显示评论</h3>
          
          <p>把评论存到数据库，同时还需要在评论页上显示。</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postPage"</span><span class="nt">&gt;</span>
  {{&gt; postItem}}
  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"comments"</span><span class="nt">&gt;</span>
    {{#each comments}}
      {{&gt; commentItem}}
    {{/each}}
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/post_page.html</div><div class="lines-highlight" data-lines="3~7" data-class="added"></div>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postPage</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">comments</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">postId</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_page.js</div><div class="lines-highlight" data-lines="2~4" data-class="added"></div>
          
          <p>我们把 <code>{{#each comments}}</code> 块放在帖子模板里面，所以在 <code>comments</code> helper 里，<code>this</code> 指向的是当前帖子。要找到相关的评论，我们可通过 <code>postId</code> 属性找到链接到该帖子的评论。</p>
          
          <p>我们已经了解 helper 和 Spacebars 后，显示一个评论是相当简单的。我们将在 <code>templates</code> 下，创建一个新的 <code>comments</code> 目录和一个新的 <code>commentItem</code> 模板，来存储所有的评论相关的信息：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"commentItem"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;li&gt;</span>
    <span class="nt">&lt;h4&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"author"</span><span class="nt">&gt;</span>{{author}}<span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"date"</span><span class="nt">&gt;</span>on {{submittedText}}<span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/h4&gt;</span>
    <span class="nt">&lt;p&gt;</span>{{body}}<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/li&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/comments/comment_item.html</div>
          
          <p>让我们编写一个模板 helper 来帮助我们把 <code>submitted</code> 提交日期格式人性化的日期格式：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">commentItem</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">submittedText</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">submitted</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/comments/comment_item.js</div>
          
          <p>然后，我们将在每个帖子中显示评论数：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postItem"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"post-content"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{url}}"</span><span class="nt">&gt;</span>{{title}}<span class="nt">&lt;/a&gt;&lt;span&gt;</span>{{domain}}<span class="nt">&lt;/span&gt;&lt;/h3&gt;</span>
      <span class="nt">&lt;p&gt;</span>
        submitted by {{author}},
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postPage'}}"</span><span class="nt">&gt;</span>{{commentsCount}} comments<span class="nt">&lt;/a&gt;</span>
        {{#if ownPost}}<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postEdit'}}"</span><span class="nt">&gt;</span>Edit<span class="nt">&lt;/a&gt;</span>{{/if}}
      <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postPage'}}"</span> <span class="na">class=</span><span class="s">"discuss btn btn-default"</span><span class="nt">&gt;</span>Discuss<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/post_item.html</div><div class="lines-highlight" data-lines="6,7" data-class="added"></div>
          
          <p>添加 <code>commentsCount</code> helper 到 <code>post_item.js</code> 中：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">ownPost</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">userId</span> <span class="o">===</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="na">domain</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'a'</span><span class="p">);</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="na">commentsCount</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">postId</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">}).</span><span class="nx">count</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_item.js</div><div class="lines-highlight" data-lines="9,10,11" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 10-2</h4><p>Display comments on `postPage`.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter10-2" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter10-2.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>现在您应该能够显示初始的评论并看到如下的内容：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/10-1.png" alt="显示评论"><figcaption>显示评论</figcaption></figure>
          
          <h3>提交新评论</h3>
          
          <p>让用户创建新的评论，这个过程将是非常类似过去我们允许用户创建新的帖子。</p>
          
          <p>首先我们通过在每个帖子底部增加一个提交框：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postPage"</span><span class="nt">&gt;</span>
  {{&gt; postItem}}

  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"comments"</span><span class="nt">&gt;</span>
    {{#each comments}}
      {{&gt; commentItem}}
    {{/each}}
  <span class="nt">&lt;/ul&gt;</span>

  {{#if currentUser}}
    {{&gt; commentSubmit}}
  {{else}}
    <span class="nt">&lt;p&gt;</span>Please log in to leave a comment.<span class="nt">&lt;/p&gt;</span>
  {{/if}}
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/post_page.html</div><div class="lines-highlight" data-lines="10~14" data-class="added"></div>
          
          <p>然后创建评论表单模板：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"commentSubmit"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">name=</span><span class="s">"comment"</span> <span class="na">class=</span><span class="s">"comment-form form"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group {{errorClass 'body'}}"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"controls"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"body"</span><span class="nt">&gt;</span>Comment on this post<span class="nt">&lt;/label&gt;</span>
            <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"body"</span> <span class="na">id=</span><span class="s">"body"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">rows=</span><span class="s">"3"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"help-block"</span><span class="nt">&gt;</span>{{errorMessage 'body'}}<span class="nt">&lt;/span&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"btn btn-primary"</span><span class="nt">&gt;</span>Add Comment<span class="nt">&lt;/button&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/comments/comment_submit.html</div>
          
          <p>在 <code>comment_submit.js</code> 中调用 <code>comment</code> 方法，提交新的评论，这是类似于过去提交帖子的方法：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">commentSubmit</span><span class="p">.</span><span class="nx">onCreated</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'commentSubmitErrors'</span><span class="p">,</span> <span class="p">{});</span>
<span class="p">});</span>

<span class="nx">Template</span><span class="p">.</span><span class="nx">commentSubmit</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">errorMessage</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'commentSubmitErrors'</span><span class="p">)[</span><span class="nx">field</span><span class="p">];</span>
  <span class="p">},</span>
  <span class="na">errorClass</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!!</span><span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'commentSubmitErrors'</span><span class="p">)[</span><span class="nx">field</span><span class="p">]</span> <span class="p">?</span> <span class="s1">'has-error'</span> <span class="p">:</span> <span class="s1">''</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Template</span><span class="p">.</span><span class="nx">commentSubmit</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'submit form'</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">$body</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'[name=body]'</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">comment</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">body</span><span class="p">:</span> <span class="nx">$body</span><span class="p">.</span><span class="nx">val</span><span class="p">(),</span>
      <span class="na">postId</span><span class="p">:</span> <span class="nx">template</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_id</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">errors</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s2">"Please write some content"</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'commentSubmitErrors'</span><span class="p">,</span> <span class="nx">errors</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">'commentInsert'</span><span class="p">,</span> <span class="nx">comment</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">commentId</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">){</span>
        <span class="nx">throwError</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">$body</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/comments/comment_submit.js</div>
          
          <p>类似以前 <code>post</code> 服务器端的 Meteor 方法，我们将建立一个 <code>comment</code> 的 Meteor 方法来创建评论，检查正确性后，插入到评论集合。</p>
          <pre class="highlight javascript"><span class="nx">Comments</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">);</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>
  <span class="na">commentInsert</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">commentAttributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">check</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nb">String</span><span class="p">);</span>
    <span class="nx">check</span><span class="p">(</span><span class="nx">commentAttributes</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">postId</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
      <span class="na">body</span><span class="p">:</span> <span class="nb">String</span>
    <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">commentAttributes</span><span class="p">.</span><span class="nx">postId</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">post</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s1">'invalid-comment'</span><span class="p">,</span> <span class="s1">'You must comment on a post'</span><span class="p">);</span>

    <span class="nx">comment</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">commentAttributes</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
      <span class="na">author</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
      <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">comment</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">lib/collections/comments.js</div><div class="lines-highlight" data-lines="3~25" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 10-3</h4><p>创建提交评论表单</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter10-3" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter10-3.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>这里没做什么太花哨的，只是检查该用户是否已经登录，该评论有一个内容，并且链接到一个帖子。</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/10-2.png" alt="评论提交表单"><figcaption>评论提交表单</figcaption></figure>
          
          <h3>控制订阅评论</h3>
          
          <p>如同以往一样，我们将发布属于所有帖子的全部评论到每个连接的客户端。这似乎有点浪费。毕竟在任何给定的时间段，实际上只使用该数据的一小部分。因此让我们提高发布和订阅评论的精度。</p>
          
          <p>如果仔细想想，我们需要订阅 <code>comments</code> 评论发布的时间，是当用户访问一个帖子的页面，而此刻只需要加载这个帖子的评论子集。</p>
          
          <p>第一步将改变我们订阅评论的方式。目前是<em>路由器</em>级订阅，这意味着当路由器初始化时，加载所有数据。</p>
          
          <p>但是现在希望我们的订阅依赖于路径参数，并且参数可以在任何时候改变。因此需要将我们的订阅代码从<em>路由器</em>级改到<em>路径</em>级。</p>
          
          <p>这样做的另一个后果：每当打开<em>路径</em>时加载数据，而不是初始化应用时加载它。这意味着你在程序内浏览时，会等待加载时间。除非你打算加载全部内容到客户端，这是一个不可避免的缺点。</p>
          
          <p>首先，在 <code>configure</code> 块中通过删除 <code>Meteor.subscribe('comments')</code>，停止预装全部评论（换句话说，要回以前的方法）：</p>
          <pre class="highlight javascript"><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
  <span class="na">layoutTemplate</span><span class="p">:</span> <span class="s1">'layout'</span><span class="p">,</span>
  <span class="na">loadingTemplate</span><span class="p">:</span> <span class="s1">'loading'</span><span class="p">,</span>
  <span class="na">notFoundTemplate</span><span class="p">:</span> <span class="s1">'notFound'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="5" data-class="added"></div>
          
          <p>我们将为 <code>postPage</code> 添加一个新的<em>路径</em>级的 <code>waitOn</code> 函数：</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/posts/:_id'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postPage'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="5~7" data-class="added"></div>
          
          <p>我们将 <code>this.params._id</code> 作为参数传递给订阅。所以让我们用这个新信息来确保限制评论属于当前帖子：</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">check</span><span class="p">(</span><span class="nx">postId</span><span class="p">,</span> <span class="nb">String</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">postId</span><span class="p">:</span> <span class="nx">postId</span><span class="p">});</span>
<span class="p">});</span></pre>
          <div class="caption">server/publications.js</div><div class="lines-highlight" data-lines="5~7" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 10-4</h4><p>设置简单的评论发布/订阅。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter10-4" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter10-4.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>这里有一个问题：当我们返回主页，显示所有的帖子有0条评论：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/10-3.png" alt="我们的评论消失了！"><figcaption>我们的评论消失了！</figcaption></figure>
          
          <h3>评论计数</h3>
          
          <p>这个问题的原因是：我们只装载 <code>postPage</code> 路径上的评论，所以当我们调用 <code>Comments.find({postId: this._id})</code> 中 <code>commentsCount</code> helper，Meteor 找不到必要的客户端数据为我们提供计数值。</p>
          
          <p>处理这一问题的最佳办法是<em>非规范化</em>的评论计数加到帖子中（如果你不明白这意味着什么，不用担心，接下来的附录会详解！）。正如我们将看到的，代码中复杂性稍微增加，但从不发布帖子列表的<em>全部</em>评论中，得到的执行性能改善是值得的。</p>
          
          <p>我们将通过在 <code>post</code> 数据结构中增加一个 <code>commentsCount</code> 属性来实现这一目标。首先，更新帖子的测试数据（用 <code>meteor reset</code> 去重载它们 —— 不要忘了之后重新创建你的帐户）：</p>
          <pre class="highlight javascript"><span class="c1">// 测试数据
</span><span class="k">if</span> <span class="p">(</span><span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">()</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>

  <span class="c1">// create two users
</span>  <span class="kd">var</span> <span class="nx">tomId</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">profile</span><span class="p">:</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'Tom Coleman'</span> <span class="p">}</span>
  <span class="p">});</span>
  <span class="kd">var</span> <span class="nx">tom</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">tomId</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">sachaId</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">profile</span><span class="p">:</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'Sacha Greif'</span> <span class="p">}</span>
  <span class="p">});</span>
  <span class="kd">var</span> <span class="nx">sacha</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">sachaId</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">telescopeId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'Introducing Telescope'</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://sachagreif.com/introducing-telescope/'</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="na">commentsCount</span><span class="p">:</span> <span class="mi">2</span>
  <span class="p">});</span>

  <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">postId</span><span class="p">:</span> <span class="nx">telescopeId</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="na">body</span><span class="p">:</span> <span class="s1">'Interesting project Sacha, can I get involved?'</span>
  <span class="p">});</span>

  <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">postId</span><span class="p">:</span> <span class="nx">telescopeId</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="na">body</span><span class="p">:</span> <span class="s1">'You sure can Tom!'</span>
  <span class="p">});</span>

  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'Meteor'</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://meteor.com'</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="na">commentsCount</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">});</span>

  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'The Meteor Book'</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://themeteorbook.com'</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="na">commentsCount</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">});</span>
<span class="p">}</span></pre>
          <div class="caption">server/fixtures.js</div><div class="lines-highlight" data-lines="20,21,45,46,54,55" data-class="added"></div>
          
          <p>像往常一样，更新测试数据文件时，你必须用 <code>meteor reset</code> 重置数据库，以确保它再次运行。</p>
          
          <p>然后，我们要确保所有新帖子的评论计数从0开始：</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
  <span class="na">author</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
  <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
  <span class="na">commentsCount</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>

<span class="c1">//...
</span></pre>
          <div class="caption">collections/posts.js</div><div class="lines-highlight" data-lines="6,7" data-class="added"></div>
          
          <p>当我们创建一个新的评论时，使用 Mongo 的 <code>$inc</code> 操作（给一个数字字段值加一）更新相关的 <code>commentsCount</code>：</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">comment</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">commentAttributes</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
  <span class="na">author</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
  <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<span class="p">});</span>

<span class="c1">// 更新帖子的评论数
</span><span class="nx">Posts</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">comment</span><span class="p">.</span><span class="nx">postId</span><span class="p">,</span> <span class="p">{</span><span class="na">$inc</span><span class="p">:</span> <span class="p">{</span><span class="na">commentsCount</span><span class="p">:</span> <span class="mi">1</span><span class="p">}});</span>

<span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">comment</span><span class="p">);</span>

<span class="c1">//...
</span></pre>
          <div class="caption">collections/comments.js </div><div class="lines-highlight" data-lines="9,10" data-class="added"></div>
          
          <p>最后只需简单地删除 <code>client/templates/posts/post_item.js</code> 的 <code>commentsCount</code> helper，因为该值可以从帖子中得到。</p>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 10-5</h4><p>非规范化评论数量到帖子中。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter10-5" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter10-5.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>现在用户可以互相对话，如果他们错过了新的评论，这将是不可原谅的。接下来的章节将告诉你如何实现通知，以防止这个情况发生！</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="denormalization">非规范化</h2>
            <span class="sidebar-marker">Sidebar</span>
            <span class="chapter-number">10.5</span>
          </div>
          <p>非规范化数据不存储规范化的数据。换句话说非规范化意味着相同数据的多个拷贝同时存在。</p>
          
          <p>上一章中，我们在帖子中非规范化评论总数，以避免每次都加载所有的评论。在数据建模意义上说这是冗余的，因为我们可以通过计数每个评论，随时计算出该总数（当不考虑运行速度）。</p>
          
          <p>非规范化通常意味着额外的开发工作。在例子中，我们每次添加或删除评论时，还需要同时更新相关的帖子，以确保 <code>commentsCount</code> 字段保持准确。这就是为什么关系型数据库，比如 MySQL，对这种做法不以为然。</p>
          
          <p>但是，规范化做法也有其缺点：没有 <code>commentsCount</code> 项，就象开始我们做的那样，为了计算评论总数，每次我们都需要传输<em>所有</em>的评论。非规范化使我们能够完全避免这种情况。</p>
          
          <div class="note"><h3>一份特殊发布</h3>
          
          <p>我们可以创建一个特殊的发布，送出我们有兴趣的的评论数（通过聚合查询服务器，我们目前能看到帖子的评论数）。</p>
          
          <p>如果这样发布代码的复杂性不超过由非规范化造成的难度，它是值得考虑的…</p>
          </div>
          
          <p>当然，这样的考虑是和应用相关的：如果你写的代码，数据完整性是非常重要的，那么避免数据的不一致，就比性能提升，更为重要和更有较高优先级。</p>
          
          <h3>嵌入文件或使用多个集合</h3>
          
          <p>如果您是有 Mongo 的经验，你可能会感到惊奇，我们给评论单独创建了第二个集合：为什么不直接在帖子文档中嵌入评论？</p>
          
          <p>事实证明当进行集合操作时，Mongo 提供的许多工具会给我们带来更好的结果。例如：</p>
          
          <ol>
          <li><code>{{#each}}</code> helper 遍历游标（<code>collection.find()</code> 的结果）是非常有效的。但是当它遍历一个较大文件中的对象数组时，效率就不高。</li>
          <li><code>allow</code> 和 <code>deny</code> 在 document 文档级别上操作，因此可以很容易地确保每个评论修改的正确性，但是在帖子级别就会变得更复杂。</li>
          <li>DDP 在文档的顶级属性级操作————这意味着，如果 <code>comment</code> 是 <code>post</code> 的一个属性，每当在帖子上创建一个新评论时，服务器就会将该帖子的整个更新的评论列表发送到每个连接的客户端。</li>
          <li>在文档级别更容易控制发布和订阅。例如，我们想对帖子的评论进行分页，如果评论没有属于它们自己的集合，我们会发现很难做到。</li>
          </ol>
          
          <p>Mongo 推荐嵌入文档以减少昂贵的查询次数。然而，考虑到 Meteor 的架构，就不成问题了：大多数时候我们在<em>客户端</em>查询评论，其数据库访问基本上是没有的。</p>
          
          <div class="note"><h3>非规范化的缺点</h3>
          
          <p>也有很好的理由使你<em>不要</em>非规范化数据。为了更好地理解反对非规范化的情况，我们推荐阅读 Sarah Mei 写的<a href="http://www.sarahmei.com/blog/2013/11/11/why-you-should-never-use-mongodb/">为什么你不应该使用 MongoDB</a>。</p>
          </div>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="notifications">Notifications</h2>
            <span class="chapter-number">11</span>
          </div>
          <p>现在用户们可以给帖子添加评论了，让他们互相知道讨论已经开始了是个好主意。</p>
          
          <p>我们将通知帖子的作者已经有用户在他的帖子上添加了评论，并且提供一个链接可以看到评论。</p>
          
          <p>这是 Meteor 真正闪光的特性之一：因为 Meteor 在默认情况下是实时的，我们会<em>瞬时</em>看到这些 notifications。不需要用户去刷新页面或者做其他检查,我们不需要写任何特殊代码就可以得到一个简单的 notifications 弹出框。</p>
          
          <h3>生成 Notifications</h3>
          
          <p>当有人在你的帖子上添加评论时我们将生成一个 notification。在后面，notifications 会扩展覆盖很多其他情况，但是目前让用户知道正在发生什么就足够了。</p>
          
          <p>让我们先创建一个 <code>Notifications</code> 集合，和一个方法 <code>createCommentNotification</code>，当有人在你的帖子下添加评论时该方法会添加一个 notification 到集合。</p>
          
          <p>因为我们将从客户端更新 notifications, 我们需要确定 <code>allow</code> 方法是防弹的。我们检查如下内容：</p>
          
          <ul>
          <li>用户是文档的创建者才能调用 <code>update</code> 方法</li>
          <li>用户只更新一个属性</li>
          <li>更新的属性名字是 <code>read</code></li>
          </ul>
          <pre class="highlight javascript"><span class="nx">Notifications</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">);</span>

<span class="nx">Notifications</span><span class="p">.</span><span class="nx">allow</span><span class="p">({</span>
  <span class="na">update</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">doc</span><span class="p">,</span> <span class="nx">fieldNames</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">ownsDocument</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="nx">fieldNames</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">fieldNames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'read'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">createCommentNotification</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">comment</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">comment</span><span class="p">.</span><span class="nx">postId</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">comment</span><span class="p">.</span><span class="nx">userId</span> <span class="o">!==</span> <span class="nx">post</span><span class="p">.</span><span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Notifications</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
      <span class="na">userId</span><span class="p">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span>
      <span class="na">postId</span><span class="p">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
      <span class="na">commentId</span><span class="p">:</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
      <span class="na">commenterName</span><span class="p">:</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">author</span><span class="p">,</span>
      <span class="na">read</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span></pre>
          <div class="caption">lib/collections/notifications.js</div>
          
          <p>和帖子和评论一样，<code>Notifications</code> 集合也是在服务器端和客户端共享的。用户看完 notifications 后，我们需要更新他们，因此需要允许更新操作。和其他部分一样只有拥有 notification 的用户才允许更新操作。</p>
          
          <p>我们写了个简单的程序用来当用户给帖子添加评论时找到需要通知的用户，并插入一个新的 notification。</p>
          
          <p>我们已经在服务器端方法创建了评论对象，我们用 <code>comment._id = Comments.insert(comment)</code> 来替换 <code>return Comments.insert(comment);</code>。这样就能在评论对象中保存 <code>_id</code>, 然后调用 <code>createCommentNotification</code> 方法:</p>
          <pre class="highlight javascript"><span class="nx">Comments</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">);</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>
  <span class="na">commentInsert</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">commentAttributes</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//...
</span>
    <span class="nx">comment</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">commentAttributes</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
      <span class="na">author</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
      <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="p">});</span>

    <span class="c1">// update the post with the number of comments
</span>    <span class="nx">Posts</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">comment</span><span class="p">.</span><span class="nx">postId</span><span class="p">,</span> <span class="p">{</span><span class="na">$inc</span><span class="p">:</span> <span class="p">{</span><span class="na">commentsCount</span><span class="p">:</span> <span class="mi">1</span><span class="p">}});</span>

    <span class="c1">// create the comment, save the id
</span>    <span class="nx">comment</span><span class="p">.</span><span class="nx">_id</span> <span class="o">=</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">comment</span><span class="p">);</span>

    <span class="c1">// now create a notification, informing the user that there's been a comment
</span>    <span class="nx">createCommentNotification</span><span class="p">(</span><span class="nx">comment</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">lib/collections/comments.js</div><div class="lines-highlight" data-lines="17~123" data-class="added"></div>
          
          <p>接下来发布 notifications:</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">check</span><span class="p">(</span><span class="nx">postId</span><span class="p">,</span> <span class="nb">String</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">postId</span><span class="p">:</span> <span class="nx">postId</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
<span class="p">});</span></pre>
          <div class="caption">server/publications.js</div><div class="lines-highlight" data-lines="10~12" data-class="added"></div>
          
          <p>在客户端订阅 notifications:</p>
          <pre class="highlight javascript"><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
  <span class="na">layoutTemplate</span><span class="p">:</span> <span class="s1">'layout'</span><span class="p">,</span>
  <span class="na">loadingTemplate</span><span class="p">:</span> <span class="s1">'loading'</span><span class="p">,</span>
  <span class="na">notFoundTemplate</span><span class="p">:</span> <span class="s1">'notFound'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">),</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">)]</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="6" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 11-1</h4><p>Added basic notifications collection.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter11-1" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter11-1.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <h3>显示 Notifications</h3>
          
          <p>现在我们在 header 中添加一个 notifications 列表。</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"header"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-default"</span> <span class="na">role=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"navbar-toggle collapsed"</span> <span class="na">data-toggle=</span><span class="s">"collapse"</span> <span class="na">data-target=</span><span class="s">"#navigation"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"sr-only"</span><span class="nt">&gt;</span>Toggle navigation<span class="nt">&lt;/span&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"{{pathFor 'postsList'}}"</span><span class="nt">&gt;</span>Microscope<span class="nt">&lt;/a&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse navbar-collapse"</span> <span class="na">id=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav"</span><span class="nt">&gt;</span>
          {{#if currentUser}}
            <span class="nt">&lt;li&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postSubmit'}}"</span><span class="nt">&gt;</span>Submit Post<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              {{&gt; notifications}}
            <span class="nt">&lt;/li&gt;</span>
          {{/if}}
        <span class="nt">&lt;/ul&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
          {{&gt; loginButtons}}
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/includes/header.html</div><div class="lines-highlight" data-lines="15~22" data-class="added"></div>
          
          <p>接下来创建 <code>notifications</code> 和 <code>notificationItem</code> 模板 (两个模板都在 <code>notifications.html</code> 文件中):</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"notifications"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
    Notifications
    {{#if notificationCount}}
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"badge badge-inverse"</span><span class="nt">&gt;</span>{{notificationCount}}<span class="nt">&lt;/span&gt;</span>
    {{/if}}
    <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/b&gt;</span>
  <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"notification dropdown-menu"</span><span class="nt">&gt;</span>
    {{#if notificationCount}}
      {{#each notifications}}
        {{&gt; notificationItem}}
      {{/each}}
    {{else}}
      <span class="nt">&lt;li&gt;&lt;span&gt;</span>No Notifications<span class="nt">&lt;/span&gt;&lt;/li&gt;</span>
    {{/if}}
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/template&gt;</span>

<span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"notificationItem"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;li&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{notificationPostPath}}"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;strong&gt;</span>{{commenterName}}<span class="nt">&lt;/strong&gt;</span> commented on your post
    <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/li&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/notifications/notifications.html</div>
          
          <p>We can see that the plan is for each notification to 
contain a link to the post that was commented on, and the name of the 
user that commented on it.
          我们可以看到每个 notification 有一个指向帖子的链接，而且包含注释作者的名字。</p>
          
          <p>接下来我们需要确定在 helper 中选择了正确的 notifications 列表，并且在用户点击链接后将 notifications 标记为已读。</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">notifications</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">notifications</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">userId</span><span class="p">:</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">(),</span> <span class="na">read</span><span class="p">:</span> <span class="kc">false</span><span class="p">});</span>
  <span class="p">},</span>
  <span class="na">notificationCount</span><span class="p">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">userId</span><span class="p">:</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">(),</span> <span class="na">read</span><span class="p">:</span> <span class="kc">false</span><span class="p">}).</span><span class="nx">count</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Template</span><span class="p">.</span><span class="nx">notificationItem</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">notificationPostPath</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Router</span><span class="p">.</span><span class="nx">routes</span><span class="p">.</span><span class="nx">postPage</span><span class="p">.</span><span class="nx">path</span><span class="p">({</span><span class="na">_id</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postId</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Template</span><span class="p">.</span><span class="nx">notificationItem</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'click a'</span><span class="err">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">Notifications</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="p">{</span><span class="na">$set</span><span class="p">:</span> <span class="p">{</span><span class="na">read</span><span class="p">:</span> <span class="kc">true</span><span class="p">}});</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/notifications/notifications.js</div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 11-2</h4><p>Display notifications in the header.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter11-2" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter11-2.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>你可能觉得 notifications 和 errors 很像，是的从结构上看他们很相似。但有一点不同: 我们为 notification 创建了一个集合。这意味着 notification 是<em>持久化</em>的，他对于同一用户不论浏览器刷新还是跨设备都是存在的。</p>
          
          <p>试一下: 打开一个新的浏览器 (比如 Firefox), 然后创建一个新用户, 然后在主用户的帖子下发表一个评论 (在 Chrome 中)。你将看到如下：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/11-1.png" alt="Displaying notifications."><figcaption>Displaying notifications.</figcaption></figure>
          
          <h3>控制 notifications 的访问权限</h3>
          
          <p>Notifications 工作的很好。然后这有一个小问题：所有人都能看到我们的 notifications。</p>
          
          <p>如果你的浏览器还开着，试一下在浏览器 console 中输入以下 js 代码：</p>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">();</span>
<span class="mi">1</span></pre>
          <div class="caption">Browser console</div>
          
          <p>一个新的用户 (当有帖子被评论时) 不该收到任何 notifications. <code>Notifications</code> 集合中的内容实际上属于以前的用户。</p>
          
          <p>除了可能的隐私问题外，我们不能让浏览器显示每条 notifications 的原因是. 对于一个足够规模的网站，这么做会很容易耗尽浏览器内存，并带来严重的性能问题。</p>
          
          <p>我们通过 <strong>publications</strong> 来解决这个问题。我们可以通过 publications 来精确的指定哪部分集合我们想共享给其他用户。</p>
          
          <p>为了实现这个，我们需要在 publication 中返回不同的 cursor 而不是使用 <code>Notifications.find()</code>。换句话说，我们返回的 cursor 是和当前用户的 notificatons 相关的。</p>
          
          <p>这么做足够直接，因为 <code>publish</code> 函数有当前用户的 <code>_id</code>, 它存在于 <code>this.userId</code> 中：</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">userId</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="na">read</span><span class="p">:</span> <span class="kc">false</span><span class="p">});</span>
<span class="p">});</span></pre>
          <div class="caption">server/publications.js</div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 11-3</h4><p>Only sync notifications that are relevant to the user.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter11-3" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter11-3.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>现在看一下我们的两个浏览器窗口，我们会看到两个不同的 notifications 集合。</p>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">();</span>
<span class="mi">1</span></pre>
          <div class="caption">Browser console (user 1)</div>
          <pre class="highlight javascript"><span class="err">❯</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">();</span>
<span class="mi">0</span></pre>
          <div class="caption">Browser console (user 2)</div>
          
          <p>实际上，当你登录和登出时 Notifications 集合都会变化。这是因为当账户变化时 publications 会自动重新发布。</p>
          
          <p>我们的 app 功能越来越完善，当越来越多的用户发帖时，我们的首页会无限长。下一章我们通过分页来解决这个问题。</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="advanced-reactivity">高级的响应性</h2>
            <span class="sidebar-marker">Sidebar</span>
            <span class="chapter-number">11.5</span>
          </div>
          <p>虽然需要你自己写代码来跟踪依赖变量的情况十分罕见，了解依赖变量的工作流程还是十分必要的。</p>
          
          <p>设想我们现在需要跟踪一下 Microscope上，当前用户的 Facebook 朋友在 “like” 
某一篇帖子的数量。 让我们假设我们已经解决了 Facebook 用户认证的问题，运用了正确的 API 调用，而且也解析了相关数据。 
我们现在有一个异步的客户端函数返回 like 的数量，<code>getFacebookLikeCount(user, url, callback)</code>。</p>
          
          <p>需要特别强调的是要记住这个函数是十分 <em>非响应式</em> 而且非实时的。它发起一个 HTTP 请求到 Facebook， 得到一些数据， 然后作为回调函数参数返回给我们的应用程序。 但是如果 like 数改变了而这个函数不会重新运行，那么我们的界面上就无法得到当前最新数据了。</p>
          
          <p>要解决这个问题，我们首先使用 <code>setInterval</code> 来每隔几秒钟调用一次这个函数:</p>
          <pre class="highlight javascript"><span class="nx">currentLikeCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">Meteor</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">postId</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'currentPostId'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">getFacebookLikeCount</span><span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">(),</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">postId</span><span class="p">).</span><span class="nx">url</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">currentLikeCount</span> <span class="o">=</span> <span class="nx">count</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span></pre>
          <p>任何时候当我们检查 <code>currentLikeCount</code> 变量， 我们期望可以得到一个5秒钟之内准确的数据。我们现在在帮助方法使用这个变量。代码如下：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">likeCount</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">currentLikeCount</span><span class="p">;</span>
<span class="p">}</span></pre>
          <p>然而，我们无法每次当<code>currentLikeCount</code> 改变的时候重绘模板。尽管变量自己现在可以伪实时了，但是它不是<em>响应式的</em>所以无法正确地和 Meteor 生态环境中的其他部分进行沟通。</p>
          
          <h3>Tracking Reactivity: Computations</h3>
          
          <p>Meteor 的响应性是靠 <em>依赖</em> 来控制的， 就是一个跟踪 Computation 的数据结构。</p>
          
          <p>正如我们此前在响应式章节看到的， 一个 computation 是一段代码用来处理响应式数据。我们的例子中有一个 computation 隐式的建立给 <code>postItem</code> 这个模板用。 这个模板中的每个帮助方法都有自己的 computation 。</p>
          
          <p>你可以想象这个 computation 就是一段专门关注响应式数据的代码。 当数据改变了， 这个 computation 就会通知 （通过 <code>invalidate()</code>) ， 而且也正是 computation 来决定是否有什么工作需要做。</p>
          
          <h3>将变量变为响应式函数</h3>
          
          <p>将变量 <code>currentLikeCount</code> 放到一个响应式数据源中，我们需要跟踪所有依赖这个变量的 computations.这需要把它从变量变为一个函数 (有返回值的函数):</p>
          <pre class="highlight javascript"><span class="kd">var</span> <span class="nx">_currentLikeCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">_currentLikeCountListeners</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Tracker</span><span class="p">.</span><span class="nx">Dependency</span><span class="p">();</span>

<span class="nx">currentLikeCount</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">_currentLikeCountListeners</span><span class="p">.</span><span class="nx">depend</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">_currentLikeCount</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">postId</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'currentPostId'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">getFacebookLikeCount</span><span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">(),</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">postId</span><span class="p">),</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="nx">count</span> <span class="o">!==</span> <span class="nx">_currentLikeCount</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_currentLikeCount</span> <span class="o">=</span> <span class="nx">count</span><span class="p">;</span>
        <span class="nx">_currentLikeCountListeners</span><span class="p">.</span><span class="nx">changed</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span></pre>
          <div class="lines-highlight" data-lines="1~7,14~17" data-class="added"></div>
          
          <p>我们建立了一个叫 <code>_currentLikeCountListeners</code> 的依赖，它来跟踪所有用到 <code>currentLikeCount()</code> 的 computations. 当 <code>_currentLikeCount</code> 值发生变化，我们通过调用依赖的 <code>changed()</code> 函数，来通知所有 computations 数据变化了。</p>
          
          <p>这些 computations 可以继续处理下面的数据变化。</p>
          
          <p>你可能觉得这像是在响应式数据源上的很多引用，你说对了，Meteor 提供很多工具使这项工作简单 (你不需要直接调用 computations , 他们会自动运行)。有一个叫做 <code>reactive-var</code> 的包，它的内容正是函数 <code>currentLikeCount()</code> 要做的事。我们加入这个包:</p>
          <pre class="highlight shell">meteor add reactive-var</pre>
          <p>The we can use it to simplify our code a bit:</p>
          <pre class="highlight javascript"><span class="kd">var</span> <span class="nx">currentLikeCount</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReactiveVar</span><span class="p">();</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">postId</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'currentPostId'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">getFacebookLikeCount</span><span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">(),</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">postId</span><span class="p">),</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">currentLikeCount</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">count</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span></pre>
          <div class="lines-highlight" data-lines="1,9" data-class="added"></div>
          
          <p>现在使用这个包，我们在帮助方法中调用 <code>currentLikeCount.get()</code>，它会像之前一样工作。有另外一个有用的包 <code>reactive-dict</code>, 它提供 key-value 存储 (像 <code>Session</code> 一样)。</p>
          
          <h3>Comparing Tracker to Angular</h3>
          
          <p><a href="http://angularjs.org/">Angular</a> 是一个客户端响应式库，是 Google 的家伙们开发的。我们来比较 Meteor 和 Angular 的依赖跟踪方式。他们的实现方式非常不同。</p>
          
          <p>我们已经知道 Meteor 使用一些被称为 comptations 的代码来实现依赖跟踪的。这些 computations 被特殊的 “响应式” 数据源(函数)跟踪，在数据变化的时候将他们自己标记为 invalidate。当需要调用 <code>invalidate()</code> 函数时，响应式数据源<em>显示的</em>通知所有依赖。请注意这是数据变化时的一般情况，数据源也可以因为其他原因触发 invalidation。</p>
          
          <p>另外，尽管通常情况下当数据 invalidate 时 computations 只是重新运行，但是你也可以在此时指定任何你想要的行为。这些给了用户很高的响应式控制权。</p>
          
          <p>在 Angular 中，响应式是通过 <code>scope</code> 对象来调节的。一个 scope 可以看做是拥有一些特殊方法的普通 js 对象。</p>
          
          <p>当你的响应式数据依赖于 scope 中的一个值，你调用 <code>scope.$watch</code> 方法，告诉 expression 你关心的数据（例如： 你关心 scope 中的哪些数据）和一个当 expression 发生变化时每次都运行的监听器。因此你需要显示的提供当 expression 数据变化时你要做的操作。</p>
          
          <p>回到之前 Facebook 的例子，我们的代码可以写成如下：</p>
          <pre class="highlight javascript"><span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$watch</span><span class="p">(</span><span class="s1">'currentLikeCount'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">likeCount</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Current like count is '</span> <span class="o">+</span> <span class="nx">likeCount</span><span class="p">);</span>
<span class="p">});</span></pre>
          <p>当然，就像在 Meteor 中你很少需要去建立 computations, 在 Angular 中你无须经常显示调用 <code>$watch</code>, <code>ng-model</code> 和 <code>{{expressions}}</code> 会自动建立跟踪，之后当数据变化时他们会处理重新展示的事情。</p>
          
          <p>当响应式数据发生变化时， <code>scope.$apply()</code> 方法会被调用。他会重新计算 scope 中所有的 watcher, 然后只调用 expression 值发生变化的 watcher 的监听器方法。</p>
          
          <p>因此 <code>scope.$apply()</code> 方法和 Meteor 中的 <code>dependency.changed()</code> 很相似，除了它是在 scope 级别操作，而不是给你控制权决定哪个 listener 需要重新 evaluate。换句话说，较少的控制使得 Angular 可以通过聪明和高效的方式来决定哪些 listener 需要重新 evaluate。</p>
          
          <p>在 Angular 中，我们的 <code>getFacebookLikeCount()</code> 函数看起来如下:</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">getFacebookLikeCount</span><span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">(),</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">postId</span><span class="p">),</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">currentLikeCount</span> <span class="o">=</span> <span class="nx">count</span><span class="p">;</span>
      <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">},</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span></pre>
          <div class="lines-highlight" data-lines="5~6" data-class="added"></div>
          
          <p>必须承认，Meteor 替我们完成了响应式的大部分繁重工作，但是希望，通过这些模式的学习，可以对你的深入研究起到帮助。</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="pagination">分页</h2>
            <span class="chapter-number">12</span>
          </div>
          <p>Microscope 的功能看起来不错。我们可以想象当它 release 之后会很受欢迎。</p>
          
          <p>因此我们需要考虑一下随着新帖子越来越多所带来的性能问题。</p>
          
          <p>之前我们说过客户端集合会包含服务器端数据的一个子集。我们在帖子和评论集合已经实现了这些。</p>
          
          <p>但是现在，如果我们还是一口气发布所有帖子给所有的连接用户。当有成千上万的新帖子时，这会带来一些问题。为了解决这些，我们需要给帖子分页。</p>
          
          <h3>添加更多的帖子</h3>
          
          <p>首先是我们的初始化数据，我们需要添加足够的帖子来使分页有意义：</p>
          <pre class="highlight javascript"><span class="c1">// Fixture data
</span><span class="k">if</span> <span class="p">(</span><span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">()</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">//...
</span>
  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'The Meteor Book'</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://themeteorbook.com'</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="na">commentsCount</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">});</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
      <span class="na">title</span><span class="p">:</span> <span class="s1">'Test post #'</span> <span class="o">+</span> <span class="nx">i</span><span class="p">,</span>
      <span class="na">author</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
      <span class="na">userId</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
      <span class="na">url</span><span class="p">:</span> <span class="s1">'http://google.com/?q=test-'</span> <span class="o">+</span> <span class="nx">i</span><span class="p">,</span>
      <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="nx">i</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
      <span class="na">commentsCount</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span></pre>
          <div class="caption">server/fixtures.js</div><div class="lines-highlight" data-lines="15~24" data-class="added"></div>
          
          <p>运行完 <code>meteor reset</code> 重启你的 app, 你会看到如下：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/12-1.png" alt="显示初始化数据。"><figcaption>显示初始化数据。</figcaption></figure>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 12-1</h4><p>添加足够的帖子使分页有必要。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter12-1" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter12-1.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <h3>无限分页</h3>
          
          <p>我们将实现一个"无限"的分页。意思是在第一屏显示 10 条帖子和一个在底部显示的 “load more” 链接。点击 “load more” 链接再加载另外 10 条帖子，诸如此类<em>无限的加载</em>。这意味着我们只用一个参数来实现分页，控制在屏幕上显示帖子的数量。</p>
          
          <p>现在需要一个方法告诉服务器端返回给客户端帖子的数量。这些发生在路由订阅<code>帖子</code>的过程，我们会利用路由来实现分页。</p>
          
          <p>最简单的限制返回帖子数量的方式是将返回数量加到 URL 中，如 <code>http://localhost:3000/25</code>。使用 URL 记录数量的另一个好处是，如果不小心刷新了页面，还会返回 25 条帖子。</p>
          
          <p>为了恰当的实现分页，我们需要修改帖子的订阅方法。就像我们之前在<em>评论</em>那章做的，我们需要将订阅部分的代码从 <em>router</em> 级变为 <em>route</em> 级。</p>
          
          <p>这个改变内容会比较多，通过代码可以看的比较清楚。</p>
          
          <p>首先，停止 <code>Router.configure()</code> 代码块中的 <code>posts</code> 订阅。即删除 <code>Meteor.subscribe('posts')</code>,只留下 <code>notifications</code> 订阅:</p>
          <pre class="highlight javascript"><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
  <span class="na">layoutTemplate</span><span class="p">:</span> <span class="s1">'layout'</span><span class="p">,</span>
  <span class="na">loadingTemplate</span><span class="p">:</span> <span class="s1">'loading'</span><span class="p">,</span>
  <span class="na">notFoundTemplate</span><span class="p">:</span> <span class="s1">'notFound'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">)]</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="6" data-class="added"></div>
          
          <p>我们在路由路径中加入参数 <code>postsLimt</code>。 参数后面的 <code>?</code> 表示参数是可选的。这样路由就能同时匹配 <code>http://localhost:3000/50</code> 和 <code>http://localhost:3000</code>。</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/:postsLimit?'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">,</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="3" data-class="added"></div>
          
          <p>需要注意每个路径都会匹配路由 <code>/:parameter?</code>。因为每个路由都会被检查是否匹配当前路径。我们要组织好路由来减少特异性。</p>
          
          <p>话句话说，更特殊的路由会优先选择，例如:路由 <code>/posts/:_id</code> 会在前面，而路由 <code>postsList</code> 会放到路由组的最后，因为它太泛泛了可以匹配所有路径。</p>
          
          <p>是时候处理难题了，处理订阅和找到正确的数据。我么需要处理 <code>postsLimit</code> 参数不存在的情况。我们给它一个默认值 5, 这样我们能更好的演示分页。</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/:postsLimit?'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">limit</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="mi">5</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="p">{</span><span class="na">sort</span><span class="p">:</span> <span class="p">{</span><span class="na">submitted</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="na">limit</span><span class="p">:</span> <span class="nx">limit</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="5~8" data-class="added"></div>
          
          <p>你注意到我们在订阅 <code>posts</code> 时传了一个 js 对象 ({sort: {submitted: -1}, limit: postsLimit}), 这个 js 对象会作为服务器端查询方法 <code>Posts.find()</code> 的可选参数。下面是服务器端的实现代码：</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">check</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">sort</span><span class="p">:</span> <span class="nb">Object</span><span class="p">,</span>
    <span class="na">limit</span><span class="p">:</span> <span class="nb">Number</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="nx">options</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">check</span><span class="p">(</span><span class="nx">postId</span><span class="p">,</span> <span class="nb">String</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">postId</span><span class="p">:</span> <span class="nx">postId</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Notifications</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">userId</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">userId</span><span class="p">});</span>
<span class="p">});</span></pre>
          <div class="caption">server/publications.js</div><div class="lines-highlight" data-lines="1~7" data-class="added"></div>
          
          <div class="note"><h3>传递参数</h3>
          
          <p>我们的订阅代码告诉服务器端，我们信任客户端传来的 JavaScript 对象 (在我们的例子中是 <code>{limit: postsLimit}</code>) 作为 <code>find()</code> 方法的 <code>options</code> 参数。这样我们能通过 browser consle 来传任何 option 对象。</p>
          
          <p>在我们的例子中,这样没什么害处，因为用户可以做的无非是改变帖子顺序，或者修改 limit 值（这是我们想让用户做的）。但是对于一个 real-world app 我们必须做必要的限制！</p>
          
          <p>幸好通过 <code>check()</code> 方法我们知道用户不能偷偷加入额外的 options （例如 <code>fields</code>, 在某些情况下需要对外暴露 ducoments 的私有数据）。</p>
          
          <p>然而，更安全的做法是传递单个参数而不是整个对象，通过这样确保数据安全：</p>
          
          <pre><code class="js">Meteor.publish('posts', function(sort, limit) {
  return Posts.find({}, {sort: sort, limit: limit});
});
</code></pre>
          </div>
          
          <p>现在我们在 route 级订阅数据，同样的我们可以在这里设置数据的 context。我们要偏离一下之前的模式，我们让 <code>data</code> 函数返回一个 js 对象而不是一个 cursor。 这样我们可以创建一个<em>命名</em>的数据 context。我们称之为 <code>posts</code>。</p>
          
          <p>这意味着我们的数据 context 将存在于 <code>posts</code> 中，而不是简单的在模板中隐式的存在于 <code>this</code> 中。除去这一点，代码看起来很相似:</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/:postsLimit?'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">limit</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="mi">5</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="p">{</span><span class="na">sort</span><span class="p">:</span> <span class="p">{</span><span class="na">submitted</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="na">limit</span><span class="p">:</span> <span class="nx">limit</span><span class="p">});</span>
  <span class="p">},</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">limit</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="mi">5</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">posts</span><span class="p">:</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="na">sort</span><span class="p">:</span> <span class="p">{</span><span class="na">submitted</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="na">limit</span><span class="p">:</span> <span class="nx">limit</span><span class="p">})</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="9~14" data-class="added"></div>
          
          <p>因为我们在 route 级设置数据 context, 现在我们可以去掉在 <code>posts_list.js</code> 文件中 <code>posts</code> 模板的帮助方法。</p>
          
          <p>我们的数据 context 叫做 <code>posts</code> （和 helper 同名），所以我们甚至不需要修改 <code>postsList</code> 模板！</p>
          
          <p>下面是我们修改过的 <code>router.js</code> 代码：</p>
          <pre class="highlight javascript"><span class="nx">Router</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
  <span class="na">layoutTemplate</span><span class="p">:</span> <span class="s1">'layout'</span><span class="p">,</span>
  <span class="na">loadingTemplate</span><span class="p">:</span> <span class="s1">'loading'</span><span class="p">,</span>
  <span class="na">notFoundTemplate</span><span class="p">:</span> <span class="s1">'notFound'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">)]</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/posts/:_id'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postPage'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/posts/:_id/edit'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postEdit'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/submit'</span><span class="p">,</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'postSubmit'</span><span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/:postsLimit?'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">limit</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="mi">5</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="p">{</span><span class="na">sort</span><span class="p">:</span> <span class="p">{</span><span class="na">submitted</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="na">limit</span><span class="p">:</span> <span class="nx">limit</span><span class="p">});</span>
  <span class="p">},</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">limit</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="mi">5</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">posts</span><span class="p">:</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="na">sort</span><span class="p">:</span> <span class="p">{</span><span class="na">submitted</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="na">limit</span><span class="p">:</span> <span class="nx">limit</span><span class="p">})</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">requireLogin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">loggingIn</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">loadingTemplate</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'accessDenied'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">onBeforeAction</span><span class="p">(</span><span class="s1">'dataNotFound'</span><span class="p">,</span> <span class="p">{</span><span class="na">only</span><span class="p">:</span> <span class="s1">'postPage'</span><span class="p">});</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">onBeforeAction</span><span class="p">(</span><span class="nx">requireLogin</span><span class="p">,</span> <span class="p">{</span><span class="na">only</span><span class="p">:</span> <span class="s1">'postSubmit'</span><span class="p">});</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="6,25~37" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 12-2</h4><p>为 postsList 路径添加限制。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter12-2" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter12-2.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>试一下我们的分页。现在我们可以通过 URL 参数来控制页面显示帖子的数量，试一下 <code>http://localhost:3000/3</code>。你可以看到如下:</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/12-2.png" alt="控制首页显示帖子的数量。"><figcaption>控制首页显示帖子的数量。</figcaption></figure>
          
          <div class="note"><h3>为什么不用传统的分页？</h3>
          
          <p>为什么我们使用“无限分页”而不用每页显示 10 条帖子的连续分页,就像 Google 的搜索结果分页一样？这是由于 Meteor 的实时性决定的。</p>
          
          <p>让我们想象一下使用类似 Google 搜索结果的连续分页模式，我们在第2页，显示的是 10 到 20 条帖子。这是碰巧有另外一个用户删除了前面 10 条帖子中的帖子。</p>
          
          <p>因为 app 是实时的，我们的数据集会马上变化，这样第 10 条帖子变成了第 9 条，从当前页面消失了，第 21 条帖子会出现在页面中。这样用户会觉得没什么原由的结果集变了!</p>
          
          <p>即使我们可以容忍这种怪异的 UX, 由于技术的原因传统的分页还是很难实现。</p>
          
          <p>让我们回到前一个例子。我们从 <code>Posts</code> 集合中发布第 10 到 20 条帖子，但是在客户端我们如何找到这些帖子？我们不能在客户端选择第 10 到 20 条帖子，因为客户端集合只有 10 个帖子。</p>
          
          <p>一个简单的方案是服务器端发布 10 条帖子，在客户端执行一下 <code>Posts.find()</code> 找到这 10 条发布的帖子。</p>
          
          <p>这个方案在只有一个用户订阅的情况下有效，但是如果有多个用户订阅呢，下面我们会看到。</p>
          
          <p>我们假设一个用户需要第 10 到 20 条帖子，而另一个需要第 30 到 40。这样在客户端我们有两个 20 条帖子，我们不能区分他们属于哪个订阅。</p>
          
          <p>基于这些原因，我们在 Meteor 中不能使用传统的分页。</p>
          </div>
          
          <h3>创建路由控制器（Route controller）</h3>
          
          <p>你可能已经注意到了我们代码中重复了 <code>var limit = parseInt(this.params.postsLimit) || 5;</code> 两次。而且硬编码数字 5，这不是个理想的做法。虽然这不会导致世界末日，但是我们最好还是遵循 DRY 原则 (Don’t Repeat Yourself), 让我们看看如何能把代码重构的更好些。</p>
          
          <p>我们将介绍 Iron Router 的一个新功能， <em>Route Controllers</em>。Route controller 是通过简单的方式将一组路由特性打包，其他的 route 可以继承他们。现在我们只在一个路由中使用它，在下一章我们会看到它如何派上用场。</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">PostsListController</span> <span class="o">=</span> <span class="nx">RouteController</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">template</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">,</span>
  <span class="na">increment</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="na">postsLimit</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="na">findOptions</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="na">sort</span><span class="p">:</span> <span class="p">{</span><span class="na">submitted</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="na">limit</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">()};</span>
  <span class="p">},</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">findOptions</span><span class="p">());</span>
  <span class="p">},</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="na">posts</span><span class="p">:</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">findOptions</span><span class="p">())};</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//...
</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/:postsLimit?'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postsList'</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="3~18, 25" data-class="added"></div>
          
          <p>让我们一步接一步的往下看。首先，我们的创建一个继承 <code>RouteController</code> 的控制器。然后像之前一样设置 <code>template</code> 属性，然后添加一个新的 <code>increment</code> 属性。</p>
          
          <p>然后我们定义一个 <code>limit</code> 函数用来返回当前限制的数量，然后定义一个 <code>findOptions</code> 函数用来返回 options 对象。这看起来像是个对于的步骤，但是我们后面会用到它。</p>
          
          <p>接下来我们定义 <code>waitOn</code> 和 <code>data</code> 函数，除了他们现在会用到新的 <code>findOptions</code> 函数外其余和之前相同。</p>
          
          <p>因为我们的控制器叫做 <code>PostsListController</code> 路由叫做 <code>postsList</code>, Iron Router 会自动使用他们。因此我们只需要从路由定义中移除 <code>waitOn</code> 和 <code>data</code> (因为路由已经会处理他们了)。如果我们需要给路由起别的名字,我们可以使用 <code>controller</code> 选项(我们将在下一章看到一个例子)。</p>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 12-3</h4><p>重构 postsLists 路由为 RouteController.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter12-3" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter12-3.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <h3>添加加载更多链接</h3>
          
          <p>我们现在实现了分页，代码看起来还不错。只有一个问题：我们的分页需要手工修改 URL。这显然不是一个好的用户体验，现在让我们来修改它。</p>
          
          <p>我们要做的很简单。我们将在帖子列表的下面加一个 “load more” 按钮，点击按钮将增加 5 条帖子。如果当前的 URL 是 <code>http://localhost:3000/5</code>, 点击 “load more” 按钮 URL 将变成 <code>http://localhost:3000/10</code>。如果你之前已经实现过这种功能，我们相信你很强！</p>
          
          <p>因为在前面，我们的分页逻辑是在 route 中。记得我们是什么时候显式命名数据上下文，而非使用匿名 cursor 的么? 没有规则说我们的 <code>data</code> 函数只能使用 cursors, 因此，我们将用同样的技巧来生成 “load more” 按钮的 URL。</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">PostsListController</span> <span class="o">=</span> <span class="nx">RouteController</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">template</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">,</span>
  <span class="na">increment</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="na">postsLimit</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="na">findOptions</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="na">sort</span><span class="p">:</span> <span class="p">{</span><span class="na">submitted</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="na">limit</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">()};</span>
  <span class="p">},</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">findOptions</span><span class="p">());</span>
  <span class="p">},</span>
  <span class="na">posts</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">findOptions</span><span class="p">());</span>
  <span class="p">},</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">hasMore</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">posts</span><span class="p">().</span><span class="nx">count</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">nextPath</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">.</span><span class="nx">path</span><span class="p">({</span><span class="na">postsLimit</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">()</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">});</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">posts</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">posts</span><span class="p">(),</span>
      <span class="na">nextPath</span><span class="p">:</span> <span class="nx">hasMore</span> <span class="p">?</span> <span class="nx">nextPath</span> <span class="p">:</span> <span class="kc">null</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="15~25" data-class="added"></div>
          
          <p>让我们来深入的看一下 router 带来的魔术。记住 <code>postsList</code> route (它将继承 <code>PostsListController</code> 控制器) 使用一个 <code>postsLimit</code> 参数。</p>
          
          <p>因此当我们给 <code>this.route.path()</code> 传递参数 <code>{postsLimit: this.limit() + this.increment}</code> 时，我们告诉 <code>postsList</code> route 使用这个 js 对象做数据上线文建立自己的 path。</p>
          
          <p>换句话说，这和使用 <code>{{pathFor 'postsList'}}</code> Spacebars 帮助方法一样， 除了我们用自己的数据上下文替换了隐式的 <code>this</code>。</p>
          
          <p>我们使用这个路径并将它添加到我们模板的数据上下文中，但是<em>只有</em>多条帖子时会显示。我们的实现方法有一点小花招。</p>
          
          <p>我们知道 <code>this.limit()</code> 方法会返回当前我们想要显示帖子的数量，它可能是当前 URL 中的值，如果 URL 中没有参数它会是默认值 (5)。</p>
          
          <p>另一方面, <code>this.posts</code> 引用当前的 cursor, 因此 <code>this.posts.count()</code> 的值是在 cursor 中帖子的数量。</p>
          
          <p>因此我们说当我们要求发挥 <code>n</code> 条帖子，实际返回了 <code>n</code> 条帖子，我们将继续显示 “load more” 按钮。但是如果我们要求返回 <code>n</code> 条帖子，而实际返回的数量比 <code>n</code> 少，这样我们就知道记录已经到头了，我们就不再显示加载按钮。</p>
          
          <p>这就是说，我们的系统在一种情况下会有点问题:当我们的数据库<em>恰好</em>有 <code>n</code> 条记录时。如果是这样，当客户端要求返回 <code>n</code> 条帖子，我们得到了 <code>n</code> 条，然后继续显示 “load more” 按钮，这是我们不知道其实已经没有记录可以继续返回了。</p>
          
          <p>不幸的是，我们没有好的方法去解决这个问题，因此我们不得不接受这个不算完美的实现方式。</p>
          
          <p>下面剩下的就是在帖子列表下面加上 “load more” 链接，并且保证在还有帖子时才显示它:</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postsList"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"posts"</span><span class="nt">&gt;</span>
    {{#each posts}}
      {{&gt; postItem}}
    {{/each}}

    {{#if nextPath}}
      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"load-more"</span> <span class="na">href=</span><span class="s">"{{nextPath}}"</span><span class="nt">&gt;</span>Load more<span class="nt">&lt;/a&gt;</span>
    {{/if}}
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/posts_list.html</div><div class="lines-highlight" data-lines="7~10" data-class="added"></div>
          
          <p>下面是你帖子列表现在看上去的样子:</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/12-3.png" alt="“load more” 按钮。 "><figcaption>“load more” 按钮。 </figcaption></figure>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 12-4</h4><p>添加 nextPath() 到控制器中并使用它来取得更多帖子。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter12-4" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter12-4.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <h3>更好的用户体验</h3>
          
          <p>现在我们的分页可以工作了，但是有个烦人小问题: 每次我们点击 “load more” 按钮向 router 加载更多的帖子时，Iron Router 的 <code>waitOn</code> 特性会在我们等待时显示 <code>loading</code> 模板。当结果到来时我们又会回到页面的顶端，我们每次都要滚动页面回到之前看的位置。</p>
          
          <p>因此，首先我们要告诉 Iron Router 不要 <code>waintOn</code> 订阅，我们将定义自己的订阅在一个 <code>subscriptions</code> hook 中。</p>
          
          <p>注意我们我们不是在 hook 中<em>返回</em>这个订阅。返回它（这是一般 <code>订阅</code> hook 常做的工作）将触发一个全局的 loading hook, 这正是我们想要避免的。我们只是想在 <code>subscriptions</code> hook 中定义我们的订阅，就像使用一个 <code>onBeforeAction</code> hook。</p>
          
          <p>我们还要在我们的数据上下文中传入一个 <code>ready</code> 变量，它指向 <code>this.postsSub.ready</code>。它会告诉我们帖子订阅何时加载完毕。</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">PostsListController</span> <span class="o">=</span> <span class="nx">RouteController</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">template</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">,</span>
  <span class="na">increment</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="na">postsLimit</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="na">findOptions</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="na">sort</span><span class="p">:</span> <span class="p">{</span><span class="na">submitted</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="na">limit</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">()};</span>
  <span class="p">},</span>
  <span class="na">subscriptions</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">postsSub</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">findOptions</span><span class="p">());</span>
  <span class="p">},</span>
  <span class="na">posts</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">findOptions</span><span class="p">());</span>
  <span class="p">},</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">hasMore</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">posts</span><span class="p">().</span><span class="nx">count</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">nextPath</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">.</span><span class="nx">path</span><span class="p">({</span><span class="na">postsLimit</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">()</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">});</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">posts</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">posts</span><span class="p">(),</span>
      <span class="na">ready</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsSub</span><span class="p">.</span><span class="nx">ready</span><span class="p">,</span>
      <span class="na">nextPath</span><span class="p">:</span> <span class="nx">hasMore</span> <span class="p">?</span> <span class="nx">nextPath</span> <span class="p">:</span> <span class="kc">null</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="12~14, 23" data-class="added"></div>
          
          <p>我们将在模板中检查 <code>ready</code> 变量的状态，并在加载帖子时在帖子列表的下面显示一个加载图标(spinner):</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postsList"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"posts"</span><span class="nt">&gt;</span>
    {{#each posts}}
      {{&gt; postItem}}
    {{/each}}

    {{#if nextPath}}
      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"load-more"</span> <span class="na">href=</span><span class="s">"{{nextPath}}"</span><span class="nt">&gt;</span>Load more<span class="nt">&lt;/a&gt;</span>
    {{else}}
      {{#unless ready}}
        {{&gt; spinner}}
      {{/unless}}
    {{/if}}
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/posts_list.html</div><div class="lines-highlight" data-lines="10~12" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 12-5</h4><p>添加加载图标使分页更好。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter12-5" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter12-5.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <h3>访问任何帖子</h3>
          
          <p>现在我们默认每次加载 5 条新帖子，但是当用户访问某个帖子的单独页面时会发生什么?</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/12-4.png" alt="一个空模板。"><figcaption>一个空模板。</figcaption></figure>
          
          <p>试一下，我们会得到一个 “not found” 错误。这是有原因的: 我们告诉 router 当我们加载 <code>postList</code> route 时订阅 <code>帖子</code> 发布。但是我们没有说访问 <code>postPage</code> route 时该做什么。</p>
          
          <p>但是到目前，我们知道如何订阅一个 <code>n</code> 个最新帖子的列表。我们如何向服务器端要求单个具体帖子的内容? 我们将告诉你一个小秘密: 对于一个 collection 你可以有多个 publication！</p>
          
          <p>让我们找回丢失的帖子，我们定义一个新的 publication <code>singlePost</code>,它只发布一个帖子，用 <code>_id</code> 鉴别。</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="nx">options</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'singlePost'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">check</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nb">String</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">server/publications.js</div><div class="lines-highlight" data-lines="5~7" data-class="added"></div>
          
          <p>现在，让我们在客户端订阅正确的帖子。我们已经在 <code>postPage</code> route 的 <code>wainOn</code> 函数中订阅了 <code>comments</code> 发布，因此我们可以也在这里加入 <code>singlePost</code> 订阅。让后别忘了在 <code>postEdit</code> route 中加入我们的订阅, 因为那里也需要相同的数据:</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/posts/:_id'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postPage'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
      <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'singlePost'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">),</span>
      <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">)</span>
    <span class="p">];</span>
  <span class="p">},</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/posts/:_id/edit'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'postEdit'</span><span class="p">,</span>
  <span class="na">waitOn</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'singlePost'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="6~9,16~18" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 12-6</h4><p>使用单一帖子订阅来确保我们总会看到正确的帖子。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter12-6" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter12-6.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>有了分页，我们的程序将不再受规模问题的困扰了，用户可以加入更多的帖子。如果有某种方法可以给帖子链接加上等级 (rank) 不是更好么?我们将在下一章去实现它！</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="voting">投票</h2>
            <span class="chapter-number">13</span>
          </div>
          <p>现在我们的系统更完善了，但是想要找到最受欢迎的帖子有点难。我们需要一个排名系统来给我们的帖子排个序。</p>
          
          <p>我们可以建立一个基于 karma 的复杂排名系统，权值随着时间衰减，和许多其他因素（很多功能都在 <a href="http://telesc.pe/">Telescope</a> 中实现了，他是 Microscope 的大哥）。但是对于我们的例子 app, 我们尽量保持简单，我们只按照帖子收到的投票数为它们排序。</p>
          
          <p>让我们实现一个给用户为帖子投票的方法。</p>
          
          <h3>数据模型</h3>
          
          <p>我们将在帖子中保存投票者列表信息，这样我们能判断是否给用户显示投票按钮，并阻止用户给一个帖子投票两次。</p>
          
          <div class="note"><h3>数据隐私与发布</h3>
          
          <p>我们将向所有用户发布投票者名单，这样也自动使得通过浏览器控制台也可以访问这些数据。</p>
          
          <p>这是一类由于集合工作方式而引发的数据隐私问题。例如，我们是否希望用户能看到谁为他的帖子投了票。在我们的例子中，公开这些信息无关紧要，但重要的是至少知道这是个问题。</p>
          </div>
          
          <p>我们也要非规范化帖子的投票者数量，以便更容易取得这个数值。所以我们给帖子增加两个属性，<code>upvoters</code>（投票者） 和 <code>votes</code>（票数）。让我们先在 fixtures 文件中添加它们:</p>
          <pre class="highlight javascript"><span class="c1">// Fixture data
</span><span class="k">if</span> <span class="p">(</span><span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">count</span><span class="p">()</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>

  <span class="c1">// create two users
</span>  <span class="kd">var</span> <span class="nx">tomId</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">profile</span><span class="p">:</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'Tom Coleman'</span> <span class="p">}</span>
  <span class="p">});</span>
  <span class="kd">var</span> <span class="nx">tom</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">tomId</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">sachaId</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">profile</span><span class="p">:</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'Sacha Greif'</span> <span class="p">}</span>
  <span class="p">});</span>
  <span class="kd">var</span> <span class="nx">sacha</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">sachaId</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">telescopeId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'Introducing Telescope'</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://sachagreif.com/introducing-telescope/'</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="na">commentsCount</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="na">upvoters</span><span class="p">:</span> <span class="p">[],</span>
    <span class="na">votes</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">});</span>

  <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">postId</span><span class="p">:</span> <span class="nx">telescopeId</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="na">body</span><span class="p">:</span> <span class="s1">'Interesting project Sacha, can I get involved?'</span>
  <span class="p">});</span>

  <span class="nx">Comments</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">postId</span><span class="p">:</span> <span class="nx">telescopeId</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="na">body</span><span class="p">:</span> <span class="s1">'You sure can Tom!'</span>
  <span class="p">});</span>

  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'Meteor'</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://meteor.com'</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="na">commentsCount</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="na">upvoters</span><span class="p">:</span> <span class="p">[],</span>
    <span class="na">votes</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">});</span>

  <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'The Meteor Book'</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">author</span><span class="p">:</span> <span class="nx">tom</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="s1">'http://themeteorbook.com'</span><span class="p">,</span>
    <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="na">commentsCount</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="na">upvoters</span><span class="p">:</span> <span class="p">[],</span>
    <span class="na">votes</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">});</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
      <span class="na">title</span><span class="p">:</span> <span class="s1">'Test post #'</span> <span class="o">+</span> <span class="nx">i</span><span class="p">,</span>
      <span class="na">author</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
      <span class="na">userId</span><span class="p">:</span> <span class="nx">sacha</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
      <span class="na">url</span><span class="p">:</span> <span class="s1">'http://google.com/?q=test-'</span> <span class="o">+</span> <span class="nx">i</span><span class="p">,</span>
      <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="nx">i</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
      <span class="na">commentsCount</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">upvoters</span><span class="p">:</span> <span class="p">[],</span>
      <span class="na">votes</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span></pre>
          <div class="caption">server/fixtures.js</div><div class="lines-highlight" data-lines="22,23,49,50,60,61,72,73" data-class="added"></div>
          
          <p>和之前一样，停止你的 app, 执行 <code>meteor reset</code>, 重启 app，创建一个新的用户。让我们确认一下用户创建帖子时，这两个新的属性也被初始化了:</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="kd">var</span> <span class="nx">postWithSameLink</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">url</span><span class="p">:</span> <span class="nx">postAttributes</span><span class="p">.</span><span class="nx">url</span><span class="p">});</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">postWithSameLink</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">postExists</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">_id</span><span class="p">:</span> <span class="nx">postWithSameLink</span><span class="p">.</span><span class="nx">_id</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">user</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
  <span class="na">author</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
  <span class="na">submitted</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
  <span class="na">commentsCount</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="na">upvoters</span><span class="p">:</span> <span class="p">[],</span>
  <span class="na">votes</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>

<span class="k">return</span> <span class="p">{</span>
  <span class="na">_id</span><span class="p">:</span> <span class="nx">postId</span>
<span class="p">};</span>

<span class="c1">//...
</span></pre>
          <div class="caption">collections/posts.js</div><div class="lines-highlight" data-lines="17~18" data-class="added"></div>
          
          <h3>投票模板</h3>
          
          <p>开始时，我们在帖子部分添加一个点赞(upvote)按钮，并在帖子的 metadata 数据中显示被点赞次数:</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postItem"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"upvote btn btn-default"</span><span class="nt">&gt;</span>⬆<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"post-content"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{url}}"</span><span class="nt">&gt;</span>{{title}}<span class="nt">&lt;/a&gt;&lt;span&gt;</span>{{domain}}<span class="nt">&lt;/span&gt;&lt;/h3&gt;</span>
      <span class="nt">&lt;p&gt;</span>
        {{votes}} Votes,
        submitted by {{author}},
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postPage'}}"</span><span class="nt">&gt;</span>{{commentsCount}} comments<span class="nt">&lt;/a&gt;</span>
        {{#if ownPost}}<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postEdit'}}"</span><span class="nt">&gt;</span>Edit<span class="nt">&lt;/a&gt;</span>{{/if}}
      <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postPage'}}"</span> <span class="na">class=</span><span class="s">"discuss btn btn-default"</span><span class="nt">&gt;</span>Discuss<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/post_item.html</div><div class="lines-highlight" data-lines="3,7" data-class="added"></div>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/13-1.png" alt="Upvote 按钮"><figcaption>Upvote 按钮</figcaption></figure>
          
          <p>接下来，当用户点击按钮时调用服务器端的 upvote 方法:</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'click .upvote'</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">'upvote'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_item.js</div><div class="lines-highlight" data-lines="3~8" data-class="added"></div>
          
          <p>最后，我们回到 <code>lib/collections/posts.js</code> 文件，在其中加入一个服务器端方法来 upvote 帖子:</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>
  <span class="na">post</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//...
</span>  <span class="p">},</span>

  <span class="na">upvote</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">check</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nb">String</span><span class="p">);</span>
    <span class="nx">check</span><span class="p">(</span><span class="nx">postId</span><span class="p">,</span> <span class="nb">String</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">postId</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">post</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s1">'invalid'</span><span class="p">,</span> <span class="s1">'Post not found'</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">upvoters</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">userId</span><span class="p">))</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s1">'invalid'</span><span class="p">,</span> <span class="s1">'Already upvoted this post'</span><span class="p">);</span>

    <span class="nx">Posts</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">post</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">$addToSet</span><span class="p">:</span> <span class="p">{</span><span class="na">upvoters</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">userId</span><span class="p">},</span>
      <span class="na">$inc</span><span class="p">:</span> <span class="p">{</span><span class="na">votes</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">lib/collections/posts.js</div><div class="lines-highlight" data-lines="8~25" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 13-1</h4><p>添加基本的投票机制.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter13-1" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter13-1.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>这个方法很清楚。我们做了些检查确保当前用户已经登录和帖子存在。然后检查用户并没有给帖子投过票，检查如果用户没有增加过帖子的投票分数我们将用户添加到 upvoters 集合中。</p>
          
          <p>最后一步我们使用了一些 Mongo 操作符。有很多操作符需要学习，但是这两个尤其有用: <code>$addToSet</code> 将一个 item 加入集合如果它不存在的话，<code>$inc</code> 只是简单的增加一个整型属性。</p>
          
          <h3>用户界面微调</h3>
          
          <p>如果用户没有登录或者已经投过票了，他就不能再投票了。我们需要修改 UI, 我们将用一个帮助方法根据条件添加一个 <code>disabled</code> CSS class 到 upvote 按钮。</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postItem"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"upvote btn btn-default {{upvotedClass}}"</span><span class="nt">&gt;</span>⬆<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"post-content"</span><span class="nt">&gt;</span>
      //...
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/post_item.html</div><div class="lines-highlight" data-lines="3" data-class="added"></div>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">ownPost</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//...
</span>  <span class="p">},</span>
  <span class="na">domain</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//...
</span>  <span class="p">},</span>
  <span class="na">upvotedClass</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">userId</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">upvoters</span><span class="p">,</span> <span class="nx">userId</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s1">'btn-primary upvotable'</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s1">'disabled'</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Template</span><span class="p">.</span><span class="nx">postItem</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'click .upvotable'</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">'upvote'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/posts/post_item.js</div><div class="lines-highlight" data-lines="8~15, 19" data-class="added"></div>
          
          <p>我们将 css class 从 <code>.upvote</code> 变成 <code>.upvotable</code>，别忘了修改 click 事件处理函数。</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/13-2.png" alt="变灰 upvote 按钮."><figcaption>变灰 upvote 按钮.</figcaption></figure>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 13-2</h4><p>变灰 upvote 链接，当未登录或已经投票。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter13-2" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter13-2.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>接下来，你会发现被投过一票的帖子会显示 “1 vote<strong>s</strong>”, 下面让我们花点时间来处理单复数形式。处理单复数是个复杂的事，但在这里我们会用一个非常简单的方法。我们建一个通用的 Spacebars helper 方法来处理他们:</p>
          <pre class="highlight javascript"><span class="nx">UI</span><span class="p">.</span><span class="nx">registerHelper</span><span class="p">(</span><span class="s1">'pluralize'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">thing</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// fairly stupid pluralizer
</span>  <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'1 '</span> <span class="o">+</span> <span class="nx">thing</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">n</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="nx">thing</span> <span class="o">+</span> <span class="s1">'s'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/helpers/spacebars.js</div>
          
          <p>之前我们创建的 helper 方法都是绑定到某个模板的。但是现在我们用 <code>UI.registerHelper</code> 创建一个<em>全局</em>的 helper 方法，我们可以在任何模板中使用它:</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postItem"</span><span class="nt">&gt;</span>

//...

<span class="nt">&lt;p&gt;</span>
  {{pluralize votes "Vote"}},
  submitted by {{author}},
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postPage'}}"</span><span class="nt">&gt;</span>{{pluralize commentsCount "comment"}}<span class="nt">&lt;/a&gt;</span>
  {{#if ownPost}}<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postEdit'}}"</span><span class="nt">&gt;</span>Edit<span class="nt">&lt;/a&gt;</span>{{/if}}
<span class="nt">&lt;/p&gt;</span>

//...

<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/posts/post_item.html</div><div class="lines-highlight" data-lines="6, 8" data-class="added"></div>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/13-3.png" alt="完美复数处理（现在说 10 遍）"><figcaption>完美复数处理（现在说 10 遍）</figcaption></figure>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 13-3</h4><p>添加复数 helper 去更好地格式化文字</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter13-3" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter13-3.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>现在我们看到的是 “1 vote"。</p>
          
          <h3>更智能的投票机制</h3>
          
          <p>我们的投票代码看起来还行，但是我们能做的更好。在 upvote 方法，我们两次调用 Mongo: 第一次找到帖子，第二次更新它。</p>
          
          <p>这里有两个问题。首先，两次调用数据库效率会有点低。但是更重要的是，这里引入了一个竞速状态。我们的逻辑是这样的:</p>
          
          <ol>
          <li>从数据库中找到帖子。</li>
          <li>检查用户是否已经投票。</li>
          <li>如果没有，用户可以投一票。</li>
          </ol>
          
          <p>如果同一个用户在步骤 1 和 3 之间两次投票会如何？我们现在的代码会让用户给同一个帖子投票两次。幸好，Mongo 允许我们将步骤 1-3 合成一个 Mongo 命令：</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>
  <span class="na">post</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postAttributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//...
</span>  <span class="p">},</span>

  <span class="na">upvote</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">check</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nb">String</span><span class="p">);</span>
    <span class="nx">check</span><span class="p">(</span><span class="nx">postId</span><span class="p">,</span> <span class="nb">String</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">affected</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
      <span class="na">_id</span><span class="p">:</span> <span class="nx">postId</span><span class="p">,</span>
      <span class="na">upvoters</span><span class="p">:</span> <span class="p">{</span><span class="na">$ne</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">userId</span><span class="p">}</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="na">$addToSet</span><span class="p">:</span> <span class="p">{</span><span class="na">upvoters</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">userId</span><span class="p">},</span>
      <span class="na">$inc</span><span class="p">:</span> <span class="p">{</span><span class="na">votes</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">affected</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s1">'invalid'</span><span class="p">,</span> <span class="s2">"You weren't able to upvote that post"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//...
</span></pre>
          <div class="caption">collections/posts.js</div><div class="lines-highlight" data-lines="12~21" data-class="added"></div>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 13-4</h4><p>更好的投票机制。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter13-4" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter13-4.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>我们的代码是说“找到 <code>id</code> 是这个并且用户没有投票的帖子，并更新他们为投票”。如果用户还<em>没有</em>投票，就会找到这个 <code>id</code> 的帖子。如果用户<em>已经</em>投过票了，就不会有结果返回。</p>
          
          <div class="note"><h3>Latency Compensation</h3>
          
          <p>假定你想作弊通过修改帖子投票数量来让一个帖子排到榜单的第一名:</p>
          
          <pre><code class="js">&gt; Posts.update(postId, {$set: {votes: 10000}});
</code></pre>
          
          <div class="caption">浏览器控制台</div>
          
          <p>(<code>postId</code> 是你某个帖子的 id)</p>
          
          <p>这个无耻的企图将会被我们系统的 <code>deny()</code> 回调函数捕获(<code>collections/posts.js</code> 记得么?)并且立刻取消。</p>
          
          <p>但是如果你仔细看，你可能会发现系统的延迟补偿 (latency compensation)。它可能一闪而过, 会看到帖子现在第一位闪了一下，然后回到原来的位置。</p>
          
          <p>发生了什么? 在客户端的 <code>Posts</code> 集合，<code>update</code> 方法会被执行。这会立刻发生，因此帖子会来到列表第一的位置。同时，在服务器端 <code>update</code> 方法会被拒绝。过了一会 (如果你在本地运行 Meteor 这个时间间隔会是毫秒级的), 服务器端返回一个错误，告诉客户端 <code>Posts</code> 集合恢复到原来状态。</p>
          
          <p>最终的结果是: 在等待服务器端返回的过程中，UI 只能相信客户端本地集合数据。当服务器端一返回拒绝了修改，UI 就会使用服务器端数据。</p>
          </div>
          
          <h3>排列首页的帖子</h3>
          
          <p>现在每个帖子都有一个基于投票数的分数，让我们显示一个最佳帖子的列表。这样，我们将看到如何管理对于帖子集合的两个不同的订阅，并将我们的 <code>postsList</code> 模板变得更通用一些。</p>
          
          <p>首先，我们需要<em>两个</em>订阅，分别用来排序。这里的技巧是两个订阅同时订阅<em>同一个</em> <code>posts</code> 发布，只是参数不同！</p>
          
          <p>我们还需要新建两个路由 <code>newPosts</code> 和 <code>bestPosts</code>，分别通过 URL <code>/new</code> 和 <code>/best</code> 访问（当然，使用 <code>/new/5</code> 和 <code>/best/5</code> 进行分页）。</p>
          
          <p>我们将继承 <code>PostsListController</code> 来生成两个独立的 <code>NewPostsListController</code> 和 <code>BestPostsListController</code> 控制器。对于 <code>home</code> 和 <code>newPosts</code> 路由，我们可以使用完全一致的路由选项，通过继承同一个 <code>NewPostsListController</code> 控制器。另外，这是一个很好的例子说明 Iron Router 的灵活性。</p>
          
          <p>让我们用 <code>NewPostsListController</code> 和 <code>BestPostsListController</code> 提供的 <code>this.sort</code> 替换 <code>PostsListController</code> 的排序属性 <code>{submitted: -1}</code>:</p>
          <pre class="highlight javascript"><span class="c1">//...
</span>
<span class="nx">PostsListController</span> <span class="o">=</span> <span class="nx">RouteController</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">template</span><span class="p">:</span> <span class="s1">'postsList'</span><span class="p">,</span>
  <span class="na">increment</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="na">postsLimit</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="na">findOptions</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="na">sort</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">sort</span><span class="p">,</span> <span class="na">limit</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">()};</span>
  <span class="p">},</span>
  <span class="na">subscriptions</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">postsSub</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">findOptions</span><span class="p">());</span>
  <span class="p">},</span>
  <span class="na">posts</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">findOptions</span><span class="p">());</span>
  <span class="p">},</span>
  <span class="na">data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">hasMore</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">posts</span><span class="p">().</span><span class="nx">count</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">();</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">posts</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">posts</span><span class="p">(),</span>
      <span class="na">ready</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsSub</span><span class="p">.</span><span class="nx">ready</span><span class="p">,</span>
      <span class="na">nextPath</span><span class="p">:</span> <span class="nx">hasMore</span> <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">nextPath</span><span class="p">()</span> <span class="p">:</span> <span class="kc">null</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">NewPostsController</span> <span class="o">=</span> <span class="nx">PostsListController</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">sort</span><span class="p">:</span> <span class="p">{</span><span class="na">submitted</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="na">_id</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
  <span class="na">nextPath</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Router</span><span class="p">.</span><span class="nx">routes</span><span class="p">.</span><span class="nx">newPosts</span><span class="p">.</span><span class="nx">path</span><span class="p">({</span><span class="na">postsLimit</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">()</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">})</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">BestPostsController</span> <span class="o">=</span> <span class="nx">PostsListController</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">sort</span><span class="p">:</span> <span class="p">{</span><span class="na">votes</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="na">submitted</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="na">_id</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
  <span class="na">nextPath</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Router</span><span class="p">.</span><span class="nx">routes</span><span class="p">.</span><span class="nx">bestPosts</span><span class="p">.</span><span class="nx">path</span><span class="p">({</span><span class="na">postsLimit</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postsLimit</span><span class="p">()</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">increment</span><span class="p">})</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'home'</span><span class="p">,</span>
  <span class="na">controller</span><span class="p">:</span> <span class="nx">NewPostsController</span>
<span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/new/:postsLimit?'</span><span class="p">,</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'newPosts'</span><span class="p">});</span>

<span class="nx">Router</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">'/best/:postsLimit?'</span><span class="p">,</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'bestPosts'</span><span class="p">});</span></pre>
          <div class="caption">lib/router.js</div><div class="lines-highlight" data-lines="10,23,27~55" data-class="added"></div>
          
          <p>注意现在我们有多个路由，我们将 <code>nextPath</code> 逻辑从 <code>PostsListController</code> 移到 <code>NewPostsController</code> 和 <code>BestPostsController</code>, 因为两个控制器的 path 都不相同。</p>
          
          <p>另外，当我们根据投票数排序时，然后根据发布时间戳和 <code>_id</code> 确保顺序。</p>
          
          <p>有了新的控制器，我们可以安全的删除之前的 <code>postList</code> 路由。删除下面的代码：</p>
          <pre class="highlight plaintext"> Router.route('/:postsLimit?', {
  name: 'postsList'
 })</pre>
          <div class="caption">lib/router.js</div>
          
          <p>在 header 中加入链接：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"header"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-default"</span> <span class="na">role=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"navbar-toggle collapsed"</span> <span class="na">data-toggle=</span><span class="s">"collapse"</span> <span class="na">data-target=</span><span class="s">"#navigation"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"sr-only"</span><span class="nt">&gt;</span>Toggle navigation<span class="nt">&lt;/span&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"{{pathFor 'home'}}"</span><span class="nt">&gt;</span>Microscope<span class="nt">&lt;/a&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse navbar-collapse"</span> <span class="na">id=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'newPosts'}}"</span><span class="nt">&gt;</span>New<span class="nt">&lt;/a&gt;</span>
          <span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'bestPosts'}}"</span><span class="nt">&gt;</span>Best<span class="nt">&lt;/a&gt;</span>
          <span class="nt">&lt;/li&gt;</span>
          {{#if currentUser}}
            <span class="nt">&lt;li&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postSubmit'}}"</span><span class="nt">&gt;</span>Submit Post<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              {{&gt; notifications}}
            <span class="nt">&lt;/li&gt;</span>
          {{/if}}
        <span class="nt">&lt;/ul&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
          {{&gt; loginButtons}}
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/includes/header.html</div><div class="lines-highlight" data-lines="11, 15~20" data-class="added"></div>
          
          <p>最后，我们还需要更新帖子的删除 deleting 事件处理函数:</p>
          <pre class="highlight html">  'click .delete': function(e) {
    e.preventDefault();

    if (confirm("Delete this post?")) {
      var currentPostId = this._id;
      Posts.remove(currentPostId);
      Router.go('home');
    }
  }</pre>
          <div class="caption">client/templates/posts_edit.js</div><div class="lines-highlight" data-lines="7" data-class="added"></div>
          
          <p>这些都做完了，现在我们得到了一个最佳帖子列表：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/13-4.png" alt="通过票数排列"><figcaption>通过票数排列</figcaption></figure>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 13-5</h4><p>添加帖子列表路由和显示页面。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter13-5" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter13-5.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <h3>更好的 Header</h3>
          
          <p>现在我们有两个帖子列表页面，你很难分清你正在看的是哪个列表。现在让我们把页面的 header 变得更明显些。我们将创建一个 <code>header.js</code> manager 并创建一个 helper 使用当前的路径和一个或者多个命名路由来给我们的导航条加一个 active class:</p>
          
          <p>支持多个命名路由的原因是 <code>home</code> 和 <code>newPosts</code> 路由 (分别对应 URL <code>/</code> 和 <code>new</code>) 使用同一个模板。这意味着我们的 <code>activeRouteClass</code> 足够聪明可以处理以上情形将 <code>&lt;li&gt;</code> 标签标记为 active。</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"header"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-default"</span> <span class="na">role=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"navbar-toggle collapsed"</span> <span class="na">data-toggle=</span><span class="s">"collapse"</span> <span class="na">data-target=</span><span class="s">"#navigation"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"sr-only"</span><span class="nt">&gt;</span>Toggle navigation<span class="nt">&lt;/span&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"{{pathFor 'home'}}"</span><span class="nt">&gt;</span>Microscope<span class="nt">&lt;/a&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse navbar-collapse"</span> <span class="na">id=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"{{activeRouteClass 'home' 'newPosts'}}"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'newPosts'}}"</span><span class="nt">&gt;</span>New<span class="nt">&lt;/a&gt;</span>
          <span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"{{activeRouteClass  'bestPosts'}}"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'bestPosts'}}"</span><span class="nt">&gt;</span>Best<span class="nt">&lt;/a&gt;</span>
          <span class="nt">&lt;/li&gt;</span>
          {{#if currentUser}}
            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"{{activeRouteClass 'postSubmit'}}"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{pathFor 'postSubmit'}}"</span><span class="nt">&gt;</span>Submit Post<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown"</span><span class="nt">&gt;</span>
              {{&gt; notifications}}
            <span class="nt">&lt;/li&gt;</span>
          {{/if}}
        <span class="nt">&lt;/ul&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav navbar-nav navbar-right"</span><span class="nt">&gt;</span>
          {{&gt; loginButtons}}
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">client/templates/includes/header.html</div><div class="lines-highlight" data-lines="15,18,22" data-class="added"></div>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">helpers</span><span class="p">({</span>
  <span class="na">activeRouteClass</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="cm">/* route names */</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">args</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">active</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Router</span><span class="p">.</span><span class="nx">current</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">Router</span><span class="p">.</span><span class="nx">current</span><span class="p">().</span><span class="nx">route</span><span class="p">.</span><span class="nx">getName</span><span class="p">()</span> <span class="o">===</span> <span class="nx">name</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">active</span> <span class="o">&amp;&amp;</span> <span class="s1">'active'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">client/templates/includes/header.js</div>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/13-5.png" alt="显示当前页面"><figcaption>显示当前页面</figcaption></figure>
          
          <div class="note"><h3>Helper 参数</h3>
          
          <p>到现在为止我们没有使用特殊的设计模式，但是像其他 Spacebars 标签一样，模板的 helper 标签可以带参数。</p>
          
          <p>你可以给你的函数传递命名的参数，你也可以传入不指定数量的匿名参数并在函数中用 <code>arguments</code> 对象访问他们。</p>
          
          <p>在最后一种情况，你可能想将 <code>arguments</code> 对象转换成一个一般的 JavaScript 数组，然后调用 <code>pop()</code> 方法移除末尾的内容。</p>
          </div>
          
          <p>对于每一个导航链接， <code>activeRouteClass</code> helper 可以带一组路由名称，然后使用 Underscore 的 <code>any()</code> helper 方法检查哪一个通过测试 (例如: 他们的 URL 等于当前路径)。</p>
          
          <p>如果路由匹配当前路径，<code>any()</code> 方法将返回 <code>true</code>。最后，我们利用 JavaScript 的 <code>boolean &amp;&amp; string</code> 模式，当 <code>false &amp;&amp; myString</code> 返回 <code>false</code>, 当 <code>true &amp;&amp; myString</code> 返回 <code>myString</code>。</p>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 13-6</h4><p>在 header 中添加当前样式。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter13-6" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter13-6.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>现在用户可以给帖子实时投票了，你将看到帖子随着得票多少上下变化。如果有一些动画效果不是更好？</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="advanced-publications">高级发布机制</h2>
            <span class="sidebar-marker">Sidebar</span>
            <span class="chapter-number">13.5</span>
          </div>
          <p>目前你应该对发布和订阅交互模式有一个不错的掌握了。因此，我们废话少说，来看几个更高级的情景。</p>
          
          <h3>多次发布一个集合</h3>
          
          <p>在<a href="http://zh.discovermeteor.com/chapter/publications-and-subscriptions/">我们第一个关于发布的附录中</a>，我们看到了一些更普遍的发布和订阅模式，同时我们学习了 <code>_publishCursor</code> 函数，如何让它们非常容易地实现在我们的站点上。</p>
          
          <p>首先，让我们回忆 <code>_publishCursor</code> 到底为我们做了什么：它将整理所有的文档以匹配一个给定的游标（cursor），并将它们推送至<em>同名的</em>客户端集合中。注意这与 <em>publication</em> 的名字是不关联的。</p>
          
          <p>这意味着我们可以用<em>不止一个 publicaton</em> 去连接任何集合的客户端与服务端版本。</p>
          
          <p>我们已经在<a href="http://zh.discovermeteor.com/chapter/pagination/">分页章节</a>用过这个模式，当我们在当前显示的帖子之外，再发布一个所有帖子的分页后的子集。</p>
          
          <p>另一个相似的用例是发布一大组文档的<em>预览</em>，和单个文档的全部信息：</p>
          
          <figure class="diagram pull-center"><img src="DiscoverMeteor_files/doublecollection2x.png" alt="两次发布一个集合"><figcaption>两次发布一个集合</figcaption></figure>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'allPosts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="na">fields</span><span class="p">:</span> <span class="p">{</span><span class="na">title</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">author</span><span class="p">:</span> <span class="kc">true</span><span class="p">}});</span>
<span class="p">});</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'postDetail'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">postId</span><span class="p">);</span>
<span class="p">});</span></pre>
          <p>现在客户端订阅这两个发布，这 <code>'posts'</code> 集合来自于两个源渠道：来自第一个订阅的标题和作者姓名列表，和来自第二个订阅的单个帖子全部信息。</p>
          
          <p>你也许意识到了 <code>postDetail</code> 发布的帖子也被 <code>allPosts</code> 发布了（尽管只有它的部分属性）。但是，Meteor 会合并字段及确认没有重复的帖子，来处理数据重叠的问题。</p>
          
          <p>这是很棒的，因为现在当我们呈现帖子摘要列表时，我们正在处理的数据对象正好拥有我们需要显示的足够数据。但是，当我们呈现单
个帖子时，我们有一切需要展示的数据。当然，在这种情况下，我们需要让客户端不要去期待所有帖子的所有字段都能都显示出来————这是一个常见的问题！</p>
          
          <p>注意你并没有改变文档属性的任何限制。你可以很好地在这两个发布中发布同样的属性，但是先后排序不同。</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'newPosts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">limit</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="na">sort</span><span class="p">:</span> <span class="p">{</span><span class="na">submitted</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="na">limit</span><span class="p">:</span> <span class="nx">limit</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'bestPosts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">limit</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="na">sort</span><span class="p">:</span> <span class="p">{</span><span class="na">votes</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="na">submitted</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="na">limit</span><span class="p">:</span> <span class="nx">limit</span><span class="p">});</span>
<span class="p">});</span></pre>
          <div class="caption">server/publications.js</div>
          
          <h3>多次订阅一个发布</h3>
          
          <p>我们已经看了如何多次发布同一个集合。事实证明你可以通过另一个模式来完成非常相近的结果：建立一个单一发布，却多次<em>订阅</em>它。</p>
          
          <p>在 Microscope 中，我们多次重复订阅 <code>posts</code> 发布，但 Iron Router 为我们设置并拆开每次的订阅。然而，没有理由我们不能<em>同时进行</em>多次订阅。</p>
          
          <p>举个例子，我们想要将最新的和最好的帖子同时载入内存：</p>
          
          <figure class="diagram pull-center"><img src="DiscoverMeteor_files/subscribetwice2x.png" alt="对一个发布订阅两次"><figcaption>对一个发布订阅两次</figcaption></figure>
          
          <p>我们设定一个单一发布：</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="nx">options</span><span class="p">);</span>
<span class="p">});</span></pre>
          <p>并且我们多次订阅这个发布。事实上或多或少我们在 Microscope 里这样做了：</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="p">{</span><span class="na">submitted</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="na">limit</span><span class="p">:</span> <span class="mi">10</span><span class="p">});</span>
<span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="p">{</span><span class="na">baseScore</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="na">submitted</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="na">limit</span><span class="p">:</span> <span class="mi">10</span><span class="p">});</span></pre>
          <p>接下来到底发生什么了？每个浏览器开启了<em>两个</em>不同的订阅，每个订阅连接到<em>同个</em>服务端的发布。</p>
          
          <p>每个订阅提供了不同的发布参数，但从根本上，每次一个（不同）文档子集从 <code>posts</code> 集合提取出来，并通过连接机制发送到客户端集合。</p>
          
          <p>你甚至可以用<em>同样的参数</em>订阅两次相同的发布。这个对很多处场景来说很难说有用，但这种弹性机制总有一天会有用的。</p>
          
          <h3>单一订阅中的多个集合</h3>
          
          <p>不像传统关系型数据库像 MySQL 使用 <em>joins</em>，NoSQL 数据库类似 Mongo 都是关于<em>去规范化</em>和<em>嵌入</em>。让我们看看它们是怎样在 Meteor 环境下工作的。</p>
          
          <p>让我们看一个具体的例子。我们已经对我们的帖子添加了评论，到目前为止，我们一直很愉快地只发布用户看的单个帖子的评论。</p>
          
          <p>但是，假设我们希望在首页中显示<em>全部</em>帖子的回复（记着这些帖子会在分页时被改变）。这个用例展示了一个很好的理由把评论嵌入帖子中，事实上这是促使我们来非规范化评论<em>数量</em>。</p>
          
          <p>当然我们可以总是嵌入评论到帖子中，并完全摒除 <code>Comments</code> 集合。但如同我们前面在<em>去规范化</em>章节看到的，我们将在分离的集合的操作中也会失去一些额外的好处。</p>
          
          <p>但是事实证明有一个涉及订阅的技巧，在保持分离集合的同时再嵌入我们的评论。</p>
          
          <p>让我们假定除了首页帖子列表之外，我们希望再订阅每个帖子的两个最新评论。</p>
          
          <p>使用独立的评论发布会很难完成这个要求，尤其在帖子列表受到某些限制时（比如说，最近的10个）。我们必须写一个发布，看起来像下面的代码：</p>
          
          <figure class="diagram pull-center"><img src="DiscoverMeteor_files/multiplecollections2x.png" alt="一个订阅中的两个集合"><figcaption>一个订阅中的两个集合</figcaption></figure>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'topComments'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">topPostIds</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">postId</span><span class="p">:</span> <span class="nx">topPostIds</span><span class="p">});</span>
<span class="p">});</span></pre>
          <p>从性能角度来看这是个问题，因为这个发布将需要每次在 <code>topPostIds</code> 改变时消除及重新建立。</p>
          
          <p>有一个途径来解决这个问题。我们可以应用这个事实：就是我们不仅可以在每个<em>集合</em>上拥有多次<em>发布</em>，而且我们也可以在每个<em>发布</em>上拥有多个<em>集合</em>。</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'topPosts'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">limit</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sub</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">commentHandles</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">postHandle</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="c1">// send over the top two comments attached to a single post
</span>  <span class="kd">function</span> <span class="nx">publishPostComments</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">commentsCursor</span> <span class="o">=</span> <span class="nx">Comments</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">postId</span><span class="p">:</span> <span class="nx">postId</span><span class="p">},</span> <span class="p">{</span><span class="na">limit</span><span class="p">:</span> <span class="mi">2</span><span class="p">});</span>
    <span class="nx">commentHandles</span><span class="p">[</span><span class="nx">postId</span><span class="p">]</span> <span class="o">=</span>
      <span class="nx">Mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">_publishCursor</span><span class="p">(</span><span class="nx">commentsCursor</span><span class="p">,</span> <span class="nx">sub</span><span class="p">,</span> <span class="s1">'comments'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">postHandle</span> <span class="o">=</span> <span class="nx">Posts</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="na">limit</span><span class="p">:</span> <span class="nx">limit</span><span class="p">}).</span><span class="nx">observeChanges</span><span class="p">({</span>
    <span class="na">added</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">post</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">publishPostComments</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
      <span class="nx">sub</span><span class="p">.</span><span class="nx">added</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">post</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">changed</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">sub</span><span class="p">.</span><span class="nx">changed</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">fields</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">removed</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// stop observing changes on the post's comments
</span>      <span class="nx">commentHandles</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">commentHandles</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">stop</span><span class="p">();</span>
      <span class="c1">// delete the post
</span>      <span class="nx">sub</span><span class="p">.</span><span class="nx">removed</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">sub</span><span class="p">.</span><span class="nx">ready</span><span class="p">();</span>

  <span class="c1">// make sure we clean everything up (note `_publishCursor`
</span>  <span class="c1">//   does this for us with the comment observers)
</span>  <span class="nx">sub</span><span class="p">.</span><span class="nx">onStop</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">postHandle</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span> <span class="p">});</span>
<span class="p">});</span></pre>
          <p>注意我们在这个发布中没有返回任何东西，因为我们自己手动给 <code>sub</code> 发送信息（通过 <code>.added()</code> 等方式）。所以我们不必通过返回一个游标来请求 <code>_publishCursor</code> 给我们来做这个动作。</p>
          
          <p>现在，每次我们发布一个帖子时，我们也自动发布其2个最新评论。而且所有都在一个订阅调用中！</p>
          
          <p>虽然 Meteor 还未直接实现这个方法，但是你也可以参考在 Atomsphere 里的 <code>publish-with-relations</code> 包，它的目标就是让这个模式更容易使用。</p>
          
          <h3>连接不同的集合</h3>
          
          <p>这样的订阅弹性机制还能给我们更多新知识么？当然，如果我们不使用 <code>_publishCursor</code>，我们不必跟着此项约束，就是在服务端的源集合需要与客户端的目标集合有同样的名称。</p>
          
          <figure class="diagram pull-center"><img src="DiscoverMeteor_files/linkedcollections2x.png" alt="一个集合对两个订阅"><figcaption>一个集合对两个订阅</figcaption></figure>
          
          <p>为什么我们想这么做的一个原因就是<em>单表继承</em>。</p>
          
          <p>假设我们需要从我们的帖子中引用多种类型的对象，每一个对象存储在相同字段中但又显然是不同内容。例如，我们建立一个类似 Tumblr 的博客引擎，每个帖子具有常见的 ID、时间戳，以及标题；但是额外也有如图像、视频、链接，或者只是文字。</p>
          
          <p>我们可以将这些对象存储在一个单独的 <code>'resources'</code> 集合中，使用 <code>type</code> 属性来标记他们是什么类型的对象（<code>video</code>、<code>image</code>、<code>link</code> 等等）。</p>
          
          <p>同时，虽然我们有一个服务端的单一的 <code>Resources</code> 集合，我们也能够将单一集合转换到多个的 <code>Videos</code>、`Images'，等等集合中。
          客户端的集合如下的代码：</p>
          <pre class="highlight javascript">  <span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'videos'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">sub</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">videosCursor</span> <span class="o">=</span> <span class="nx">Resources</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">type</span><span class="p">:</span> <span class="s1">'video'</span><span class="p">});</span>
    <span class="nx">Mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">_publishCursor</span><span class="p">(</span><span class="nx">videosCursor</span><span class="p">,</span> <span class="nx">sub</span><span class="p">,</span> <span class="s1">'videos'</span><span class="p">);</span>

    <span class="c1">// _publishCursor doesn't call this for us in case we do this more than once.
</span>    <span class="nx">sub</span><span class="p">.</span><span class="nx">ready</span><span class="p">();</span>
  <span class="p">});</span></pre>
          <p>我们告诉 <code>_publishCursor</code> (就像返回）游标会做的一样发布我们的视频，但不是将 <code>resources</code> 集合发布到客户端，而是我们从 <code>resources</code> 发布到 <code>videos</code>。</p>
          
          <p>另一个类似的主意是：发布到客户端的集合，却根本<em>没有服务端集合</em>！举例，你也许从一个第三方服务中抓取数据，并发布它们到一个客户端集合。</p>
          
          <p>由于发布 API 的灵活性，可能性是无限的。</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="animations">动画</h2>
            <span class="chapter-number">14</span>
          </div>
          <p>我们现在有了实时的投票、评分和排名。然而，由于帖子在首页上跳来跳去，导致了跳动不稳的用户体验。我们用动画来平滑这种过渡。</p>
          
          <h3>介绍 <code>_uihooks</code></h3>
          
          <p><code>_uihooks</code> 相对较新，Blaze 文档也未包含该特性。正如其名称所示，它提供了每当插入、删除或动画元素时可以被触发的 hooks。</p>
          
          <p>Hooks 的全部清单如下：</p>
          
          <ul>
          <li><code>insertElement</code>: 当新元素被插入时调用。</li>
          <li><code>moveElement</code>: 当元素被移动时调用。</li>
          <li><code>removeElement</code>: 当元素被删除时调用。</li>
          </ul>
          
          <p>一旦定义，这些 hooks 就会<em>替代</em> Meteor 的默认行为。换句话说，Meteor 会用我们规定的行为来替代默认的插入、移动或删除元素的行为 ———— 这由我们来确定这行为会真正地工作！</p>
          
          <h3>Meteor 与 DOM</h3>
          
          <p>在我们开始有趣部分（使东西移动）之前，我们需要理解 Meteor 如何与 DOM（Document Object Model————组成页面内容的 HTML 元素集合）交互的。</p>
          
          <p>要记住的最关键的一点是，DOM 元素不能真正被“移动”；但是，它们可以被删除，被创建（注意，这是 DOM 
本身的限制，而不是 Meteor 的）。所以要给元素 A 和 B 互换位置的错觉，Meteor 实际上会删除元素 B，并在元素 A 
前插入一个全新的副本（B'）。</p>
          
          <p>这使得动画有点麻烦，因为我们不能只是把 B 动画移动到新位置，因为 B 在 Meteor 重新渲染页面时就会消失（由于响应性，这瞬间发生）。但请不要担心，我们会找到一个解决办法。</p>
          
          <h3>苏联赛跑者</h3>
          
          <p>不过首先，让我们讲个故事。</p>
          
          <p>在 1980 年，正值冷战。奥运会正在莫斯科举行，苏联决心不惜任何代价要赢得 100 米短跑的金牌。所以，一群聪明的苏联科学家为其中一名运动员装备了一台传送器，只要枪声一响，那名运动员就会瞬间消失，通过时空连续的作用直接出现在终点线上。</p>
          
          <p>还好，赛事官员立刻注意到了这个违规行为，这名运动员没有办法只好又瞬时移动回到起跑器上，才能被允许像其他选手一样赛跑参赛。</p>
          
          <p>我的历史资料没有那么可靠，所以你应该对这个故事半信半疑。但是，尽量尝试记住“有传送器的苏联赛跑者”这个比喻，我们要在这一章中用到这一点。</p>
          
          <h3>分解</h3>
          
          <p>当 Meteor 接收到更新并实时地更改 DOM 时，我们的帖子会立即传送到它的终点位置，就像苏联赛跑者一样。但是不论是在奥运会还是在我们的应用中，我们不能瞬移任何东西。所以我们需要把元件传送回到“起跑器”上，使它“跑”（换句话说，“动画”它）到终点。</p>
          
          <p>所以交换帖子 A 和 B （分别位于 p1 和 p2 位置），我们会经过如下步骤：</p>
          
          <ol>
          <li>删除 B</li>
          <li>在 DOM 中，在 A 之前创建 B'</li>
          <li>传送 B' 到 p2 位置</li>
          <li>传送 A 到 p1 位置</li>
          <li>动画 A 到 p2 位置</li>
          <li>动画 B' 到 p1 位置</li>
          </ol>
          
          <p>下面图表详细解释上述步骤：</p>
          
          <figure class="diagram pull-center"><img src="DiscoverMeteor_files/animation_diagram2x.png" alt="两个帖子换位"><figcaption>两个帖子换位</figcaption></figure>
          
          <p>再次说明，第 3 、4 步中，我们没有<em>动画</em> A 和 B' 到它们的位置，而是瞬间“传送”了它们。因为这是瞬间发生的，这会产生 B 没有被删除的幻觉，并且两个元素被动画到了它们的新位置。</p>
          
          <p>默认情况下，Meteor 负责步骤 1 和 2，我们自己很容易重新实施它们。在步骤 5 和 6 中所有我们在做的事情是移动元素到正确的位置。因此，唯一我们真正需要担心的部分是步骤 3 和 4，即，发送元素到动画的起点。</p>
          
          <h3>CSS 定位</h3>
          
          <p>为了在页面中动画渲染的帖子，我们必须用到 CSS 样式。让我们按顺序快速浏览 CSS 定位。</p>
          
          <p>页面元素默认使用<strong>静态</strong>定位。静态定位的元素适应页面内容流，它们在屏幕上的坐标不能更改或动画。</p>
          
          <p>另一方面，<strong>相对</strong>定位是说元素也同样适应页面内容流，但是可以<em>相对于原始位置</em>进行定位。</p>
          
          <p><strong>绝对</strong>定位更进一步，允许你规定元素的 x/y 坐标，坐标相对于<strong>文档</strong>或<strong>第一个绝对或相对定位的父元素</strong>。</p>
          
          <p>我们使用相对定位来动画我们的帖子。我们已经为你准备好了 CSS，你需要做的就是将代码添加到你的样式表中：</p>
          <pre class="highlight css"><span class="nc">.post</span><span class="p">{</span>
  <span class="nl">position</span><span class="p">:</span><span class="nb">relative</span><span class="p">;</span>
  <span class="nl">transition</span><span class="p">:</span><span class="n">all</span> <span class="n">300ms</span> <span class="n">0ms</span> <span class="n">ease-in</span><span class="p">;</span>
<span class="p">}</span></pre>
          <div class="caption">client/stylesheets/style.css</div>
          
          <p>这使步骤 5 和 6 变得简单：我们需要做的是重置 <code>top</code> 坐标值为 <code>0px</code>（默认值），帖子就会回到它们“正常的”位置。</p>
          
          <p>基本上，我们仅有的挑战是搞明白元素要从相对于它们新位置的哪里开始动画（步骤 3 和 4），换句话说，它们要偏移多少。但这也不难：正确的偏移量就是帖子的原来位置减去它的新位置。</p>
          
          <h3>使用 <code>_uihooks</code></h3>
          
          <p>既然我们了解了为帖子列表添加动画的各种因素，我们算是准备好开始添加动画了。我们首先需要把帖子列表放入一个新的 <code>.wrapper</code> 容器元素中：</p>
          <pre class="highlight html"><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"postsList"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"posts page"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"wrapper"</span><span class="nt">&gt;</span>
      {{#each posts}}
        {{&gt; postItem}}
      {{/each}}
    <span class="nt">&lt;/div&gt;</span>

    {{#if nextPath}}
      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"load-more"</span> <span class="na">href=</span><span class="s">"{{nextPath}}"</span><span class="nt">&gt;</span>Load more<span class="nt">&lt;/a&gt;</span>
    {{else}}
      {{#unless ready}}
        {{&gt; spinner}}
      {{/unless}}
    {{/if}}
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span></pre>
          <div class="caption">/client/templates/posts/post_list.html</div><div class="lines-highlight" data-lines="3,7" data-class="added"></div>
          
          <p>在做其他事情之前，让我们看看当前<strong>没有</strong>动画效果的帖子列表：</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/14-1.xml" alt="没有动画效果的帖子列表。"><figcaption>没有动画效果的帖子列表。</figcaption></figure>
          
          <p>现在让我们加入 <code>_uihooks</code>。在模板 <code>onRendered</code> 回调函数中，选择 <code>.wrapper</code> div，并定义一个 <code>moveElement</code> 的 hook。</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postsList</span><span class="p">.</span><span class="nx">onRendered</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.wrapper'</span><span class="p">).</span><span class="nx">_uihooks</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">moveElement</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 现在不做任何事情
</span>    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">/client/templates/posts/post_list.js</div><div class="lines-highlight" data-lines="1~7" data-class="added"></div>
          
          <p>刚刚定义的 <code>moveElement</code> 会在元素位置改变时被调用，从而取代 Blaze 的默认行为。由于现在这个函数还是空的，意味着<em>什么都不会发生</em>。</p>
          
          <p>去试一下：打开“Best”最佳帖子页面，给一些帖子投票：帖子排序不会发生变化，除非强制刷新（刷新页面或改变路径）。</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/14-2.xml" alt="空的 moveElement 回调函数：什么也不会发生"><figcaption>空的 moveElement 回调函数：什么也不会发生</figcaption></figure>
          
          <p>我们已经验证 <code>_uihooks</code> 可以工作，现在让我们来动画它！</p>
          
          <h3>帖子排序的动画效果</h3>
          
          <p><code>moveElement</code> hook 接受两个参数：<code>node</code> 和 <code>next</code>。</p>
          
          <ul>
          <li><code>node</code> 是当前正在移动到新位置的 DOM 元素</li>
          <li><code>next</code> 是 <code>node</code> 移动的新位置<em>之后</em>的元素</li>
          </ul>
          
          <p>了解这些之后，我们可以逐一实现如下动画过程（如果你需要刷新一下你的记忆，可参考之前“苏联赛跑者”的例子）。当一个新的位置改变发生时，我们将：</p>
          
          <ol>
          <li>在 <code>next</code> 前插入 <code>node</code>（换句话说，如果我们没有指定任何 <code>moveElement</code> hook 的话，默认行为就会发生）。</li>
          <li>移动 <code>node</code> 回到它的起始位置。</li>
          <li>微调 <code>node</code> 和 <code>next</code> 之间的每个元素，为 <code>node</code> 腾出空间。</li>
          <li>动画所有元素回到它们的新默认位置。</li>
          </ol>
          
          <p>我们通过 <a href="http://jquery.com/">jQuery</a> 的魔力来做这些事情，这也是迄今为止最好的操作 DOM 的 JavaScript 库。jQuery 已经超出本书范围，但是让我们快速浏览一下我们即将用到的 jQuery 方法：</p>
          
          <ul>
          <li><a href="http://api.jquery.com/jQuery/"><code>$()</code></a>：使任何一个 DOM 元素成为 jQuery 对象。</li>
          <li><a href="http://api.jquery.com/offset/"><code>offset()</code></a>：取得元素相对于<em>文档</em>的当前位置，返回包含 <code>top</code> 和 <code>left</code> 属性的对象。</li>
          <li><a href="http://api.jquery.com/outerHeight/"><code>outerHeight()</code></a>：取得“outer”元素的高度（包括 padding 和可选的 margin）。</li>
          <li><a href="http://api.jquery.com/nextUntil/"><code>nextUntil(selector)</code></a>：取得所有目标元素之后到（但不包含）匹配 <code>selector</code> 的元素。</li>
          <li><a href="http://api.jquery.com/insertBefore/"><code>insertBefore(selector)</code></a>：在匹配 <code>selector</code> 的元素之前插入另一个元素。</li>
          <li><a href="http://api.jquery.com/removeClass/"><code>removeClass(class)</code></a>：如果该元素有 <code>class</code> CSS 类，删除它。</li>
          <li><a href="http://api.jquery.com/css/"><code>css(propertyName, propertyValue)</code></a>：设置 CSS <code>propertyName</code> 属性为 <code>propertyValue</code>。</li>
          <li><a href="http://api.jquery.com/height/"><code>height()</code></a>：取得该元素的高度。</li>
          <li><a href="http://api.jquery.com/addClass/"><code>addClass(class)</code></a>：为元素添加 <code>class</code> CSS 类。</li>
          </ul>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postsList</span><span class="p">.</span><span class="nx">onRendered</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.wrapper'</span><span class="p">).</span><span class="nx">_uihooks</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">moveElement</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">$node</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">),</span> <span class="nx">$next</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">oldTop</span> <span class="o">=</span> <span class="nx">$node</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">$node</span><span class="p">.</span><span class="nx">outerHeight</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

      <span class="c1">// 找出 next 与 node 之间所有的元素
</span>      <span class="kd">var</span> <span class="nx">$inBetween</span> <span class="o">=</span> <span class="nx">$next</span><span class="p">.</span><span class="nx">nextUntil</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">$inBetween</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nx">$inBetween</span> <span class="o">=</span> <span class="nx">$node</span><span class="p">.</span><span class="nx">nextUntil</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>

      <span class="c1">// 把 node 放在预订位置
</span>      <span class="nx">$node</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>

      <span class="c1">// 测量新 top 偏移坐标
</span>      <span class="kd">var</span> <span class="nx">newTop</span> <span class="o">=</span> <span class="nx">$node</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span><span class="p">;</span>

      <span class="c1">// 将 node *移回*至原始所在位置
</span>      <span class="nx">$node</span>
        <span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'animate'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">'top'</span><span class="p">,</span> <span class="nx">oldTop</span> <span class="o">-</span> <span class="nx">newTop</span><span class="p">);</span>

      <span class="c1">// push every other element down (or up) to put them back
</span>      <span class="nx">$inBetween</span>
        <span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'animate'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">'top'</span><span class="p">,</span> <span class="nx">oldTop</span> <span class="o">&lt;</span> <span class="nx">newTop</span> <span class="p">?</span> <span class="nx">height</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">height</span><span class="p">);</span>

      <span class="c1">// 强制重绘
</span>      <span class="nx">$node</span><span class="p">.</span><span class="nx">offset</span><span class="p">();</span>

      <span class="c1">// 动画，重置所有元素的 top 坐标为 0
</span>      <span class="nx">$node</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'animate'</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">'top'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="nx">$inBetween</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'animate'</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">'top'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">/client/templates/posts/post_list.js</div>
          
          <p>注解：</p>
          
          <ul>
          <li>我们计算 <code>$node</code> 的高度，便于知道要偏移 <code>$inBetween</code> 的元素多少距离。我们使用 <code>outerHeight(true)</code> 使 margin 和 padding 加入计算中。</li>
          <li>在 DOM 中，我们不知道 <code>next</code> 是在 <code>node</code> 之前还是之后，所以我们在定义 <code>$inBetween</code> 时同时考虑这两种情况。</li>
          <li>为了在“传送 teleporting”和“动画 animating”元素之间转换，我们简单地 toggle <code>animate</code> CSS 类（在 CSS 样式表中定义了实际动画）。</li>
          <li>由于我们用相对定位，所以我们总可以通过重置任何元素的 <code>top</code> 属性值为 0 来把元素归位到应在位置。</li>
          </ul>
          
          <div class="note"><h3>强制 Redraw</h3>
          
          <p>你也许在想 <code>$node.offset()</code> 这行代码。为什么我们不打算移动 <code>$node</code>，而去关心它的位置呢？</p>
          
          <p>要这么想：如果你告诉一台有完美逻辑的机器人向北奔跑 5 千米，跑完后再跑回起点，它也许认为既然又回到起点，那么何不节省能量而待在原地。</p>
          
          <p>所以为了确保机器人能跑完 10 千米，我们会告诉它在跑到 5 千米时记录它的坐标才能转向。</p>
          
          <p>浏览器以相似的方式工作：如果我们在同一时间只给出 <code>css('top', oldTop - newTop)</code> 和 <code>css('top', 0)</code> 的话，新坐标就会简单地替换旧坐标，什么也不会发生。如果我们想真正地看到动画，就需要强制浏览器去在元素改变位置后重新绘制它。</p>
          
          <p>一个简单的强制重绘的方法是让浏览器检查元素的 <code>offset</code> 属性————再次重绘元素才能让浏览器识别它。</p>
          </div>
          
          <p>让我们再试一次。回到“Best”最佳帖子页面，给帖子投票：现在应该可以看到帖子如芭蕾舞般优雅地上下滑动。</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/14-3.xml" alt="带动画的排序"><figcaption>带动画的排序</figcaption></figure>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 14-1</h4><p>添加了帖子排序动画。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter14-1" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter14-1.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <h3>Can’t Fade Me</h3>
          
          <p>既然我们已经搞定比较难的重新排序，那么插入和删除帖子的动画就是小菜一碟了！</p>
          
          <p>首先，我们渐入新帖子（注意为了简单，我们在此用 JavaScript 动画）：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postsList</span><span class="p">.</span><span class="nx">onRendered</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.wrapper'</span><span class="p">).</span><span class="nx">_uihooks</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">insertElement</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">fadeIn</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="na">moveElement</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//...
</span>    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">/client/templates/posts/post_list.js</div><div class="lines-highlight" data-lines="3~8" data-class="added"></div>
          
          <p>为了更好看到效果，我们通过控制台插入新帖子，来测试动画：</p>
          <pre class="highlight javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">'postInsert'</span><span class="p">,</span> <span class="p">{</span><span class="na">url</span><span class="p">:</span> <span class="s1">'http://apple.com'</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="s1">'Testing Animations'</span><span class="p">})</span></pre>
          <figure class="screenshot "><img src="DiscoverMeteor_files/14-4.xml" alt="渐入新帖子"><figcaption>渐入新帖子</figcaption></figure>
          
          <p>其次，我们动画淡出删除的帖子：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">postsList</span><span class="p">.</span><span class="nx">onRendered</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.wrapper'</span><span class="p">).</span><span class="nx">_uihooks</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">insertElement</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">fadeIn</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="na">moveElement</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//...
</span>    <span class="p">},</span>
    <span class="na">removeElement</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">/client/templates/posts/post_list.js</div><div class="lines-highlight" data-lines="12~16" data-class="added"></div>
          
          <p>再次，在控制台（用 <code>Posts.remove('somePostId')</code>）删除一个帖子来测试动画效果。</p>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/14-5.xml" alt="动画淡出删除的帖子"><figcaption>动画淡出删除的帖子</figcaption></figure>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 14-2</h4><p>Fade items in when they are drawn.</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter14-2" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter14-2.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <h3>页面过渡</h3>
          
          <p>到目前为止，我们已经在页面内动画了元素。但是如果我们想添加页面之间的过渡动画呢？</p>
          
          <p>页面过渡是 Iron Router 的任务。点击一个链接，<code>{{&gt; yield}}</code> helper 的内容自动地更换。</p>
          
          <p>就像我们为帖子列表改变 Blaze 默认行为一样，我们也可以为 <code>{{&gt; yield}}</code> 做同样的事情，在不同路由之间添加渐隐过渡动画效果！</p>
          
          <p>如果我们想渐入渐隐页面，我们必须要确保它们在各自上方显示。我们用添加了 <code>position:absolute</code> 属性的 <code>.page</code> container div 来包裹每个页面模板。</p>
          
          <p>但不能相对于窗口来绝对定位我们的页面，因为这样页面会覆盖应用的 header。所以我们给 <code>#main</code> div 添加 <code>position:relative</code> 以便 <code>.page</code> div 的 <code>position:absolute</code> 会得到其正确位置。</p>
          
          <p>为了节省时间，我们已经在 <code>sytle.css</code> 中添加了必要的 CSS 代码：</p>
          <pre class="highlight css"><span class="o">//...</span>

<span class="nf">#main</span><span class="p">{</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">relative</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.page</span><span class="p">{</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span>
  <span class="nl">top</span><span class="p">:</span> <span class="m">0px</span><span class="p">;</span>
  <span class="nl">width</span><span class="p">:</span> <span class="m">100</span><span class="err">%</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//...</span></pre>
          <div class="caption">/client/stylesheets/style.css</div>
          
          <p>是时候添加页面过渡代码了。代码看起来很熟悉，因为这和我们添加和删除帖子时的代码完全一致：</p>
          <pre class="highlight javascript"><span class="nx">Template</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">onRendered</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'#main'</span><span class="p">).</span><span class="nx">_uihooks</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">insertElement</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">fadeIn</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="na">removeElement</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></pre>
          <div class="caption">/client/templates/application/layout.js</div>
          
          <figure class="screenshot "><img src="DiscoverMeteor_files/14-6.xml" alt="页面之间的过渡动画"><figcaption>页面之间的过渡动画</figcaption></figure>
          
          <div class="commit"><img src="DiscoverMeteor_files/code.svg"><div class="message"><h4>提交 14-3</h4><p>页面间的渐隐过渡。</p></div><div class="actions"><a class="commit-link" href="https://github.com/DiscoverMeteor/Microscope/commit/chapter14-3" target="_blank">在 GitHub 中查看</a><a class="instance-link" href="http://meteor-book-chapter14-3.meteor.com/" target="_blank">查看演示</a></div></div>
          
          <p>我们刚刚看了一些为 Meteor 应用添加动画元素的模式。虽然这不是一个详尽的清单，但是希望这会提供一个基础，在其上去构建更复杂的过渡动画。</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="going-further">更进一步</h2>
            <span class="chapter-number">14.5</span>
          </div>
          <p>我们希望，之前的章节给了你一个良好的概述，如何构建一个 Meteor 应用。但是，现在你还要去哪里呢？</p>
          
          <h3>额外章节</h3>
          
          <p>首先，如果你还没有购买本书的话，你可以购买 <a href="https://gumroad.com/l/zIux">Full</a> 或 <a href="https://gumroad.com/l/OwKC">Premium</a> 版本来阅读本书额外的章节。这些章节将引导你深入真实场景，比如为你的应用建立 API，与第三方服务集成和迁移数据。</p>
          
          <h3>Meteor 手册</h3>
          
          <p>除了官方 <a href="http://docs.meteor.com/">documentation</a>，<a href="http://manual.meteor.com/">Meteor Manual</a> 挖掘更深度的特定主题，比如 Tracker 和 Blaze。</p>
          
          <h3>Evented Mind</h3>
          
          <p>如果你更深入研究 Meteor 的复杂性，我们也强烈建议 Chris Mather 的 <a href="https://www.eventedmind.com/">Evented Mind</a> 的视频学习平台，有超过 50 个独立的 Meteor 视频（每周都会增加新视频）。</p>
          
          <h3>MeteorHacks</h3>
          
          <p>跟上 Meteor 的最佳途径之一是订阅 Arunoda Susiripala 的 <a href="http://meteorhacks.com/">MeteorHacks</a> weekly newsletter。该 MeteorHacks 博客也是一个关于高级 Meteor 技巧的重要资源。</p>
          
          <h3>Atmosphere</h3>
          
          <p><a href="http://atmospherejs.com/">Atmosphere</a>，Meteor 的非官方代码包库，是学习更多 Meteor 的另一个伟大资源：你可以发现新的代码包，查看他人的代码，学习他人使用的模式。</p>
          
          <p>（免责声明：Atmosphere 由本书作者之一 Tom Coleman 维护的。）</p>
          
          <h3>Meteorpedia</h3>
          
          <p><a href="http://www.meteorpedia.com/">Meteorpedia</a> 是 Meteor 的维基百科。当然，它是用 Meteor 构建的！</p>
          
          <h3>BulletProof Meteor</h3>
          
          <p>另一个来自 MeteorHacks 的 Arunoda 的作品，<a href="https://bulletproofmeteor.com/">BulletProof Meteor</a> ，带领你通过一系列专注 Meteor 性能的课程，每一步通过问答形式来测试你的知识。</p>
          
          <h3>Meteor 播客</h3>
          
          <p>来自 Meteor shop <a href="http://differential.io/">Differential</a> 的 Josh 和 Ry 每周录制 <a href="http://www.meteorpodcast.com/">the Meteor Podcast</a>，这也是一个非常好的方式来跟上 Meteor 社区所发生的事情。</p>
          
          <h3>其他资源</h3>
          
          <p>Stephan Hochhaus 汇总了一个非常详尽的 <a href="http://yauh.de/articles/376/best-learning-resources-for-meteorjs">Meteor 资源</a>列表。</p>
          
          <p><a href="http://www.manuel-schoebel.com/blog/">Manuel Schoebel</a> 的博客也是一个不错的 Meteor 资源。<a href="http://journal.gentlenode.com/">Gentlenode 博客</a>也是同样。</p>
          
          <h3>获得帮助</h3>
          
          <p>如果你碰上一个绊脚石，求助的最好地方是 <a href="http://stackoverflow.com/">Stack Overflow</a>。确保你用 <code>meteor</code> 标签标记你的问题。</p>
          
          <h3>社区</h3>
          
          <p>最后，保持跟上 Meteor 更新的最好办法是要在社区中活跃。我们建议你加入 Meteor <a href="https://www.meteor.com/">邮件列表</a>，跟踪 <a href="https://groups.google.com/forum/#%E2%80%8B%E2%80%8B%21forum/meteor-core">Meteor Core</a> 和 <a href="https://groups.google.com/forum/#%E2%80%8B%E2%80%8B%21forum/meteor-talk">Meteor Talk</a> 谷歌论坛，并注册一个 Meteor 论坛 <a href="http://crater.io/">Crater.io</a> 的账号。</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="meteor-vocabulary">Meteor 术语表</h2>
            <span class="chapter-number">99</span>
          </div>
          <h4>客户端 Client</h4>
          
          <p>当我们谈论客户端时，我们指的是用户的<strong>网页浏览器</strong>，不论是传统的像 Firebox 或 Safari 的浏览器，或是像在 iPhone 原生应用中的 UIwebView 一样复杂的其他程序。</p>
          
          <h4>集合 Collection</h4>
          
          <p>Meteor 的集合是自动在客户与服务器之间同步的数据源。集合的名称（比如 <code>posts</code>）通常存在于客户端和服务器端。虽然它们表现不同，但是它们有共同的基于 Mongo 的 API。</p>
          
          <h4>Computation</h4>
          
          <p>Computation 就是每当响应数据源变化时而运行的代码块。如果你想让一个响应数据源去响应处理（比如，Session 变量），你需要为它来设置一个 computation。</p>
          
          <h4>Cursor</h4>
          
          <p>Cursor 是查询 Mongo 集合后的结果。在客户端，cursor 不仅仅是结果的数组，也是一个<em>响应的</em>对象，对应于相关集合的添加、删除和更新对象。</p>
          
          <h4>分布式数据协议 DDP</h4>
          
          <p>DDP 是 Meteor 的分布式数据协议，用来同步集合和调用方法。DDP 的目的是作为一个通用的协议，在大数据的实时应用中起 HTTP 的作用。</p>
          
          <h4>Tracker</h4>
          
          <p>Tracker 是 Meteor 响应性系统。Tracker 在后台使 HTML 自动保持与底层数据模型的同步。</p>
          
          <h4>文档 Document</h4>
          
          <p>Mongo 是基于文档（document）的数据库，多个文档组成集合。它们是纯 JavaScript 对象（虽然它们不能包含函数），只有一个 <code>_id</code> 属性，Meteor 用这个属性通过 DDP 跟踪这些对象的属性。</p>
          
          <h4>Helper</h4>
          
          <p>当模板需要渲染复杂的多于一个文档属性时，调用 helper 以函数方式来完成渲染任务。</p>
          
          <h4>延迟补偿 Latency Compensation</h4>
          
          <p>延迟补偿是一种在客户端模拟方法调用以避免等待服务器回应的一种技术。</p>
          
          <h4>Meteor Development Group (MDG)</h4>
          
          <p>Meteor 开发小组（MDG），开发 Meteor 的公司，区别于这个框架本身。</p>
          
          <h4>方法 Method</h4>
          
          <p>Meteor 方法是一个从客户端到服务器端的远程调用，以一些特别的逻辑保持跟踪集合的更改和允许延迟补偿。</p>
          
          <h4>MiniMongo</h4>
          
          <p>客户端的集合，是有类似 Mongo API 并存在内存的数据源。支持这种操作的库叫做“MiniMongo”，是在内存中运行的小版本的 Mongo。</p>
          
          <h4>代码包 Package</h4>
          
          <p>Meteor 代码包可以包含服务器端运行的、客户端运行的 JavaScript 代码，处理资源的说明（比如 SASS 至 CSS），处理的资源。<br>代码包就像一个超级库。Meteor 自带了很多核心代码包，同时在 <a href="http://atmosphere.meteor.com/">Atmosphere</a> 集合了社区提供的第三方代码包。</p>
          
          <h4>发布 Publication</h4>
          
          <p>一个发布就是一套为每个订阅用户而订制的数据。在服务器端设置发布。</p>
          
          <h4>服务器 Server</h4>
          
          <p>Meteor 服务器是运行在 Node.js 之上的 HTTP 和 DDP 服务器。它包含了所有的 Meteor 
库，同时也包含了你的服务器端的 JavaScript 代码。当 Meteor 服务器启动时，它会连接 Mongo 
数据库（在开发模式时，会自启动）。</p>
          
          <h4>会话 Session</h4>
          
          <p>在 Meteor 中，会话指的是客户端的响应数据源，用来跟踪用户所处的状态。</p>
          
          <h4>Subscription</h4>
          
          <p>订阅是为特定客户的发布的连接。订阅是运行在浏览器中的代码，与服务器的发布对话，并保持数据同步。</p>
          
          <h4>模板 Template</h4>
          
          <p>模板就是一个通过 JavaScript 生成 HTML 的方法。Meteor 默认支持 Spacebars 模板系统，但是将来也会支持其他系统。</p>
          
          <h4>模板数据上下文 Template Data Context</h4>
          
          <p>当模板渲染时，它指的是 JavaScript 对象为此次渲染提供特定的数据。通常来说，对象就是纯原始的 JavaScript 对象（POJO），经常也是集合的文档，但是它们也可以变得更复杂，可拥有函数。</p>
        </section>
        <section class="chapter post-content">
          <div class="chapter-heading">
            <h2 class="chapter-title" id="changelog">更新日志</h2>
            <span class="chapter-number">99</span>
          </div>
          <h3>2015年2月10日 <span class="marker version-marker">1.8</span></h3>
          
          <ul>
          <li>重写“动画”章节，使用 <code>_uihooks</code>。</li>
          <li>用 <code>.page</code> div 包裹每个页面。</li>
          <li>使用官方 <code>twbs:bootstrap</code> Bootstrap 包。</li>
          <li>添加 <code>.page</code> 到 <code>sytle.css</code>。</li>
          <li>使用 <code>Template.registerHelper</code> 替代 <code>UI.registerHelper</code>。</li>
          <li>“部署”章节，删除了 Modulus 部分（现在参考其官方文档）。</li>
          <li>“添加用户”章节，更新 <code>db.users.find()</code> 的结果。</li>
          <li>“集合”章节，添加了关于 Meteor shell 的内容。</li>
          <li>中文翻译版本于2015年2月25日更新完毕。</li>
          </ul>
          
          <h3>2014年12月5日 <span class="marker version-marker">1.7.2</span></h3>
          
          <ul>
          <li>“分页”章节，添加 <code>subscriptions</code> 段落。</li>
          <li>更正几处错别字和代码。</li>
          </ul>
          
          <h3>2014年11月10日 <span class="marker version-marker">1.7.1</span></h3>
          
          <p>.
          .
          .</p>
          
          <h3>2013年5月5日 <span class="marker version-marker">1.0</span></h3>
          
          <p>第一版。</p>
        </section>
      </div>
    </div>
  

</body></html>